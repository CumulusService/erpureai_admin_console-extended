@page "/test-invite"
@using AdminConsole.Models
@using AdminConsole.Services
@inject IGraphService GraphService
@inject IOrganizationService OrganizationService
@inject ISecurityGroupService SecurityGroupService
@inject ILogger<TestInvite> Logger

<h1>Test Admin Invitation</h1>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(isError ? "alert-danger" : "alert-success")">
        @message
    </div>
}

<div class="card">
    <div class="card-body">
        <h5>Create Organization & Invite Admin</h5>
        
        <div class="mb-3">
            <label>Admin Email:</label>
            <input @bind="adminEmail" class="form-control" placeholder="admin@company.com" />
        </div>
        
        <div class="mb-3">
            <label>Admin Name:</label>
            <input @bind="adminName" class="form-control" placeholder="John Admin" />
        </div>
        
        <div class="mb-3">
            <label>Organization Name:</label>
            <input @bind="orgName" class="form-control" placeholder="Test Company" />
        </div>
        
        <div class="mb-3">
            <label>Organization Domain:</label>
            <input @bind="orgDomain" class="form-control" placeholder="company.com" />
        </div>
        
        <button class="btn btn-primary" @onclick="TestInvitation" disabled="@isLoading">
            @if (isLoading)
            {
                <span>Working...</span>
            }
            else
            {
                <span>Send Invitation</span>
            }
        </button>
    </div>
</div>

@code {
    private string adminEmail = "test@example.com";
    private string adminName = "Test Admin";
    private string orgName = "Test Organization";
    private string orgDomain = "example.com";
    private string message = "";
    private bool isError = false;
    private bool isLoading = false;

    private async Task TestInvitation()
    {
        if (isLoading) return;
        
        isLoading = true;
        message = "";
        isError = false;
        
        try
        {
            Logger.LogInformation("Starting test invitation for {Email}", adminEmail);
            
            // Step 1: Create organization
            message = "Creating organization...";
            StateHasChanged();
            
            var organization = await OrganizationService.CreateOrganizationAsync(orgName, orgDomain, "temp-id");
            Logger.LogInformation("Created organization: {OrgId}", organization.OrganizationId);
            
            // Step 2: Create security group
            message = "Creating security group...";
            StateHasChanged();
            
            var groupId = await SecurityGroupService.CreateOrganizationSecurityGroupAsync(organization);
            Logger.LogInformation("Created security group: {GroupId}", groupId);
            
            // Step 3: Send invitation
            message = "Sending B2B invitation...";
            StateHasChanged();
            
            var invitedUser = await GraphService.InviteAdminUserAsync(adminEmail, adminName, orgName);
            Logger.LogInformation("Invited user: {UserId}", invitedUser?.Id);
            
            // Step 4: Add to group
            if (!string.IsNullOrEmpty(invitedUser?.Id) && !string.IsNullOrEmpty(groupId))
            {
                message = "Adding user to security group...";
                StateHasChanged();
                
                var addResult = await SecurityGroupService.AddUserToOrganizationGroupAsync(
                    invitedUser.Id, organization.OrganizationId.ToString());
                Logger.LogInformation("Added to group result: {Result}", addResult);
            }
            
            message = $"✅ SUCCESS! Invitation sent to {adminEmail}. Organization '{orgName}' created with security group.";
            isError = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Test invitation failed");
            message = $"❌ ERROR: {ex.Message}";
            isError = true;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}