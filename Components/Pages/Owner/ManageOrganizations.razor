@page "/owner/organizations"
@* Redirect to the new admin organization settings page *@
@using AdminConsole.Models
@using AdminConsole.Services
@inject NavigationManager Navigation
@inject IOrganizationService OrganizationService
@inject IGraphService GraphService
@inject IOnboardedUserService OnboardedUserService
@inject IUserAccessValidationService UserAccessValidationService
@inject ITeamsGroupService TeamsGroupService
@inject IAgentGroupAssignmentService AgentGroupAssignmentService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<ManageOrganizations> Logger
@inject INavigationOptimizationService NavigationOptimizer
@rendermode InteractiveServer

<PageTitle>Manage Organizations</PageTitle>

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-white">
            <i class="fas fa-building text-primary me-2"></i>
            Manage Organizations
        </h1>
        <a href="/owner/invite-admin" class="btn btn-primary btn-sm">
            <i class="fas fa-plus"></i> Add Organization
        </a>
    </div>

    <!-- Filter and Search -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h6 class="m-0 font-weight-bold text-primary">Organizations (@filteredOrganizations.Count())</h6>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="statusFilter" @bind:after="FilterOrganizations">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="sortBy" @bind:after="SortOrganizations">
                        <option value="Name">Sort by Name</option>
                        <option value="Created">Sort by Created Date</option>
                        <option value="Users">Sort by User Count</option>
                        <option value="Secrets">Sort by Secret Count</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" placeholder="Search organizations..." 
                               @bind="searchTerm" @oninput="FilterOrganizations" />
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Organizations Cards -->
    <div class="row">
        @if (filteredOrganizations.Any())
        {
            @foreach (var org in filteredOrganizations)
            {
                <div class="col-lg-6 col-xl-4 mb-4" @key="org.Id">
                    <div class="card shadow h-100 @(org.IsActive ? "" : "opacity-75")">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 font-weight-bold text-primary">
                                    <i class="fas fa-building me-1"></i>
                                    @org.Name
                                </h6>
                                <small class="text-muted">@org.Domain</small>
                            </div>
                            <div class="d-flex flex-column gap-1">
                                <button class="btn btn-sm btn-primary" @onclick="@(() => ViewOrganizationDetails(org))" @onmouseover="@(() => PreloadOrganizationDetailsOnHover(org.OrganizationId.ToString()))">
                                    <i class="fas fa-eye me-1"></i> Details
                                </button>
                                <button class="btn btn-sm btn-info" @onclick="@(() => ViewAdminsForOrg(org))">
                                    <i class="fas fa-user-shield me-1"></i> Admins
                                </button>
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => ViewOrganizationSettings(org))">
                                    <i class="fas fa-cog me-1"></i> Settings
                                </button>
                                <button class="btn btn-sm btn-success" @onclick="@(() => EditOrganization(org))">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </button>
                                <button class="btn btn-sm @(org.IsActive ? "btn-warning" : "btn-success")" @onclick="@(() => ToggleOrganizationStatus(org))">
                                    <i class="fas fa-@(org.IsActive ? "pause" : "play") me-1"></i> @(org.IsActive ? "Deactivate" : "Activate")
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Admin Info -->
                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="avatar-sm me-2">
                                        <div class="avatar-title bg-warning rounded-circle">
                                            @org.AdminUserName.FirstOrDefault()
                                        </div>
                                    </div>
                                    <div>
                                        <strong>@org.AdminUserName</strong>
                                        <br />
                                        <small class="text-muted">@org.AdminUserEmail</small>
                                    </div>
                                </div>
                                <span class="badge bg-warning">
                                    <i class="fas fa-user-shield me-1"></i> Admin
                                </span>
                            </div>

                            <!-- Stats -->
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <div class="border-end">
                                        <div class="h5 mb-0 text-info">@org.UserCount</div>
                                        <small class="text-muted">Users</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border-end">
                                        <div class="h5 mb-0 text-success">@org.SecretCount</div>
                                        <small class="text-muted">Secrets</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="h5 mb-0 text-@(org.IsActive ? "success" : "secondary")">
                                        <i class="fas fa-@(org.IsActive ? "check-circle" : "pause-circle")"></i>
                                    </div>
                                    <small class="text-muted">Status</small>
                                </div>
                            </div>

                            <!-- Status Badge -->
                            <div class="text-center">
                                <span class="badge bg-@(org.IsActive ? "success" : "secondary") px-3 py-2">
                                    @(org.IsActive ? "Active" : "Inactive")
                                </span>
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                Created: @org.CreatedDate.ToString("MMM dd, yyyy")
                            </small>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-building fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No organizations found</h5>
                    <p class="text-muted mb-4">
                        @if (string.IsNullOrEmpty(searchTerm) && string.IsNullOrEmpty(statusFilter))
                        {
                            <text>Start by inviting your first organization admin.</text>
                        }
                        else
                        {
                            <text>No organizations match your search criteria.</text>
                        }
                    </p>
                    @if (string.IsNullOrEmpty(searchTerm) && string.IsNullOrEmpty(statusFilter))
                    {
                        <a href="/owner/invite-admin" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add First Organization
                        </a>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Organization Details Modal -->
@if (selectedOrganization != null && showDetailsModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-building me-2"></i> 
                        @selectedOrganization.Name
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Organization Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Organization Name</label>
                                        <p class="form-control-plaintext">@selectedOrganization.Name</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Domain</label>
                                        <p class="form-control-plaintext">@selectedOrganization.Domain</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Organization ID</label>
                                        <p class="form-control-plaintext">
                                            <code>@selectedOrganization.Id</code>
                                        </p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Status</label>
                                        <p class="form-control-plaintext">
                                            <span class="badge bg-@(selectedOrganization.IsActive ? "success" : "secondary") px-3 py-2">
                                                @(selectedOrganization.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Created Date</label>
                                        <p class="form-control-plaintext">
                                            @selectedOrganization.CreatedDate.ToString("MMMM dd, yyyy 'at' hh:mm tt")
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Administrator Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="avatar-sm me-3">
                                            <div class="avatar-title bg-warning rounded-circle">
                                                @selectedOrganization.AdminUserName.FirstOrDefault()
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@selectedOrganization.AdminUserName</h6>
                                            <small class="text-muted">Organization Administrator</small>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Email</label>
                                        <p class="form-control-plaintext">@selectedOrganization.AdminUserEmail</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">User ID</label>
                                        <p class="form-control-plaintext">
                                            <code>@selectedOrganization.AdminUserId</code>
                                        </p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Role</label>
                                        <p class="form-control-plaintext">
                                            <span class="badge bg-warning">
                                                <i class="fas fa-user-shield me-1"></i> Organization Admin
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Organization Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="border-end">
                                                <div class="h3 mb-0 text-info">@selectedOrganization.UserCount</div>
                                                <small class="text-muted">Total Users</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border-end">
                                                <div class="h3 mb-0 text-success">@selectedOrganization.SecretCount</div>
                                                <small class="text-muted">Active Secrets</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border-end">
                                                <div class="h3 mb-0 text-warning">1</div>
                                                <small class="text-muted">Administrators</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="h3 mb-0 text-@(selectedOrganization.IsActive ? "success" : "secondary")">
                                                <i class="fas fa-@(selectedOrganization.IsActive ? "check-circle" : "pause-circle")"></i>
                                            </div>
                                            <small class="text-muted">Status</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" @onclick="() => ViewAdminsForOrg(selectedOrganization)">
                        <i class="fas fa-user-shield me-1"></i> View Admins
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="() => ViewOrganizationSettings(selectedOrganization)">
                        <i class="fas fa-cog me-1"></i> Settings
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Organization> allOrganizations = new();
    private List<Organization> filteredOrganizations = new();
    private string searchTerm = string.Empty;
    private string statusFilter = string.Empty;
    private string sortBy = "Name";

    // Modal states
    private bool showDetailsModal = false;
    private Organization? selectedOrganization;
    
    // Enhanced confirmation modal state
    private bool showConfirmationModal = false;
    private bool confirmationIsActivation = false;
    private int confirmationUserCount = 0;
    private bool isProcessingOrganization = false;
    private Organization? organizationBeingToggled = null;
    
    // Result modal state
    private bool showResultModal = false;
    private bool resultOverallSuccess = false;
    private bool resultIsActivation = false;
    private int resultTotalUsersProcessed = 0;
    private int resultSuccessCount = 0;
    private int resultFailureCount = 0;
    private List<UserOperationResult> resultSuccessfulOperations = new();
    private List<UserOperationResult> resultFailedOperations = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizations();
    }

    private async Task LoadOrganizations()
    {
        try
        {
            // Load organizations from database
            var orgsFromDb = await OrganizationService.GetAllOrganizationsAsync();
            allOrganizations = orgsFromDb.ToList();

            // Load guest users to get user counts and admin info
            var allGuestUsers = await GraphService.GetAllGuestUsersAsync();

            // Update organization info with real data
            foreach (var org in allOrganizations)
            {
                // Count users for this organization
                var orgUsers = allGuestUsers.Where(u => 
                    u.Email.EndsWith($"@{org.Domain}", StringComparison.OrdinalIgnoreCase) ||
                    u.OrganizationId == org.Id).ToList();
                
                org.UserCount = orgUsers.Count;
                
                // Find admin user
                var admin = orgUsers.FirstOrDefault(u => 
                    u.Role == UserRole.OrgAdmin || 
                    u.Email.EndsWith($"@{org.Domain}", StringComparison.OrdinalIgnoreCase));
                
                if (admin != null)
                {
                    org.AdminUserName = admin.DisplayName;
                    org.AdminUserEmail = admin.Email;
                    org.AdminUserId = admin.Id;
                }
                
                // For now, set secret count to 0 - would need KeyVault service integration
                org.SecretCount = 0;
            }

            filteredOrganizations = allOrganizations;
            SortOrganizations();
        }
        catch (Exception ex)
        {
            // Log error and show empty state
            Logger.LogError(ex, "Error loading organizations");
            allOrganizations = new List<Organization>();
            filteredOrganizations = new List<Organization>();
        }
    }

    private void FilterOrganizations()
    {
        filteredOrganizations = allOrganizations.Where(org =>
            (string.IsNullOrEmpty(searchTerm) || 
             org.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             org.Domain.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             org.AdminUserName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             org.AdminUserEmail.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(statusFilter) || 
             (statusFilter == "Active" && org.IsActive) || 
             (statusFilter == "Inactive" && !org.IsActive))
        ).ToList();

        SortOrganizations();
    }

    private void SortOrganizations()
    {
        filteredOrganizations = sortBy switch
        {
            "Name" => filteredOrganizations.OrderBy(o => o.Name).ToList(),
            "Created" => filteredOrganizations.OrderByDescending(o => o.CreatedDate).ToList(),
            "Users" => filteredOrganizations.OrderByDescending(o => o.UserCount).ToList(),
            "Secrets" => filteredOrganizations.OrderByDescending(o => o.SecretCount).ToList(),
            _ => filteredOrganizations.OrderBy(o => o.Name).ToList()
        };
    }

    private void ViewOrganizationDetails(Organization org)
    {
        selectedOrganization = org;
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        selectedOrganization = null;
        showDetailsModal = false;
    }

    private void ViewOrganizationUsers(string orgId)
    {
        // For now, navigate to organization details since user management is handled elsewhere
        Navigation.NavigateTo($"/owner/organizations/{orgId}");
    }
    
    // üöÄ Preload organization details on hover for faster navigation
    private async void PreloadOrganizationDetailsOnHover(string orgId)
    {
        try
        {
            _ = Task.Run(async () =>
            {
                await NavigationOptimizer.PreloadPageDataAsync($"/owner/organizations/{orgId}");
            });
        }
        catch
        {
            // Silently ignore preloading errors
        }
    }

    private void ViewOrganizationSecrets(string orgId)
    {
        // Navigate to admin secrets page filtered by organization
        Navigation.NavigateTo($"/admin/secrets?org={orgId}");
    }

    private void ViewOrganizationSettings(Organization org)
    {
        Navigation.NavigateTo($"/admin/organization-settings/{org.OrganizationId}");
    }
    
    private void EditOrganization(Organization org)
    {
        Navigation.NavigateTo($"/owner/organizations/{org.OrganizationId}/edit");
    }

    private async Task ToggleOrganizationStatus(Organization org)
    {
        try
        {
            organizationBeingToggled = org;
            var activate = !org.IsActive;
            
            // Get user count to show impact
            var organizationUsers = await OnboardedUserService.GetByOrganizationForSuperAdminAsync(org.OrganizationId);
            var totalUsersCount = organizationUsers.Count;
            
            // Show enhanced confirmation modal
            showConfirmationModal = true;
            confirmationIsActivation = activate;
            confirmationUserCount = totalUsersCount;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during organization status confirmation for {OrgId}", org.OrganizationId);
            StateHasChanged();
        }
    }
    
    private async Task OnConfirmOrganizationStatusChange()
    {
        showConfirmationModal = false;
        isProcessingOrganization = true;
        StateHasChanged();
        
        await ExecuteOrganizationStatusToggle(confirmationIsActivation);
        
        isProcessingOrganization = false;
        StateHasChanged();
    }
    
    private void OnCancelOrganizationStatusChange()
    {
        showConfirmationModal = false;
        organizationBeingToggled = null;
        StateHasChanged();
    }
    
    private void CloseResultModal()
    {
        showResultModal = false;
        StateHasChanged();
    }
    
    private async Task ExecuteOrganizationStatusToggle(bool activate)
    {
        if (organizationBeingToggled == null) return;

        try
        {
            var org = organizationBeingToggled;
            Logger.LogInformation("=== STARTING ORGANIZATION-WIDE {Action} for {OrgName} ({OrgId}) ===", 
                activate ? "ACTIVATION" : "DEACTIVATION", org.Name, org.OrganizationId);
            
            // CRITICAL SECURITY STEP 1: Handle all organization users in Azure AD and database
            var (successCount, failureCount, successful, failed) = await ProcessOrganizationUsersAccess(org.OrganizationId, activate);
            
            // STEP 2: Update organization status in database
            org.IsActive = activate;
            org.StateCode = activate ? StateCode.Active : StateCode.Inactive;
            org.StatusCode = activate ? StatusCode.Active : StatusCode.Inactive;
            org.ModifiedOn = DateTime.UtcNow;
            
            var orgSuccess = await OrganizationService.UpdateOrganizationAsync(org);
            if (orgSuccess)
            {
                Logger.LogInformation("=== ORGANIZATION {Action} COMPLETED for {OrgName} ===", 
                    activate ? "ACTIVATION" : "DEACTIVATION", org.Name);
                
                // Show detailed results modal
                resultOverallSuccess = failureCount == 0;
                resultIsActivation = activate;
                resultTotalUsersProcessed = successCount + failureCount;
                resultSuccessCount = successCount;
                resultFailureCount = failureCount;
                resultSuccessfulOperations = successful;
                resultFailedOperations = failed;
                showResultModal = true;
            }
            else
            {
                Logger.LogError("Organization database update failed for {OrgId} during {Action}", 
                    org.OrganizationId, activate ? "activation" : "deactivation");
                // Revert on failure
                org.IsActive = !activate;
                org.StateCode = !activate ? StateCode.Active : StateCode.Inactive;
                org.StatusCode = !activate ? StatusCode.Active : StatusCode.Inactive;
            }
            
            organizationBeingToggled = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling organization status for {OrgId}", organizationBeingToggled?.OrganizationId);
            if (organizationBeingToggled != null)
            {
                // Revert on error
                organizationBeingToggled.IsActive = !organizationBeingToggled.IsActive;
                organizationBeingToggled.StateCode = organizationBeingToggled.IsActive ? StateCode.Active : StateCode.Inactive;
            }
            organizationBeingToggled = null;
            StateHasChanged();
        }
    }

    /// <summary>
    /// CRITICAL SECURITY METHOD: Processes all organization users during org activation/deactivation
    /// This ensures ALL users are properly enabled/disabled in Azure AD AND database
    /// </summary>
    private async Task<(int successCount, int failureCount, List<UserOperationResult> successful, List<UserOperationResult> failed)> ProcessOrganizationUsersAccess(Guid organizationId, bool activate)
    {
        try
        {
            // Get all users in the organization
            var organizationUsers = await OnboardedUserService.GetByOrganizationForSuperAdminAsync(organizationId);
            Logger.LogInformation("Processing {UserCount} users for organization {Action}", 
                organizationUsers.Count, activate ? "activation" : "deactivation");

            var successCount = 0;
            var failureCount = 0;
            var successful = new List<UserOperationResult>();
            var failed = new List<UserOperationResult>();
            var currentUser = HttpContextAccessor.HttpContext?.User;
            var modifiedBy = currentUser?.FindFirst("email")?.Value ?? "system";

            // Process each user individually to ensure complete control
            foreach (var user in organizationUsers)
            {
                try
                {
                    Logger.LogInformation("Processing user {Email} (ID: {UserId}) for {Action}", 
                        user.Email, user.OnboardedUserId, activate ? "activation" : "deactivation");

                    if (activate)
                    {
                        // REACTIVATION: Enable user in Azure AD and restore database access
                        var azureObjectId = user.AzureObjectId ?? await OnboardedUserService.GetAzureObjectIdByEmailAsync(user.Email, organizationId);
                        var azureSuccess = true; // Default to true if no Azure ObjectId (e.g., for invited but not yet signed-in users)
                        
                        if (!string.IsNullOrEmpty(azureObjectId))
                        {
                            // Enable Azure AD account
                            azureSuccess = await GraphService.EnableUserAccountAsync(azureObjectId);
                            if (azureSuccess)
                            {
                                Logger.LogInformation("‚úÖ Azure AD account enabled for {Email}", user.Email);
                            }
                            else
                            {
                                Logger.LogWarning("‚ùå Failed to enable Azure AD account for {Email}", user.Email);
                            }
                        }

                        // Restore database access
                        var dbSuccess = await UserAccessValidationService.RestoreUserAccessAsync(user.Email, modifiedBy);
                        
                        // ENHANCED: Restore Teams group membership
                        bool teamsGroupSuccess = true;
                        try
                        {
                            if (!string.IsNullOrEmpty(azureObjectId))
                            {
                                Logger.LogInformation("Restoring Teams group membership for user {Email}", user.Email);
                                teamsGroupSuccess = await TeamsGroupService.AddUserToOrganizationTeamsGroupAsync(azureObjectId, organizationId);
                                if (teamsGroupSuccess)
                                {
                                    Logger.LogInformation("‚úÖ Successfully restored Teams group membership for {Email}", user.Email);
                                }
                                else
                                {
                                    Logger.LogWarning("‚ùå Failed to restore Teams group membership for {Email}", user.Email);
                                }
                            }
                        }
                        catch (Exception teamsEx)
                        {
                            Logger.LogError(teamsEx, "‚ùå Exception restoring Teams group for {Email}", user.Email);
                            teamsGroupSuccess = false;
                        }

                        // ENHANCED: Restore agent type security group memberships
                        bool agentGroupSuccess = true;
                        try
                        {
                            if (!string.IsNullOrEmpty(azureObjectId) && user.AgentTypeIds?.Any() == true)
                            {
                                Logger.LogInformation("Restoring agent security group memberships for user {Email} with {Count} agent types", 
                                    user.Email, user.AgentTypeIds.Count);
                                agentGroupSuccess = await AgentGroupAssignmentService.SyncUserAgentGroupAssignmentsAsync(azureObjectId, organizationId);
                                if (agentGroupSuccess)
                                {
                                    Logger.LogInformation("‚úÖ Successfully restored agent security group memberships for {Email}", user.Email);
                                }
                                else
                                {
                                    Logger.LogWarning("‚ùå Failed to restore some agent security group memberships for {Email}", user.Email);
                                }
                            }
                            else
                            {
                                Logger.LogInformation("‚ÑπÔ∏è User {Email} has no agent types or Azure Object ID - skipping agent group restoration", user.Email);
                            }
                        }
                        catch (Exception agentEx)
                        {
                            Logger.LogError(agentEx, "‚ùå Exception restoring agent security groups for {Email}", user.Email);
                            agentGroupSuccess = false;
                        }
                        
                        // Track individual result with detailed group success tracking
                        var result = new UserOperationResult
                        {
                            UserEmail = user.Email,
                            AzureSuccess = !string.IsNullOrEmpty(azureObjectId) && azureSuccess,
                            DatabaseSuccess = dbSuccess,
                            GroupsSuccess = teamsGroupSuccess && agentGroupSuccess
                        };
                        
                        // Consider operation successful if critical components succeed (database + Azure AD account)
                        // Group management failures are logged but don't fail the entire operation
                        var criticalSuccess = dbSuccess && (!string.IsNullOrEmpty(azureObjectId) ? azureSuccess : true);
                        
                        if (criticalSuccess)
                        {
                            successCount++;
                            successful.Add(result);
                            if (result.GroupsSuccess)
                            {
                                Logger.LogInformation("‚úÖ Full access restored for {Email} (including all group memberships)", user.Email);
                            }
                            else
                            {
                                Logger.LogWarning("‚ö†Ô∏è Partial access restored for {Email} - database and Azure AD account restored, but some group memberships may have failed", user.Email);
                            }
                        }
                        else
                        {
                            failureCount++;
                            result.ErrorMessage = $"Database restore: {(dbSuccess ? "OK" : "Failed")}, Azure AD: {(string.IsNullOrEmpty(azureObjectId) ? "No Object ID" : azureSuccess ? "OK" : "Failed")}, Groups: {(result.GroupsSuccess ? "OK" : "Partial")}";
                            failed.Add(result);
                            Logger.LogError("‚ùå Failed to restore access for {Email}", user.Email);
                        }
                    }
                    else
                    {
                        // DEACTIVATION: Disable user in Azure AD and revoke database access
                        var azureObjectId = user.AzureObjectId ?? await OnboardedUserService.GetAzureObjectIdByEmailAsync(user.Email, organizationId);
                        var azureSuccess = true; // Default to true if no Azure ObjectId (e.g., for invited but not yet signed-in users)
                        
                        if (!string.IsNullOrEmpty(azureObjectId))
                        {
                            // CRITICAL: Disable Azure AD account (not just remove from groups)
                            azureSuccess = await GraphService.DisableUserAccountAsync(azureObjectId);
                            if (azureSuccess)
                            {
                                Logger.LogInformation("‚úÖ Azure AD account DISABLED for {Email}", user.Email);
                            }
                            else
                            {
                                Logger.LogWarning("‚ùå Failed to disable Azure AD account for {Email}", user.Email);
                                
                                // Fallback: Try comprehensive revocation if disable fails
                                var fallbackSuccess = await GraphService.RevokeUserAccessAsync(azureObjectId);
                                azureSuccess = fallbackSuccess;
                                Logger.LogInformation(fallbackSuccess ? 
                                    "‚úÖ Fallback revocation succeeded for {Email}" : 
                                    "‚ùå Fallback revocation failed for {Email}", user.Email);
                            }
                        }

                        // ENHANCED: Remove from Teams group
                        bool teamsGroupSuccess = true;
                        try
                        {
                            if (!string.IsNullOrEmpty(azureObjectId))
                            {
                                Logger.LogInformation("Removing user from Teams group for {Email}", user.Email);
                                teamsGroupSuccess = await TeamsGroupService.RemoveUserFromOrganizationTeamsGroupAsync(azureObjectId, organizationId);
                                if (teamsGroupSuccess)
                                {
                                    Logger.LogInformation("‚úÖ Successfully removed user from Teams group for {Email}", user.Email);
                                }
                                else
                                {
                                    Logger.LogWarning("‚ùå Failed to remove user from Teams group for {Email} (group may not exist)", user.Email);
                                    // Don't fail the entire operation if Teams group doesn't exist
                                    teamsGroupSuccess = true;
                                }
                            }
                        }
                        catch (Exception teamsEx)
                        {
                            Logger.LogError(teamsEx, "‚ùå Exception removing user from Teams group for {Email}", user.Email);
                            // Don't fail the entire operation for Teams group issues
                            teamsGroupSuccess = true;
                        }

                        // ENHANCED: Deactivate agent type security group memberships
                        bool agentGroupSuccess = true;
                        try
                        {
                            if (!string.IsNullOrEmpty(azureObjectId))
                            {
                                Logger.LogInformation("Deactivating agent security group memberships for user {Email}", user.Email);
                                agentGroupSuccess = await AgentGroupAssignmentService.DeactivateUserAgentGroupAssignmentsAsync(azureObjectId, organizationId);
                                if (agentGroupSuccess)
                                {
                                    Logger.LogInformation("‚úÖ Successfully deactivated agent security group memberships for {Email}", user.Email);
                                }
                                else
                                {
                                    Logger.LogWarning("‚ùå Failed to deactivate some agent security group memberships for {Email}", user.Email);
                                }
                            }
                        }
                        catch (Exception agentEx)
                        {
                            Logger.LogError(agentEx, "‚ùå Exception deactivating agent security groups for {Email}", user.Email);
                            agentGroupSuccess = false;
                        }

                        // Revoke database access
                        var dbSuccess = await UserAccessValidationService.RevokeUserAccessAsync(user.Email, modifiedBy);
                        
                        // Track individual result with detailed group success tracking
                        var result = new UserOperationResult
                        {
                            UserEmail = user.Email,
                            AzureSuccess = !string.IsNullOrEmpty(azureObjectId) && azureSuccess,
                            DatabaseSuccess = dbSuccess,
                            GroupsSuccess = teamsGroupSuccess && agentGroupSuccess
                        };
                        
                        // Consider operation successful if critical components succeed (database + Azure AD account)
                        // Group management failures are logged but don't fail the entire operation
                        var criticalSuccess = dbSuccess && (!string.IsNullOrEmpty(azureObjectId) ? azureSuccess : true);
                        
                        if (criticalSuccess)
                        {
                            successCount++;
                            successful.Add(result);
                            if (result.GroupsSuccess)
                            {
                                Logger.LogInformation("‚úÖ Full access revoked for {Email} (including all group memberships)", user.Email);
                            }
                            else
                            {
                                Logger.LogWarning("‚ö†Ô∏è Partial access revoked for {Email} - database and Azure AD account disabled, but some group removals may have failed", user.Email);
                            }
                        }
                        else
                        {
                            failureCount++;
                            result.ErrorMessage = $"Database revoke: {(dbSuccess ? "OK" : "Failed")}, Azure AD: {(string.IsNullOrEmpty(azureObjectId) ? "No Object ID" : azureSuccess ? "OK" : "Failed")}, Groups: {(result.GroupsSuccess ? "OK" : "Partial")}";
                            failed.Add(result);
                            Logger.LogError("‚ùå Failed to revoke access for {Email}", user.Email);
                        }
                    }
                }
                catch (Exception userEx)
                {
                    failureCount++;
                    var result = new UserOperationResult
                    {
                        UserEmail = user.Email,
                        AzureSuccess = false,
                        DatabaseSuccess = false,
                        GroupsSuccess = false,
                        ErrorMessage = $"Exception: {userEx.Message}"
                    };
                    failed.Add(result);
                    Logger.LogError(userEx, "‚ùå Exception processing user {Email} during organization {Action}", 
                        user.Email, activate ? "activation" : "deactivation");
                }
            }

            Logger.LogInformation("Organization user processing complete: {SuccessCount} succeeded, {FailureCount} failed", 
                successCount, failureCount);

            if (failureCount > 0)
            {
                Logger.LogWarning("‚ö†Ô∏è {FailureCount} users failed during organization {Action}. Manual verification recommended.", 
                    failureCount, activate ? "activation" : "deactivation");
            }
            
            return (successCount, failureCount, successful, failed);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå CRITICAL ERROR during organization user processing for {Action}", 
                activate ? "activation" : "deactivation");
            throw; // Re-throw to stop organization update if user processing fails
        }
    }
    
    private void ViewAdminsForOrg(Organization org)
    {
        Navigation.NavigateTo($"/owner/admins?org={org.Domain}");
    }
}

@* Enhanced Organization Status Confirmation Modal *@
@if (showConfirmationModal)
{
    <OrganizationStatusConfirmationModal 
        OrganizationName="@(organizationBeingToggled?.Name ?? "")"
        UserCount="@confirmationUserCount"
        IsActivation="@confirmationIsActivation"
        IsProcessing="@isProcessingOrganization"
        OnConfirm="@OnConfirmOrganizationStatusChange"
        OnCancel="@OnCancelOrganizationStatusChange" />
}

@* Organization Status Results Modal *@
@if (showResultModal)
{
    <OrganizationStatusResultModal 
        OrganizationName="@(organizationBeingToggled?.Name ?? "")"
        IsActivation="@resultIsActivation"
        OverallSuccess="@resultOverallSuccess"
        TotalUsersProcessed="@resultTotalUsersProcessed"
        SuccessCount="@resultSuccessCount"
        FailureCount="@resultFailureCount"
        SuccessfulOperations="@resultSuccessfulOperations"
        FailedOperations="@resultFailedOperations"
        OnClose="@CloseResultModal" />
}

