@page "/owner/organizations/{OrganizationId:guid}/edit"
@using AdminConsole.Models
@using AdminConsole.Services
@using System.ComponentModel.DataAnnotations
@inject IOrganizationService OrganizationService
@inject IDataIsolationService DataIsolationService
@inject IAgentTypeService AgentTypeService
@inject IAgentGroupAssignmentService AgentGroupAssignmentService
@inject IOnboardedUserService OnboardedUserService
@inject IDatabaseCredentialService DatabaseCredentialService
@inject IModalService ModalService
@inject IGraphService GraphService
@inject NavigationManager Navigation
@inject ILogger<EditOrganization> Logger
@attribute [Authorize(Policy = "SuperAdminOnly")]
@rendermode InteractiveServer

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="/owner/organizations" class="text-decoration-none">Organizations</a></li>
                            <li class="breadcrumb-item active">@(organization?.Name ?? "Edit Organization")</li>
                        </ol>
                    </nav>
                    <h2 class="mb-1">Edit Organization</h2>
                    <p class="text-muted mb-0">
                        @if (organization != null)
                        {
                            <span class="badge @(organization.StateCode == StateCode.Active ? "bg-success" : "bg-secondary") me-2">
                                @(organization.StateCode == StateCode.Active ? "Active" : "Inactive")
                            </span>
                            <span class="text-muted">@organization.AdminEmail</span>
                        }
                    </p>
                </div>
                <div>
                    <button type="button" class="btn btn-outline-info me-2" @onclick="RefreshOrganization" disabled="@isRefreshing">
                        @if (isRefreshing)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        else
                        {
                            <i class="fas fa-sync-alt me-1"></i>
                        }
                        Refresh
                    </button>
                    <button type="button" class="btn btn-outline-secondary me-2" @onclick="CancelEdit">
                        <i class="fas fa-times me-1"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="SaveChanges" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        else
                        {
                            <i class="fas fa-save me-1"></i>
                        }
                        Save Changes
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error:</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Success:</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading organization details...</p>
                </div>
            }
            else if (organization == null)
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-building-slash fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Organization Not Found</h5>
                        <p class="text-muted mb-3">
                            The requested organization could not be found or you don't have permission to edit it.
                        </p>
                        <a href="/owner/organizations" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Back to Organizations
                        </a>
                    </div>
                </div>
            }
            else
            {
                <EditForm Model="@editModel">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="alert alert-danger" />

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-building me-2"></i>
                                        Organization Information
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="organizationName" class="form-label">Organization Name *</label>
                                                <InputText id="organizationName" @bind-Value="editModel.Name" class="form-control" 
                                                         placeholder="Enter organization name" />
                                                <ValidationMessage For="@(() => editModel.Name)" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="adminEmail" class="form-label">Admin Email *</label>
                                                <InputText id="adminEmail" @bind-Value="editModel.AdminEmail" class="form-control" 
                                                         placeholder="admin@domain.com" />
                                                <ValidationMessage For="@(() => editModel.AdminEmail)" />
                                                <div class="form-text">Primary administrator's email address</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Primary Database Type</label>
                                                @if (isLoadingDatabaseInfo)
                                                {
                                                    <div class="d-flex align-items-center">
                                                        <div class="spinner-border spinner-border-sm me-2" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <small class="text-muted">Detecting database type...</small>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge @GetDatabaseTypeBadgeClass() fs-6 px-3 py-2">
                                                            <i class="fas @GetDatabaseTypeIcon() me-2"></i>
                                                            @GetDatabaseTypeDisplay()
                                                        </span>
                                                        <small class="text-muted ms-2">
                                                            <i class="fas fa-sync-alt me-1"></i>
                                                            Synced from active database connections
                                                        </small>
                                                    </div>
                                                    @if (activeDatabaseConnections.Any())
                                                    {
                                                        <div class="form-text text-muted mt-2">
                                                            <strong>Active connections:</strong>
                                                            @string.Join(", ", activeDatabaseConnections.Take(3).Select(c => $"{c.FriendlyName} ({c.DatabaseType})"))
                                                            @if (activeDatabaseConnections.Count > 3)
                                                            {
                                                                <span> and @(activeDatabaseConnections.Count - 3) more</span>
                                                            }
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="form-text text-warning mt-2">
                                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                                            No active database connections configured. The organization admin should configure database credentials.
                                                        </div>
                                                    }
                                                }
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Organization Status</label>
                                                <div class="d-flex align-items-center gap-3">
                                                    <span class="badge @(editModel.StateCode == StateCode.Active ? "bg-success" : "bg-secondary") fs-6 px-3 py-2">
                                                        <i class="fas @(editModel.StateCode == StateCode.Active ? "fa-check-circle" : "fa-pause-circle") me-1"></i>
                                                        @(editModel.StateCode == StateCode.Active ? "Active" : "Inactive")
                                                    </span>
                                                    @if (editModel.StateCode == StateCode.Active)
                                                    {
                                                        <button type="button" class="btn btn-outline-warning btn-sm" @onclick="() => ConfirmStatusChange(false)">
                                                            <i class="fas fa-pause me-1"></i>
                                                            Deactivate
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <button type="button" class="btn btn-outline-success btn-sm" @onclick="() => ConfirmStatusChange(true)">
                                                            <i class="fas fa-play me-1"></i>
                                                            Activate
                                                        </button>
                                                    }
                                                </div>
                                                <div class="form-text text-warning">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    Status changes affect all organization users immediately
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Key Vault Configuration section removed as requested -->

                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-users-cog me-2"></i>
                                        Agent Type Configuration
                                        <small class="text-muted ms-2">(Organization Level)</small>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info border-0 mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <small>
                                            Configure which agent types are available for this organization. Changes will automatically sync with Azure AD security groups for all users.
                                        </small>
                                    </div>
                                    
                                    @if (isLoadingAgentTypes)
                                    {
                                        <div class="d-flex justify-content-center p-4">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading agent types...</span>
                                            </div>
                                            <span class="ms-2">Loading agent types...</span>
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(agentTypeErrorMessage))
                                    {
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            @agentTypeErrorMessage
                                        </div>
                                    }
                                    else if (availableAgentTypes?.Any() == true)
                                    {
                                        <div class="row">
                                            @foreach (var agentType in availableAgentTypes)
                                            {
                                                <div class="col-12 mb-2">
                                                    <div class="form-check p-3 border rounded @(selectedAgentTypeIds.Contains(agentType.Id) ? "border-primary bg-primary bg-opacity-10" : "border-secondary")">
                                                        <input class="form-check-input" 
                                                               type="checkbox" 
                                                               id="orgAgent_@agentType.Id" 
                                                               checked="@selectedAgentTypeIds.Contains(agentType.Id)"
                                                               @onchange="@((ChangeEventArgs e) => ToggleOrganizationAgentType(agentType.Id, (bool)e.Value!))" />
                                                        <label class="form-check-label w-100" for="orgAgent_@agentType.Id">
                                                            <div class="d-flex align-items-center">
                                                                <div class="flex-grow-1">
                                                                    <strong class="text-dark">@agentType.Name</strong>
                                                                    @if (!string.IsNullOrEmpty(agentType.Description))
                                                                    {
                                                                        <br><small class="text-secondary">@GetShortDescription(agentType.Description)</small>
                                                                    }
                                                                    @if (!string.IsNullOrEmpty(agentType.GlobalSecurityGroupId))
                                                                    {
                                                                        <br><small class="badge bg-success mt-1">
                                                                            <i class="fas fa-shield-alt me-1"></i>
                                                                            Azure AD Security Group
                                                                        </small>
                                                                    }
                                                                </div>
                                                                @if (selectedAgentTypeIds.Contains(agentType.Id))
                                                                {
                                                                    <div class="ms-3">
                                                                        <small class="badge bg-success">
                                                                            <i class="fas fa-check me-1"></i>
                                                                            Active
                                                                        </small>
                                                                    </div>
                                                                }
                                                            </div>
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        @if (!string.IsNullOrEmpty(agentTypeValidationMessage))
                                        {
                                            <div class="alert alert-warning mt-3">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                @agentTypeValidationMessage
                                            </div>
                                        }

                                        @if (hasAgentTypeChanges)
                                        {
                                            <div class="mt-3 p-3 bg-warning bg-opacity-10 border border-warning rounded">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div>
                                                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                                        <strong>Pending Changes:</strong>
                                                        <span class="ms-2">Agent type configuration changes will apply to all organization users.</span>
                                                    </div>
                                                    <button type="button" class="btn btn-warning btn-sm" @onclick="SaveAgentTypeChanges" disabled="@isSavingAgentTypes">
                                                        @if (isSavingAgentTypes)
                                                        {
                                                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                                        }
                                                        else
                                                        {
                                                            <i class="fas fa-sync me-1"></i>
                                                        }
                                                        Apply Changes
                                                    </button>
                                                </div>
                                            </div>
                                        }

                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                <strong>Note:</strong> Changes to agent type configuration will automatically update Azure AD security group memberships for all users in this organization.
                                            </small>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            No agent types are currently available for configuration.
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-cogs me-2"></i>
                                        SAP Configuration
                                        <small class="text-muted ms-2">(Configured by Organization Admin)</small>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info border-0 mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <small>
                                            This configuration is managed by the Organization Admin through their settings page.
                                            Values shown here are read-only and reflect what the admin has entered.
                                        </small>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label"><strong>SAP Service Layer Hostname:</strong></label>
                                                <div class="form-control bg-light">
                                                    @(string.IsNullOrEmpty(organization.SAPServiceLayerHostname) ? 
                                                        "Not configured" : organization.SAPServiceLayerHostname)
                                                </div>
                                                <div class="form-text">Service Layer endpoint for SAP API integration</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label"><strong>SAP API Gateway Hostname:</strong></label>
                                                <div class="form-control bg-light">
                                                    @(string.IsNullOrEmpty(organization.SAPAPIGatewayHostname) ? 
                                                        "Not configured" : organization.SAPAPIGatewayHostname)
                                                </div>
                                                <div class="form-text">API Gateway endpoint for SAP services</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label"><strong>SAP Business One Web Client Host:</strong></label>
                                                <div class="form-control bg-light">
                                                    @(string.IsNullOrEmpty(organization.SAPBusinessOneWebClientHost) ? 
                                                        "Not configured" : organization.SAPBusinessOneWebClientHost)
                                                </div>
                                                <div class="form-text">Web client host for browser-based SAP access</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label"><strong>Document Code:</strong></label>
                                                <div class="form-control bg-light">
                                                    @(string.IsNullOrEmpty(organization.DocumentCode) ? 
                                                        "Not configured" : organization.DocumentCode)
                                                </div>
                                                <div class="form-text">Default document code prefix</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    @if (string.IsNullOrEmpty(organization.SAPServiceLayerHostname) && 
                                         string.IsNullOrEmpty(organization.SAPAPIGatewayHostname) && 
                                         string.IsNullOrEmpty(organization.SAPBusinessOneWebClientHost) && 
                                         string.IsNullOrEmpty(organization.DocumentCode))
                                    {
                                        <div class="alert alert-warning border-0 mt-3">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>No SAP Configuration:</strong> The organization admin has not yet configured SAP integration settings.
                                            They can configure these settings by logging into their account and accessing Organization Settings.
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-success border-0 mt-3">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <small>
                                                <strong>Configuration Status:</strong> SAP settings have been configured by the organization admin.
                                                Last modified: @organization.ModifiedOn.ToString("MMM dd, yyyy 'at' h:mm tt")
                                            </small>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Organization Summary
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Organization ID</label>
                                        <p class="font-monospace small">@organization.OrganizationId</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Domain</label>
                                        <p class="fw-bold">@ExtractDomainFromEmail(editModel.AdminEmail)</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Current Status</label>
                                        <p>
                                            <span class="badge @(editModel.StateCode == StateCode.Active ? "bg-success" : "bg-secondary") fs-6">
                                                @(editModel.StateCode == StateCode.Active ? "Active" : "Inactive")
                                            </span>
                                        </p>
                                    </div>
                                    <!-- Key Vault information removed from sidebar as requested -->
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-history me-2"></i>
                                        Audit Information
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Created On</label>
                                        <p class="fw-bold">@organization.CreatedOn.ToString("MMM dd, yyyy 'at' h:mm tt")</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Last Modified</label>
                                        <p class="fw-bold">@organization.ModifiedOn.ToString("MMM dd, yyyy 'at' h:mm tt")</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Total Users</label>
                                        <p class="fw-bold text-info">@organization.Users.Count</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid OrganizationId { get; set; }
    
    private Organization? organization;
    private OrganizationEditModel editModel = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isRefreshing = false;

    // Agent Type Management
    private List<AgentTypeEntity> availableAgentTypes = new();
    private HashSet<Guid> selectedAgentTypeIds = new();
    private HashSet<Guid> originalAgentTypeIds = new();
    private bool isLoadingAgentTypes = true;
    private bool isSavingAgentTypes = false;
    private string agentTypeErrorMessage = string.Empty;
    private string agentTypeValidationMessage = string.Empty;
    private bool hasAgentTypeChanges => !selectedAgentTypeIds.SetEquals(originalAgentTypeIds);

    // Database Type Detection
    private List<DatabaseCredential> activeDatabaseConnections = new();
    private bool isLoadingDatabaseInfo = true;
    private OrganizationDatabaseType detectedDatabaseType = OrganizationDatabaseType.SQL;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadOrganization();
            await LoadAgentTypes();
            await LoadDatabaseConnections();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing organization edit page for organization {OrganizationId}", OrganizationId);
            errorMessage = "Error loading page. Please refresh and try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadOrganization()
    {
        try
        {
            Logger.LogInformation("LoadOrganization: Requesting fresh organization data for ID: {OrganizationId}", OrganizationId);
            
            // Force a fresh database query - no caching
            organization = null; // Clear any existing reference
            organization = await OrganizationService.GetByIdAsync(OrganizationId.ToString());
            
            if (organization != null)
            {
                Logger.LogInformation("LoadOrganization: Retrieved organization '{Name}' with SAP Config: ServiceLayer='{ServiceLayer}', APIGateway='{APIGateway}', WebClient='{WebClient}', DocumentCode='{DocumentCode}', ModifiedOn='{ModifiedOn}'", 
                    organization.Name,
                    organization.SAPServiceLayerHostname ?? "(empty)", 
                    organization.SAPAPIGatewayHostname ?? "(empty)",
                    organization.SAPBusinessOneWebClientHost ?? "(empty)",
                    organization.DocumentCode ?? "(empty)",
                    organization.ModifiedOn);

                // Map organization to edit model
                editModel = new OrganizationEditModel
                {
                    OrganizationId = organization.OrganizationId,
                    Name = organization.Name,
                    AdminEmail = organization.AdminEmail,
                    DatabaseType = organization.DatabaseType,
                    StateCode = organization.StateCode
                    // Key Vault fields removed from UI
                    // SAP Configuration fields removed - displayed as read-only
                };
            }
            else
            {
                Logger.LogWarning("LoadOrganization: No organization found for ID: {OrganizationId}", OrganizationId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading organization {OrganizationId}", OrganizationId);
            errorMessage = "Error loading organization details. Please try again.";
        }
    }

    private async Task ConfirmStatusChange(bool activate)
    {
        var action = activate ? "activate" : "deactivate";
        var actionCaps = activate ? "Activate" : "Deactivate";
        
        string impactWarning;
        if (activate)
        {
            impactWarning = $"This will <strong>restore access</strong> for organization '{organization?.Name}'.<br><br>" +
                          $"<strong>Impact:</strong><br>" +
                          $"‚Ä¢ All organization users will regain system access<br>" +
                          $"‚Ä¢ Organization resources will become available<br>" +
                          $"‚Ä¢ Integrations and services will resume<br><br>" +
                          $"Are you sure you want to proceed?";
        }
        else
        {
            impactWarning = $"<strong>‚ö†Ô∏è CRITICAL WARNING:</strong><br><br>" +
                          $"This will <strong>immediately lock out ALL users</strong> in organization '{organization?.Name}'!<br><br>" +
                          $"<strong>Immediate Impact:</strong><br>" +
                          $"‚Ä¢ All active users will lose access instantly<br>" +
                          $"‚Ä¢ Organization integrations will be disabled<br>" +
                          $"‚Ä¢ Users cannot access any system resources<br>" +
                          $"‚Ä¢ This requires Super Admin intervention to reverse<br><br>" +
                          $"<strong>Are you absolutely certain you want to proceed?</strong>";
        }
        
        var confirmed = activate 
            ? await ModalService.ShowWarningAsync(
                $"{actionCaps} Organization",
                impactWarning,
                $"{actionCaps} Organization",
                "Cancel")
            : await ModalService.ShowDangerAsync(
                $"‚ö†Ô∏è {actionCaps} Organization",
                impactWarning,
                $"Yes, {actionCaps} Organization",
                "Cancel - Keep Active");
        
        if (confirmed)
        {
            editModel.StateCode = activate ? StateCode.Active : StateCode.Inactive;
            await SaveChanges();
        }
    }

    private async Task SaveChanges()
    {
        if (organization == null) return;

        // Validate the form before proceeding
        var validationContext = new System.ComponentModel.DataAnnotations.ValidationContext(editModel);
        var validationResults = new List<System.ComponentModel.DataAnnotations.ValidationResult>();
        
        if (!System.ComponentModel.DataAnnotations.Validator.TryValidateObject(editModel, validationContext, validationResults, true))
        {
            // Show specific validation errors instead of generic message
            var specificErrors = validationResults
                .Where(vr => vr != null && !string.IsNullOrEmpty(vr.ErrorMessage))
                .Select(vr => vr.ErrorMessage)
                .ToList();
            
            if (specificErrors.Any())
            {
                errorMessage = "Validation errors:<br>‚Ä¢ " + string.Join("<br>‚Ä¢ ", specificErrors);
            }
            else
            {
                errorMessage = "Please fix the validation errors before saving.";
            }
            StateHasChanged();
            return;
        }

        try
        {
            ClearMessages();
            isSaving = true;

            // Update organization with edit model values
            organization.Name = editModel.Name;
            organization.AdminEmail = editModel.AdminEmail;
            // DatabaseType is read-only - determined from actual database configuration
            organization.StateCode = editModel.StateCode;
            organization.StatusCode = editModel.StateCode == StateCode.Active ? StatusCode.Active : StatusCode.Inactive;
            // Key Vault fields removed from UI - backend handles these automatically
            // SAP Configuration is read-only - managed by Organization Admin through their settings
            organization.ModifiedOn = DateTime.UtcNow;

            var success = await OrganizationService.UpdateOrganizationAsync(organization);
            
            if (success)
            {
                successMessage = $"Organization '{organization.Name}' has been updated successfully.";
                
                // Sync legacy properties for display
                organization.SyncLegacyProperties();
            }
            else
            {
                errorMessage = "Failed to update organization. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating organization {OrganizationId}", OrganizationId);
            errorMessage = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task RefreshOrganization()
    {
        if (isRefreshing) return;

        isRefreshing = true;
        ClearMessages();

        try
        {
            Logger.LogInformation("=== REFRESH ORGANIZATION DEBUG ===");
            Logger.LogInformation("Route Parameter OrganizationId: {OrganizationId}", OrganizationId);
            Logger.LogInformation("Current Organization in memory: {CurrentOrgId} - {CurrentOrgName}", 
                organization?.OrganizationId, organization?.Name);

            // Reload all organization data with fresh database call
            var previousSAPHostname = organization?.SAPServiceLayerHostname;
            var previousSAPGateway = organization?.SAPAPIGatewayHostname;
            
            await LoadOrganization();
            
            // Log what we got from the database
            Logger.LogInformation("After LoadOrganization:");
            Logger.LogInformation("  - Organization Name: {Name}", organization?.Name);
            Logger.LogInformation("  - SAP Service Layer: {SAPServiceLayer}", organization?.SAPServiceLayerHostname);
            Logger.LogInformation("  - SAP API Gateway: {SAPAPIGateway}", organization?.SAPAPIGatewayHostname);
            Logger.LogInformation("  - SAP Web Client: {SAPWebClient}", organization?.SAPBusinessOneWebClientHost);
            Logger.LogInformation("  - Document Code: {DocumentCode}", organization?.DocumentCode);
            Logger.LogInformation("  - Modified On: {ModifiedOn}", organization?.ModifiedOn);

            if (previousSAPHostname != organization?.SAPServiceLayerHostname || 
                previousSAPGateway != organization?.SAPAPIGatewayHostname)
            {
                Logger.LogInformation("SAP Configuration HAS CHANGED!");
            }
            else
            {
                Logger.LogInformation("SAP Configuration unchanged from previous values");
            }

            await LoadAgentTypes();
            await LoadDatabaseConnections();

            successMessage = $"Organization data refreshed successfully at {DateTime.Now:HH:mm:ss}";
            Logger.LogInformation("Successfully refreshed organization data for {OrganizationId}", OrganizationId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing organization data for {OrganizationId}", OrganizationId);
            errorMessage = "Failed to refresh organization data. Please try again.";
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();
        }
    }

    private void CancelEdit()
    {
        Navigation.NavigateTo("/owner/organizations");
    }

    private void ClearMessages()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    private string ExtractDomainFromEmail(string email)
    {
        if (string.IsNullOrEmpty(email)) return string.Empty;
        var atIndex = email.IndexOf('@');
        return atIndex > 0 ? email.Substring(atIndex + 1) : string.Empty;
    }

    #region Agent Type Management

    private async Task LoadAgentTypes()
    {
        isLoadingAgentTypes = true;
        agentTypeErrorMessage = string.Empty;

        try
        {
            // Load available agent types
            availableAgentTypes = await AgentTypeService.GetActiveAgentTypesAsync();

            // Load current organization agent type configuration
            // For now, we'll get the agent types from organization users
            // In the future, this could be a direct organization property
            await LoadOrganizationAgentTypeConfiguration();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading agent types for organization {OrganizationId}", OrganizationId);
            agentTypeErrorMessage = $"Failed to load agent types: {ex.Message}";
        }
        finally
        {
            isLoadingAgentTypes = false;
        }
    }

    private Task LoadOrganizationAgentTypeConfiguration()
    {
        try
        {
            if (organization == null) return Task.CompletedTask;

            // ‚úÖ CORRECT: Load organization-level agent type allocation from organization record (SOURCE-OF-TRUTH)
            var orgAgentTypeIds = organization.GetOrganizationAgentTypeIds();
            
            selectedAgentTypeIds = new HashSet<Guid>(orgAgentTypeIds);
            originalAgentTypeIds = new HashSet<Guid>(orgAgentTypeIds);

            Logger.LogInformation("‚úÖ ORGANIZATION-LEVEL: Loaded agent types allocated to organization {OrganizationName}: {AgentTypeIds}", 
                organization.Name, string.Join(", ", orgAgentTypeIds));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading organization agent type configuration for {OrganizationId}", OrganizationId);
            agentTypeErrorMessage = "Failed to load organization agent type configuration.";
        }
        return Task.CompletedTask;
    }

    private void ToggleOrganizationAgentType(Guid agentTypeId, bool isSelected)
    {
        agentTypeValidationMessage = string.Empty;

        if (isSelected)
        {
            selectedAgentTypeIds.Add(agentTypeId);
        }
        else
        {
            selectedAgentTypeIds.Remove(agentTypeId);
        }

        // Validate selection - at least one agent type must be selected
        if (selectedAgentTypeIds.Count == 0)
        {
            agentTypeValidationMessage = "At least one agent type must be selected to maintain system access for organization users.";
        }

        StateHasChanged();
    }

    private async Task SaveAgentTypeChanges()
    {
        if (!hasAgentTypeChanges || organization == null) return;

        // Validate selection
        if (selectedAgentTypeIds.Count == 0)
        {
            agentTypeValidationMessage = "At least one agent type must be selected.";
            return;
        }

        isSavingAgentTypes = true;
        agentTypeErrorMessage = string.Empty;
        agentTypeValidationMessage = string.Empty;

        try
        {
            Logger.LogInformation("üéØ ORGANIZATION-LEVEL AGENT TYPE MANAGEMENT: Starting for organization {OrganizationId}", OrganizationId);

            // Determine what changed (ASSIGN vs UNASSIGN)
            var agentTypesToAdd = selectedAgentTypeIds.Except(originalAgentTypeIds).ToList();
            var agentTypesToRemove = originalAgentTypeIds.Except(selectedAgentTypeIds).ToList();
            
            Logger.LogInformation("üîÑ Agent types to ADD to organization: {AgentTypesToAdd}", string.Join(", ", agentTypesToAdd));
            Logger.LogInformation("üîÑ Agent types to REMOVE from organization: {AgentTypesToRemove}", string.Join(", ", agentTypesToRemove));

            var operationMessages = new List<string>();

            // PHASE 1: ASSIGN agent types to organization (NO user updates)
            if (agentTypesToAdd.Any())
            {
                Logger.LogInformation("‚úÖ ASSIGN: Adding {Count} agent types to organization - NO users automatically assigned", agentTypesToAdd.Count);
                
                var addedAgentNames = new List<string>();
                foreach (var agentTypeId in agentTypesToAdd)
                {
                    var agentType = availableAgentTypes.FirstOrDefault(at => at.Id == agentTypeId);
                    if (agentType != null)
                        addedAgentNames.Add(agentType.Name);
                }
                
                operationMessages.Add($"‚úÖ {agentTypesToAdd.Count} agent types allocated to organization: {string.Join(", ", addedAgentNames)}");
                operationMessages.Add("üìã OrgAdmin can now assign these agents to users in their profile");
            }

            // PHASE 2: UNASSIGN agent types from organization + remove ALL users
            if (agentTypesToRemove.Any())
            {
                Logger.LogInformation("üîÑ UNASSIGN: Removing {Count} agent types from organization + removing ALL users from these agents", agentTypesToRemove.Count);
                
                var removeResults = new List<string>();
                var removeSuccessCount = 0;

                foreach (var agentTypeId in agentTypesToRemove)
                {
                    try
                    {
                        var agentType = availableAgentTypes.FirstOrDefault(at => at.Id == agentTypeId);
                        var agentName = agentType?.Name ?? agentTypeId.ToString();
                        
                        Logger.LogInformation("üîÑ Removing all users from agent type: {AgentName}", agentName);
                        
                        // Remove ALL users in organization from this agent type
                        var removeSuccess = await AgentGroupAssignmentService.RemoveAllUsersFromAgentTypeAsync(
                            organization.OrganizationId, agentTypeId, "SuperAdmin-OrgLevel");
                        
                        if (removeSuccess)
                        {
                            removeResults.Add($"‚úÖ {agentName}: All users removed");
                            removeSuccessCount++;
                        }
                        else
                        {
                            removeResults.Add($"‚ö†Ô∏è {agentName}: Some users may need manual removal");
                        }
                    }
                    catch (Exception agentEx)
                    {
                        Logger.LogError(agentEx, "‚ùå Error removing users from agent type {AgentTypeId}", agentTypeId);
                        removeResults.Add($"‚ùå Agent type {agentTypeId}: Removal failed");
                    }
                }

                if (removeSuccessCount == agentTypesToRemove.Count)
                {
                    operationMessages.Add($"‚úÖ {agentTypesToRemove.Count} agent types removed from organization and all users unassigned");
                }
                else
                {
                    operationMessages.Add($"‚ö†Ô∏è {removeSuccessCount}/{agentTypesToRemove.Count} agent types successfully removed - check logs for details");
                }
                
                operationMessages.AddRange(removeResults);
            }

            // PHASE 3: Update organization record with new agent type allocation
            Logger.LogInformation("üîÑ Updating organization record with new agent type allocation");
            var updateSuccess = await OrganizationService.UpdateOrganizationAgentTypesAsync(
                OrganizationId.ToString(), selectedAgentTypeIds.ToList());

            if (updateSuccess)
            {
                // Update the original configuration to reflect the changes
                originalAgentTypeIds = new HashSet<Guid>(selectedAgentTypeIds);

                // üöÄ PHASE 4: Install/Uninstall Teams Apps for agent type changes
                await ProcessTeamsAppChangesAsync(agentTypesToAdd, agentTypesToRemove, operationMessages);
                
                successMessage = string.Join("<br>", operationMessages);
                Logger.LogInformation("‚úÖ Organization-level agent type allocation completed successfully for {OrganizationId}", OrganizationId);
            }
            else
            {
                agentTypeErrorMessage = "Failed to update organization agent type allocation. Please try again.";
                Logger.LogError("‚ùå Failed to update organization record for {OrganizationId}", OrganizationId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå CRITICAL ERROR: Organization-level agent type management failed for {OrganizationId}", OrganizationId);
            agentTypeErrorMessage = $"Critical error during agent type management: {ex.Message}";
        }
        finally
        {
            Logger.LogInformation("SaveAgentTypeChanges: Operation completed - setting isSavingAgentTypes = false");
            isSavingAgentTypes = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Processes Teams app installation/uninstallation when agent types are assigned/unassigned to organization
    /// </summary>
    /// <param name="agentTypesToAdd">Agent types being assigned to organization</param>
    /// <param name="agentTypesToRemove">Agent types being unassigned from organization</param>
    /// <param name="operationMessages">List to append operation results to</param>
    private async Task ProcessTeamsAppChangesAsync(List<Guid> agentTypesToAdd, List<Guid> agentTypesToRemove, List<string> operationMessages)
    {
        try
        {
            // Skip if organization has no Teams group
            if (string.IsNullOrEmpty(organization?.M365GroupId))
            {
                Logger.LogWarning("‚ö†Ô∏è Organization {OrgName} has no M365GroupId - skipping Teams app operations", organization?.Name);
                operationMessages.Add("‚ö†Ô∏è No Microsoft Teams group configured - Teams app installation skipped");
                return;
            }

            Logger.LogInformation("üöÄ Processing Teams app changes for organization {OrgName} (M365GroupId: {GroupId})", 
                organization.Name, organization.M365GroupId);

            var teamsAppOperations = new List<string>();

            // STEP 1: Install Teams apps for newly assigned agent types
            if (agentTypesToAdd.Any())
            {
                Logger.LogInformation("üì± Installing Teams apps for {Count} newly assigned agent types", agentTypesToAdd.Count);

                foreach (var agentTypeId in agentTypesToAdd)
                {
                    try
                    {
                        var agentType = availableAgentTypes.FirstOrDefault(at => at.Id == agentTypeId);
                        if (agentType == null)
                        {
                            Logger.LogWarning("‚ö†Ô∏è Agent type {AgentTypeId} not found in available agent types", agentTypeId);
                            continue;
                        }

                        if (string.IsNullOrEmpty(agentType.TeamsAppId))
                        {
                            Logger.LogInformation("‚ÑπÔ∏è Agent type {AgentTypeName} has no Teams App ID configured - skipping installation", agentType.Name);
                            continue;
                        }

                        Logger.LogInformation("üì± Installing Teams app {TeamsAppId} for agent type {AgentTypeName}", 
                            agentType.TeamsAppId, agentType.Name);

                        var installSuccess = await GraphService.InstallTeamsAppAsync(organization.M365GroupId, agentType.TeamsAppId);

                        if (installSuccess)
                        {
                            teamsAppOperations.Add($"‚úÖ Installed Teams app for {agentType.Name}");
                            Logger.LogInformation("‚úÖ Successfully installed Teams app {TeamsAppId} for agent type {AgentTypeName}", 
                                agentType.TeamsAppId, agentType.Name);
                        }
                        else
                        {
                            teamsAppOperations.Add($"‚ö†Ô∏è Failed to install Teams app for {agentType.Name}");
                            Logger.LogError("‚ùå Failed to install Teams app {TeamsAppId} for agent type {AgentTypeName}", 
                                agentType.TeamsAppId, agentType.Name);
                        }
                    }
                    catch (Exception agentEx)
                    {
                        Logger.LogError(agentEx, "‚ùå Error installing Teams app for agent type {AgentTypeId}", agentTypeId);
                        var agentTypeName = availableAgentTypes.FirstOrDefault(at => at.Id == agentTypeId)?.Name ?? agentTypeId.ToString();
                        teamsAppOperations.Add($"‚ùå Error installing Teams app for {agentTypeName}");
                    }
                }
            }

            // STEP 2: Uninstall Teams apps for removed agent types
            if (agentTypesToRemove.Any())
            {
                Logger.LogInformation("üóëÔ∏è Uninstalling Teams apps for {Count} removed agent types", agentTypesToRemove.Count);

                foreach (var agentTypeId in agentTypesToRemove)
                {
                    try
                    {
                        var agentType = availableAgentTypes.FirstOrDefault(at => at.Id == agentTypeId);
                        if (agentType == null)
                        {
                            Logger.LogWarning("‚ö†Ô∏è Agent type {AgentTypeId} not found in available agent types", agentTypeId);
                            continue;
                        }

                        if (string.IsNullOrEmpty(agentType.TeamsAppId))
                        {
                            Logger.LogInformation("‚ÑπÔ∏è Agent type {AgentTypeName} has no Teams App ID configured - skipping uninstallation", agentType.Name);
                            continue;
                        }

                        Logger.LogInformation("üóëÔ∏è Uninstalling Teams app {TeamsAppId} for agent type {AgentTypeName}", 
                            agentType.TeamsAppId, agentType.Name);

                        var uninstallSuccess = await GraphService.UninstallTeamsAppAsync(organization.M365GroupId, agentType.TeamsAppId);

                        if (uninstallSuccess)
                        {
                            teamsAppOperations.Add($"‚úÖ Uninstalled Teams app for {agentType.Name}");
                            Logger.LogInformation("‚úÖ Successfully uninstalled Teams app {TeamsAppId} for agent type {AgentTypeName}", 
                                agentType.TeamsAppId, agentType.Name);
                        }
                        else
                        {
                            teamsAppOperations.Add($"‚ö†Ô∏è Failed to uninstall Teams app for {agentType.Name}");
                            Logger.LogError("‚ùå Failed to uninstall Teams app {TeamsAppId} for agent type {AgentTypeName}", 
                                agentType.TeamsAppId, agentType.Name);
                        }
                    }
                    catch (Exception agentEx)
                    {
                        Logger.LogError(agentEx, "‚ùå Error uninstalling Teams app for agent type {AgentTypeId}", agentTypeId);
                        var agentTypeName = availableAgentTypes.FirstOrDefault(at => at.Id == agentTypeId)?.Name ?? agentTypeId.ToString();
                        teamsAppOperations.Add($"‚ùå Error uninstalling Teams app for {agentTypeName}");
                    }
                }
            }

            // Add Teams app operation results to main operation messages
            if (teamsAppOperations.Any())
            {
                operationMessages.Add("üì± Teams App Operations:");
                operationMessages.AddRange(teamsAppOperations.Select(op => $"    {op}"));
            }

            Logger.LogInformation("üèÅ Completed Teams app processing for organization {OrgName}", organization.Name);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "üí• Critical error during Teams app processing for organization {OrganizationId}", OrganizationId);
            operationMessages.Add($"‚ùå Teams app operations failed: {ex.Message}");
        }
    }

    private string GetShortDescription(string description)
    {
        if (string.IsNullOrEmpty(description))
            return string.Empty;
            
        const int maxLength = 60;
        if (description.Length <= maxLength)
            return description;
            
        return description.Substring(0, maxLength) + "...";
    }

    #endregion

    #region Database Type Detection

    private async Task LoadDatabaseConnections()
    {
        isLoadingDatabaseInfo = true;

        try
        {
            if (organization == null) return;

            // Load active database connections for the organization
            activeDatabaseConnections = await DatabaseCredentialService.GetByOrganizationAsync(organization.OrganizationId);
            activeDatabaseConnections = activeDatabaseConnections.Where(c => c.IsActive).ToList();

            // Determine primary database type from active connections
            DetectPrimaryDatabaseType();

            Logger.LogInformation("Loaded {Count} active database connections for organization {OrganizationId}", 
                activeDatabaseConnections.Count, organization.OrganizationId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading database connections for organization {OrganizationId}", OrganizationId);
            // Don't show error to user - this is supplementary information
            activeDatabaseConnections = new List<DatabaseCredential>();
        }
        finally
        {
            isLoadingDatabaseInfo = false;
        }
    }

    private void DetectPrimaryDatabaseType()
    {
        if (!activeDatabaseConnections.Any())
        {
            detectedDatabaseType = OrganizationDatabaseType.SQL; // Default fallback
            return;
        }

        // Count database types
        var databaseTypeCounts = activeDatabaseConnections
            .GroupBy(c => c.DatabaseType)
            .ToDictionary(g => g.Key, g => g.Count());

        // Prioritize HANA if any exists, otherwise use the most common type
        if (databaseTypeCounts.ContainsKey(DatabaseType.HANA))
        {
            detectedDatabaseType = OrganizationDatabaseType.HANA;
        }
        else if (databaseTypeCounts.ContainsKey(DatabaseType.MSSQL))
        {
            detectedDatabaseType = OrganizationDatabaseType.SQL;
        }
        else
        {
            detectedDatabaseType = OrganizationDatabaseType.SQL; // Default fallback
        }

        Logger.LogDebug("Detected primary database type: {DatabaseType} from {Connections} connections", 
            detectedDatabaseType, activeDatabaseConnections.Count);
    }

    private string GetDatabaseTypeBadgeClass()
    {
        return detectedDatabaseType == OrganizationDatabaseType.HANA ? "bg-info" : "bg-primary";
    }

    private string GetDatabaseTypeIcon()
    {
        return detectedDatabaseType == OrganizationDatabaseType.HANA ? "fa-database" : "fa-server";
    }

    private string GetDatabaseTypeDisplay()
    {
        if (!activeDatabaseConnections.Any())
        {
            return "No Database Configured";
        }

        return detectedDatabaseType == OrganizationDatabaseType.HANA ? "SAP HANA" : "SQL Server";
    }

    #endregion

    /// <summary>
    /// Edit model for organization form binding
    /// </summary>
    public class OrganizationEditModel
    {
        public Guid OrganizationId { get; set; }
        
        [Required(ErrorMessage = "Organization name is required")]
        [StringLength(100, ErrorMessage = "Organization name cannot exceed 100 characters")]
        public string Name { get; set; } = string.Empty;
        
        [Required(ErrorMessage = "Admin email is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string AdminEmail { get; set; } = string.Empty;
        
        public OrganizationDatabaseType DatabaseType { get; set; } = OrganizationDatabaseType.SQL;
        public StateCode StateCode { get; set; } = StateCode.Active;
        
        // Key Vault properties removed from UI
        // SAP Configuration properties removed - displayed as read-only from Organization Admin's settings
    }
}