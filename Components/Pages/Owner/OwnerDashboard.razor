@page "/owner/dashboard"
@using AdminConsole.Models
@using AdminConsole.Services
@inject IOrganizationService OrganizationService
@inject IGraphService GraphService
@inject IOnboardedUserService OnboardedUserService
@inject IUserAccessValidationService UserAccessValidationService
@inject ITeamsGroupService TeamsGroupService
@inject IAgentGroupAssignmentService AgentGroupAssignmentService
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<OwnerDashboard> Logger
@rendermode InteractiveServer

<PageTitle>Super Admin Dashboard</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-0 text-white">
                <i class="fas fa-crown text-warning me-2"></i>
                Super Admin Dashboard
            </h1>
            <p class="text-muted">Global management across all organizations</p>
        </div>
    </div>

    <!-- Global Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Organizations</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@organizations.Count</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-building fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Admins</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@adminUsers.Count</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-shield fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Users</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@allUsers.Count</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Secrets</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@organizations.Sum(o => o.SecretCount)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-key fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/owner/invite-admin" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Invite New Organization Admin
                        </a>
                        <a href="/admin/organization-settings" class="btn btn-success">
                            <i class="fas fa-building"></i> Organization Settings
                        </a>
                        <a href="/owner/admins" class="btn btn-info">
                            <i class="fas fa-user-shield"></i> View All Admins
                        </a>
                        <a href="/owner/reports" class="btn btn-warning">
                            <i class="fas fa-chart-bar"></i> View Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Organizations</h6>
                </div>
                <div class="card-body">
                    @if (organizations.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var org in organizations.OrderByDescending(o => o.CreatedDate).Take(5))
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>@org.Name</strong>
                                        <br />
                                        <small class="text-muted">@org.Domain</small>
                                        <br />
                                        <small class="text-muted">Admin: @org.AdminUserName (@org.AdminUserEmail)</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="mb-1">
                                            <span class="badge bg-@(org.IsActive ? "success" : "secondary")">
                                                @(org.IsActive ? "Active" : "Inactive")
                                            </span>
                                        </div>
                                        <small class="text-muted">
                                            @org.UserCount users | @org.SecretCount secrets
                                        </small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No organizations found.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Organizations Overview -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Organizations Overview</h6>
                </div>
                <div class="card-body">
                    @if (organizations.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Organization</th>
                                        <th>Admin</th>
                                        <th>Users</th>
                                        <th>Secrets</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var org in organizations.OrderBy(o => o.Name))
                                    {
                                        <tr>
                                            <td>
                                                <div>
                                                    <strong>@org.Name</strong>
                                                    <br />
                                                    <small class="text-muted">@org.Domain</small>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong>@org.AdminUserName</strong>
                                                    <br />
                                                    <small class="text-muted">@org.AdminUserEmail</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">@org.UserCount users</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">@org.SecretCount secrets</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-@(org.IsActive ? "success" : "secondary")">
                                                    @(org.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    @org.CreatedDate.ToString("MMM dd, yyyy")
                                                </small>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-outline-primary" @onclick="() => ViewOrganization(org.Id)">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary" @onclick="() => EditOrganization(org.Id)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" @onclick="() => ToggleOrganizationStatus(org)">
                                                        <i class="fas fa-@(org.IsActive ? "pause" : "play")"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-building fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No organizations found</h5>
                            <p class="text-muted mb-4">Start by inviting your first organization admin.</p>
                            <a href="/owner/invite-admin" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Invite First Admin
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Organization> organizations = new();
    private List<GuestUser> adminUsers = new();
    private List<GuestUser> allUsers = new();
    
    // Enhanced confirmation modal state
    private bool showConfirmationModal = false;
    private bool confirmationIsActivation = false;
    private int confirmationUserCount = 0;
    private bool isProcessingOrganization = false;
    private Organization? organizationBeingToggled = null;
    
    // Result modal state
    private bool showResultModal = false;
    private bool resultOverallSuccess = false;
    private bool resultIsActivation = false;
    private int resultTotalUsersProcessed = 0;
    private int resultSuccessCount = 0;
    private int resultFailureCount = 0;
    private List<UserOperationResult> resultSuccessfulOperations = new();
    private List<UserOperationResult> resultFailedOperations = new();
    
    @inject NavigationManager Navigation

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            // Load organizations from database
            var orgsFromDb = await OrganizationService.GetAllOrganizationsAsync();
            organizations = orgsFromDb.ToList();

            // Load all guest users from Azure AD
            allUsers = (await GraphService.GetAllGuestUsersAsync()).ToList();
            
            // Filter admin users (those with OrgAdmin role or email matching organization domains)
            adminUsers = allUsers.Where(u => 
                u.Role == UserRole.OrgAdmin || 
                organizations.Any(o => u.Email.EndsWith($"@{o.Domain}"))
            ).ToList();

            // Update organization user counts and admin info from real data
            foreach (var org in organizations)
            {
                var orgUsers = allUsers.Where(u => u.OrganizationId == org.Id || 
                    u.Email.EndsWith($"@{org.Domain}")).ToList();
                
                org.UserCount = orgUsers.Count;
                
                // Find admin for this organization
                var admin = adminUsers.FirstOrDefault(a => 
                    a.OrganizationId == org.Id || 
                    a.Email.EndsWith($"@{org.Domain}"));
                
                if (admin != null)
                {
                    org.AdminUserName = admin.DisplayName;
                    org.AdminUserEmail = admin.Email;
                    org.AdminUserId = admin.Id;
                }
            }
        }
        catch (Exception ex)
        {
            // Log error but don't crash - show empty state
            Logger.LogError(ex, "Error loading dashboard data");
            organizations = new List<Organization>();
            adminUsers = new List<GuestUser>();
            allUsers = new List<GuestUser>();
        }
    }

    private void ViewOrganization(string orgId)
    {
        Navigation.NavigateTo($"/owner/organizations/{orgId}");
    }

    private void EditOrganization(string orgId)
    {
        Navigation.NavigateTo($"/owner/organizations/{orgId}/edit");
    }

    private async Task ToggleOrganizationStatus(Organization org)
    {
        try
        {
            organizationBeingToggled = org;
            var activate = !org.IsActive;
            
            // Get user count to show impact
            var organizationUsers = await OnboardedUserService.GetByOrganizationForSuperAdminAsync(org.OrganizationId);
            var totalUsersCount = organizationUsers.Count;
            
            // Show enhanced confirmation modal
            showConfirmationModal = true;
            confirmationIsActivation = activate;
            confirmationUserCount = totalUsersCount;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during organization status confirmation for {OrgId}", org.OrganizationId);
            StateHasChanged();
        }
    }
    
    private async Task OnConfirmOrganizationStatusChange()
    {
        showConfirmationModal = false;
        isProcessingOrganization = true;
        StateHasChanged();
        
        await ExecuteOrganizationStatusToggle(confirmationIsActivation);
        
        isProcessingOrganization = false;
        StateHasChanged();
    }
    
    private void OnCancelOrganizationStatusChange()
    {
        showConfirmationModal = false;
        organizationBeingToggled = null;
        StateHasChanged();
    }
    
    private void CloseResultModal()
    {
        showResultModal = false;
        StateHasChanged();
    }
    
    private async Task ExecuteOrganizationStatusToggle(bool activate)
    {
        if (organizationBeingToggled == null) return;

        try
        {
            var org = organizationBeingToggled;
            Logger.LogInformation("=== STARTING ORGANIZATION-WIDE {Action} for {OrgName} ({OrgId}) ===", 
                activate ? "ACTIVATION" : "DEACTIVATION", org.Name, org.OrganizationId);
            
            // CRITICAL SECURITY STEP 1: Handle all organization users in Azure AD and database
            var (successCount, failureCount, successful, failed) = await ProcessOrganizationUsersAccess(org.OrganizationId, activate);
            
            // STEP 2: Update organization status in database
            org.IsActive = activate;
            org.StateCode = activate ? StateCode.Active : StateCode.Inactive;
            org.StatusCode = activate ? StatusCode.Active : StatusCode.Inactive;
            org.ModifiedOn = DateTime.UtcNow;
            
            var orgSuccess = await OrganizationService.UpdateOrganizationAsync(org);
            if (orgSuccess)
            {
                Logger.LogInformation("=== ORGANIZATION {Action} COMPLETED for {OrgName} ===", 
                    activate ? "ACTIVATION" : "DEACTIVATION", org.Name);
                
                // Show detailed results modal
                resultOverallSuccess = failureCount == 0;
                resultIsActivation = activate;
                resultTotalUsersProcessed = successCount + failureCount;
                resultSuccessCount = successCount;
                resultFailureCount = failureCount;
                resultSuccessfulOperations = successful;
                resultFailedOperations = failed;
                showResultModal = true;
            }
            else
            {
                Logger.LogError("Organization database update failed for {OrgId} during {Action}", 
                    org.OrganizationId, activate ? "activation" : "deactivation");
                // Revert on failure
                org.IsActive = !activate;
                org.StateCode = !activate ? StateCode.Active : StateCode.Inactive;
                org.StatusCode = !activate ? StatusCode.Active : StatusCode.Inactive;
            }
            
            organizationBeingToggled = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling organization status for {OrgId}", organizationBeingToggled?.OrganizationId);
            if (organizationBeingToggled != null)
            {
                // Revert on error
                organizationBeingToggled.IsActive = !organizationBeingToggled.IsActive;
                organizationBeingToggled.StateCode = organizationBeingToggled.IsActive ? StateCode.Active : StateCode.Inactive;
            }
            organizationBeingToggled = null;
            StateHasChanged();
        }
    }

    /// <summary>
    /// CRITICAL SECURITY METHOD: Processes all organization users during org activation/deactivation
    /// This ensures ALL users are properly enabled/disabled in Azure AD AND database
    /// </summary>
    private async Task<(int successCount, int failureCount, List<UserOperationResult> successful, List<UserOperationResult> failed)> ProcessOrganizationUsersAccess(Guid organizationId, bool activate)
    {
        try
        {
            // Get all users in the organization
            var organizationUsers = await OnboardedUserService.GetByOrganizationForSuperAdminAsync(organizationId);
            Logger.LogInformation("Processing {UserCount} users for organization {Action}", 
                organizationUsers.Count, activate ? "activation" : "deactivation");

            var successCount = 0;
            var failureCount = 0;
            var successful = new List<UserOperationResult>();
            var failed = new List<UserOperationResult>();
            var currentUser = HttpContextAccessor.HttpContext?.User;
            var modifiedBy = currentUser?.FindFirst("email")?.Value ?? "system";

            // Process each user individually to ensure complete control
            foreach (var user in organizationUsers)
            {
                try
                {
                    Logger.LogInformation("Processing user {Email} (ID: {UserId}) for {Action}", 
                        user.Email, user.OnboardedUserId, activate ? "activation" : "deactivation");

                    if (activate)
                    {
                        // REACTIVATION: Enable user in Azure AD and restore database access
                        var azureObjectId = user.AzureObjectId ?? await OnboardedUserService.GetAzureObjectIdByEmailAsync(user.Email, organizationId);
                        var azureSuccess = true; // Default to true if no Azure ObjectId (e.g., for invited but not yet signed-in users)
                        
                        if (!string.IsNullOrEmpty(azureObjectId))
                        {
                            // Enable Azure AD account
                            azureSuccess = await GraphService.EnableUserAccountAsync(azureObjectId);
                            if (azureSuccess)
                            {
                                Logger.LogInformation("✅ Azure AD account enabled for {Email}", user.Email);
                            }
                            else
                            {
                                Logger.LogWarning("❌ Failed to enable Azure AD account for {Email}", user.Email);
                            }
                        }

                        // Restore database access
                        var dbSuccess = await UserAccessValidationService.RestoreUserAccessAsync(user.Email, modifiedBy);
                        
                        // ENHANCED: Restore Teams group membership
                        bool teamsGroupSuccess = true;
                        try
                        {
                            if (!string.IsNullOrEmpty(azureObjectId))
                            {
                                Logger.LogInformation("Restoring Teams group membership for user {Email}", user.Email);
                                teamsGroupSuccess = await TeamsGroupService.AddUserToOrganizationTeamsGroupAsync(azureObjectId, organizationId);
                                if (teamsGroupSuccess)
                                {
                                    Logger.LogInformation("✅ Successfully restored Teams group membership for {Email}", user.Email);
                                }
                                else
                                {
                                    Logger.LogWarning("❌ Failed to restore Teams group membership for {Email}", user.Email);
                                }
                            }
                        }
                        catch (Exception teamsEx)
                        {
                            Logger.LogError(teamsEx, "❌ Exception restoring Teams group for {Email}", user.Email);
                            teamsGroupSuccess = false;
                        }

                        // ENHANCED: Restore agent type security group memberships
                        bool agentGroupSuccess = true;
                        try
                        {
                            if (!string.IsNullOrEmpty(azureObjectId) && user.AgentTypeIds?.Any() == true)
                            {
                                Logger.LogInformation("Restoring agent security group memberships for user {Email} with {Count} agent types", 
                                    user.Email, user.AgentTypeIds.Count);
                                agentGroupSuccess = await AgentGroupAssignmentService.SyncUserAgentGroupAssignmentsAsync(azureObjectId, organizationId);
                                if (agentGroupSuccess)
                                {
                                    Logger.LogInformation("✅ Successfully restored agent security group memberships for {Email}", user.Email);
                                }
                                else
                                {
                                    Logger.LogWarning("❌ Failed to restore some agent security group memberships for {Email}", user.Email);
                                }
                            }
                            else
                            {
                                Logger.LogInformation("ℹ️ User {Email} has no agent types or Azure Object ID - skipping agent group restoration", user.Email);
                            }
                        }
                        catch (Exception agentEx)
                        {
                            Logger.LogError(agentEx, "❌ Exception restoring agent security groups for {Email}", user.Email);
                            agentGroupSuccess = false;
                        }
                        
                        // Track individual result with detailed group success tracking
                        var result = new UserOperationResult
                        {
                            UserEmail = user.Email,
                            AzureSuccess = !string.IsNullOrEmpty(azureObjectId) && azureSuccess,
                            DatabaseSuccess = dbSuccess,
                            GroupsSuccess = teamsGroupSuccess && agentGroupSuccess
                        };
                        
                        // Consider operation successful if critical components succeed (database + Azure AD account)
                        // Group management failures are logged but don't fail the entire operation
                        var criticalSuccess = dbSuccess && (!string.IsNullOrEmpty(azureObjectId) ? azureSuccess : true);
                        
                        if (criticalSuccess)
                        {
                            successCount++;
                            successful.Add(result);
                            if (result.GroupsSuccess)
                            {
                                Logger.LogInformation("✅ Full access restored for {Email} (including all group memberships)", user.Email);
                            }
                            else
                            {
                                Logger.LogWarning("⚠️ Partial access restored for {Email} - database and Azure AD account restored, but some group memberships may have failed", user.Email);
                            }
                        }
                        else
                        {
                            failureCount++;
                            result.ErrorMessage = $"Database restore: {(dbSuccess ? "OK" : "Failed")}, Azure AD: {(string.IsNullOrEmpty(azureObjectId) ? "No Object ID" : azureSuccess ? "OK" : "Failed")}, Groups: {(result.GroupsSuccess ? "OK" : "Partial")}";
                            failed.Add(result);
                            Logger.LogError("❌ Failed to restore access for {Email}", user.Email);
                        }
                    }
                    else
                    {
                        // DEACTIVATION: Disable user in Azure AD and revoke database access
                        var azureObjectId = user.AzureObjectId ?? await OnboardedUserService.GetAzureObjectIdByEmailAsync(user.Email, organizationId);
                        var azureSuccess = true; // Default to true if no Azure ObjectId (e.g., for invited but not yet signed-in users)
                        
                        if (!string.IsNullOrEmpty(azureObjectId))
                        {
                            // CRITICAL: Disable Azure AD account (not just remove from groups)
                            azureSuccess = await GraphService.DisableUserAccountAsync(azureObjectId);
                            if (azureSuccess)
                            {
                                Logger.LogInformation("✅ Azure AD account DISABLED for {Email}", user.Email);
                            }
                            else
                            {
                                Logger.LogWarning("❌ Failed to disable Azure AD account for {Email}", user.Email);
                                
                                // Fallback: Try comprehensive revocation if disable fails
                                var fallbackSuccess = await GraphService.RevokeUserAccessAsync(azureObjectId);
                                azureSuccess = fallbackSuccess;
                                Logger.LogInformation(fallbackSuccess ? 
                                    "✅ Fallback revocation succeeded for {Email}" : 
                                    "❌ Fallback revocation failed for {Email}", user.Email);
                            }
                        }

                        // ENHANCED: Remove from Teams group
                        bool teamsGroupSuccess = true;
                        try
                        {
                            if (!string.IsNullOrEmpty(azureObjectId))
                            {
                                Logger.LogInformation("Removing user from Teams group for {Email}", user.Email);
                                teamsGroupSuccess = await TeamsGroupService.RemoveUserFromOrganizationTeamsGroupAsync(azureObjectId, organizationId);
                                if (teamsGroupSuccess)
                                {
                                    Logger.LogInformation("✅ Successfully removed user from Teams group for {Email}", user.Email);
                                }
                                else
                                {
                                    Logger.LogWarning("❌ Failed to remove user from Teams group for {Email} (group may not exist)", user.Email);
                                    // Don't fail the entire operation if Teams group doesn't exist
                                    teamsGroupSuccess = true;
                                }
                            }
                        }
                        catch (Exception teamsEx)
                        {
                            Logger.LogError(teamsEx, "❌ Exception removing user from Teams group for {Email}", user.Email);
                            // Don't fail the entire operation for Teams group issues
                            teamsGroupSuccess = true;
                        }

                        // ENHANCED: Deactivate agent type security group memberships
                        bool agentGroupSuccess = true;
                        try
                        {
                            if (!string.IsNullOrEmpty(azureObjectId))
                            {
                                Logger.LogInformation("Deactivating agent security group memberships for user {Email}", user.Email);
                                agentGroupSuccess = await AgentGroupAssignmentService.DeactivateUserAgentGroupAssignmentsAsync(azureObjectId, organizationId);
                                if (agentGroupSuccess)
                                {
                                    Logger.LogInformation("✅ Successfully deactivated agent security group memberships for {Email}", user.Email);
                                }
                                else
                                {
                                    Logger.LogWarning("❌ Failed to deactivate some agent security group memberships for {Email}", user.Email);
                                }
                            }
                        }
                        catch (Exception agentEx)
                        {
                            Logger.LogError(agentEx, "❌ Exception deactivating agent security groups for {Email}", user.Email);
                            agentGroupSuccess = false;
                        }

                        // Revoke database access
                        var dbSuccess = await UserAccessValidationService.RevokeUserAccessAsync(user.Email, modifiedBy);
                        
                        // Track individual result with detailed group success tracking
                        var result = new UserOperationResult
                        {
                            UserEmail = user.Email,
                            AzureSuccess = !string.IsNullOrEmpty(azureObjectId) && azureSuccess,
                            DatabaseSuccess = dbSuccess,
                            GroupsSuccess = teamsGroupSuccess && agentGroupSuccess
                        };
                        
                        // Consider operation successful if critical components succeed (database + Azure AD account)
                        // Group management failures are logged but don't fail the entire operation
                        var criticalSuccess = dbSuccess && (!string.IsNullOrEmpty(azureObjectId) ? azureSuccess : true);
                        
                        if (criticalSuccess)
                        {
                            successCount++;
                            successful.Add(result);
                            if (result.GroupsSuccess)
                            {
                                Logger.LogInformation("✅ Full access revoked for {Email} (including all group memberships)", user.Email);
                            }
                            else
                            {
                                Logger.LogWarning("⚠️ Partial access revoked for {Email} - database and Azure AD account disabled, but some group removals may have failed", user.Email);
                            }
                        }
                        else
                        {
                            failureCount++;
                            result.ErrorMessage = $"Database revoke: {(dbSuccess ? "OK" : "Failed")}, Azure AD: {(string.IsNullOrEmpty(azureObjectId) ? "No Object ID" : azureSuccess ? "OK" : "Failed")}, Groups: {(result.GroupsSuccess ? "OK" : "Partial")}";
                            failed.Add(result);
                            Logger.LogError("❌ Failed to revoke access for {Email}", user.Email);
                        }
                    }
                }
                catch (Exception userEx)
                {
                    failureCount++;
                    var result = new UserOperationResult
                    {
                        UserEmail = user.Email,
                        AzureSuccess = false,
                        DatabaseSuccess = false,
                        GroupsSuccess = false,
                        ErrorMessage = $"Exception: {userEx.Message}"
                    };
                    failed.Add(result);
                    Logger.LogError(userEx, "❌ Exception processing user {Email} during organization {Action}", 
                        user.Email, activate ? "activation" : "deactivation");
                }
            }

            Logger.LogInformation("Organization user processing complete: {SuccessCount} succeeded, {FailureCount} failed", 
                successCount, failureCount);

            if (failureCount > 0)
            {
                Logger.LogWarning("⚠️ {FailureCount} users failed during organization {Action}. Manual verification recommended.", 
                    failureCount, activate ? "activation" : "deactivation");
            }
            
            return (successCount, failureCount, successful, failed);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "❌ CRITICAL ERROR during organization user processing for {Action}", 
                activate ? "activation" : "deactivation");
            throw; // Re-throw to stop organization update if user processing fails
        }
    }
}

@* Enhanced Organization Status Confirmation Modal *@
@if (showConfirmationModal)
{
    <OrganizationStatusConfirmationModal 
        OrganizationName="@(organizationBeingToggled?.Name ?? "")"
        UserCount="@confirmationUserCount"
        IsActivation="@confirmationIsActivation"
        IsProcessing="@isProcessingOrganization"
        OnConfirm="@OnConfirmOrganizationStatusChange"
        OnCancel="@OnCancelOrganizationStatusChange" />
}

@* Organization Status Results Modal *@
@if (showResultModal)
{
    <OrganizationStatusResultModal 
        OrganizationName="@(organizationBeingToggled?.Name ?? "")"
        IsActivation="@resultIsActivation"
        OverallSuccess="@resultOverallSuccess"
        TotalUsersProcessed="@resultTotalUsersProcessed"
        SuccessCount="@resultSuccessCount"
        FailureCount="@resultFailureCount"
        SuccessfulOperations="@resultSuccessfulOperations"
        FailedOperations="@resultFailedOperations"
        OnClose="@CloseResultModal" />
}

