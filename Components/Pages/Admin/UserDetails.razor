@page "/admin/users/{UserId:guid}"
@page "/users/{UserId:guid}"
@rendermode InteractiveServer
@using AdminConsole.Models
@using AdminConsole.Services
@using AdminConsole.Components.Shared
@using System.Security.Cryptography
@inject IOnboardedUserService OnboardedUserService
@inject IDataIsolationService DataIsolationService
@inject IOrganizationService OrganizationService
@inject IDatabaseCredentialService DatabaseCredentialService
@inject IInvitationService InvitationService
@inject IAgentTypeService AgentTypeService
@inject ILogger<UserDetails> Logger
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor
@inject IGraphService GraphService
@inject INavigationOptimizationService NavigationOptimizer
@attribute [Authorize(Policy = "OrgAdminOrHigher")]

<FastNavigationWrapper LoadingTitle="Loading User Details" 
                       LoadingMessage="Preparing user information..." 
                       PagePath="@($"/admin/users/{UserId}")"
                       OnDataLoad="LoadUserDataAsync">
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="/admin/users" class="text-decoration-none">My Users</a></li>
                            <li class="breadcrumb-item active">@(user?.Name ?? "User Details")</li>
                        </ol>
                    </nav>
                    <h2 class="mb-1 admin-page-title">@(user?.Name ?? "Loading...")</h2>
                    <p class="text-muted mb-0">
                        @if (user != null)
                        {
                            <span class="badge @(user.StateCode == StateCode.Active ? "bg-success" : "bg-secondary") me-2">
                                @(user.StateCode == StateCode.Active ? "Active" : "Inactive")
                            </span>
                            <span class="text-muted">@user.Email</span>
                        }
                    </p>
                </div>
                <div>
                    @if (user != null)
                    {
                        <button type="button" class="btn btn-outline-info me-2" @onclick="RefreshUserData" disabled="@isRefreshing">
                            @if (isRefreshing)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            }
                            else
                            {
                                <i class="fas fa-sync-alt me-1"></i>
                            }
                            Refresh
                        </button>
                        @if (user.GetInvitationStatus() == "Pending")
                        {
                            <button type="button" class="btn btn-outline-info me-2" @onclick="ResendInvitation">
                                <i class="fas fa-paper-plane me-1"></i>
                                Resend Invitation
                            </button>
                        }
                        @if (user.StateCode == StateCode.Active)
                        {
                            <button type="button" class="btn btn-outline-warning" @onclick="() => ToggleUserStatus(false)">
                                <i class="fas fa-pause me-1"></i>
                                Deactivate
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-outline-success" @onclick="() => ToggleUserStatus(true)">
                                <i class="fas fa-play me-1"></i>
                                Reactivate
                            </button>
                        }
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error:</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Success:</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading user details...</p>
                </div>
            }
            else if (user == null)
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">User Not Found</h5>
                        <p class="text-muted mb-3">
                            The requested user could not be found or you don't have permission to view it.
                        </p>
                        <a href="/admin/users" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Back to Users
                        </a>
                    </div>
                </div>
            }
            else
            {
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card mb-4">
                            <div class="card-header admin-card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-user me-2"></i>
                                    User Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-muted">Full Name</label>
                                            <p class="fw-bold">@user.Name</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-muted">Email Address</label>
                                            <p class="fw-bold">@user.Email</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-muted">Full Name</label>
                                            <p class="fw-bold">@user.FullName</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-muted">Assigned Databases</label>
                                            <p class="fw-bold">
                                                @{
                                                    // Filter to only show valid/existing database assignments
                                                    var validAssignedDatabases = availableDatabases.Where(db => user.AssignedDatabaseIds.Contains(db.Id)).ToList();
                                                }
                                                @if (validAssignedDatabases.Any())
                                                {
                                                    <span class="badge bg-success me-1">@validAssignedDatabases.Count database(s) assigned</span>
                                                    <br/>
                                                    <small class="text-muted">
                                                        @foreach (var database in validAssignedDatabases)
                                                        {
                                                            <span class="badge bg-primary me-1 mt-1">@database.FriendlyName (@database.DatabaseType)</span>
                                                        }
                                                    </small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">No databases assigned</span>
                                                }
                                            </p>
                                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ToggleDatabaseAssignment">
                                                <i class="fas fa-database me-1"></i>
                                                @(showDatabaseAssignment ? "Hide" : (user.AssignedDatabaseIds.Any() ? "Manage Databases" : "Assign Databases"))
                                            </button>
                                            
                                            @if (showDatabaseAssignment)
                                            {
                                                <div class="assignment-section">
                                                    <div class="assignment-header">
                                                        <i class="fas fa-database me-2"></i>
                                                        Database Assignment
                                                    </div>
                                                    @if (availableDatabases.Any())
                                                    {
                                                        <div class="assignment-select">
                                                            @foreach (var database in availableDatabases)
                                                            {
                                                                <div class="assignment-option @(selectedDatabaseIds.Contains(database.Id) ? "selected" : "")"
                                                                     @onclick="() => ToggleDatabaseSelection(database.Id)">
                                                                    <div class="assignment-item-name">@database.DatabaseName</div>
                                                                    <div class="assignment-item-info">@database.DatabaseType - @database.ServerInstance</div>
                                                                </div>
                                                            }
                                                        </div>
                                                        <div class="assignment-controls">
                                                            <button type="button" class="btn btn-primary btn-sm" @onclick="SaveDatabaseAssignments" disabled="@isSavingDatabaseAssignment">
                                                                @if (isSavingDatabaseAssignment)
                                                                {
                                                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                                                }
                                                                <i class="fas fa-save me-1"></i>
                                                                Save Assignments
                                                            </button>
                                                            <button type="button" class="btn btn-secondary btn-sm" @onclick="CancelDatabaseAssignment">
                                                                <i class="fas fa-times me-1"></i>
                                                                Cancel
                                                            </button>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="text-muted">
                                                            <i class="fas fa-info-circle me-2"></i>
                                                            No databases are available for assignment in your organization. Please add database credentials first.
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted">Assigned Supervisor</label>
                                    <p class="fw-bold">
                                        @if (!string.IsNullOrEmpty(user.AssignedSupervisorEmail))
                                        {
                                            @user.AssignedSupervisorEmail
                                        }
                                        else
                                        {
                                            <span class="text-muted">No supervisor assigned</span>
                                        }
                                    </p>
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ToggleSupervisorAssignment">
                                        <i class="fas fa-user-tie me-1"></i>
                                        @(showSupervisorAssignment ? "Hide" : (string.IsNullOrEmpty(user.AssignedSupervisorEmail) ? "Assign Supervisor" : "Change Supervisor"))
                                    </button>
                                    
                                    @if (showSupervisorAssignment)
                                    {
                                        <div class="assignment-section">
                                            <div class="assignment-header">
                                                <i class="fas fa-user-tie me-2"></i>
                                                Supervisor Assignment
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Supervisor Email Address</label>
                                                <input type="email" class="form-control" @bind="newSupervisorEmail" 
                                                       placeholder="Enter supervisor email address" />
                                                <div class="form-text">
                                                    Leave empty to remove the supervisor assignment.
                                                </div>
                                            </div>
                                            <div class="assignment-controls">
                                                <button type="button" class="btn btn-primary btn-sm" @onclick="SaveSupervisorAssignment" disabled="@isSavingSupervisorAssignment">
                                                    @if (isSavingSupervisorAssignment)
                                                    {
                                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                                    }
                                                    <i class="fas fa-save me-1"></i>
                                                    Save Assignment
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm" @onclick="CancelSupervisorAssignment">
                                                    <i class="fas fa-times me-1"></i>
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header admin-card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-robot me-2"></i>
                                    Agent Types
                                </h5>
                            </div>
                            <div class="card-body">
                                @if (currentUserAgentTypes.Any())
                                {
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var agentType in currentUserAgentTypes)
                                        {
                                            <span class="badge bg-primary fs-6">
                                                <i class="fas fa-robot me-1"></i>
                                                @agentType.DisplayName
                                            </span>
                                        }
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-3" @onclick="ToggleAgentTypesAssignment">
                                        <i class="fas fa-edit me-1"></i>
                                        @(showAgentTypesAssignment ? "Hide" : "Update Agent Types")
                                    </button>
                                }
                                else
                                {
                                    <p class="text-muted mb-3">No agent types assigned.</p>
                                    <button type="button" class="btn btn-primary btn-sm" @onclick="ToggleAgentTypesAssignment">
                                        <i class="fas fa-plus me-1"></i>
                                        @(showAgentTypesAssignment ? "Hide" : "Assign Agent Types")
                                    </button>
                                }
                                
                                @if (showAgentTypesAssignment)
                                {
                                    <div class="assignment-section">
                                        <div class="assignment-header">
                                            <i class="fas fa-robot me-2"></i>
                                            Agent Types Assignment
                                        </div>
                                        @if (availableAgentTypes.Any())
                                        {
                                            <div class="assignment-select">
                                                @foreach (var agentType in availableAgentTypes)
                                                {
                                                    <div class="form-check mb-3 p-3 border rounded @(selectedAgentTypeIds.Contains(agentType.Id) ? "border-primary bg-primary bg-opacity-10" : "border-secondary")">
                                                        <input class="form-check-input" type="checkbox" id="agentType_@agentType.Id" 
                                                               @onchange="(e) => ToggleAgentTypeSelection(agentType.Id)"
                                                               checked="@selectedAgentTypeIds.Contains(agentType.Id)">
                                                        <label class="form-check-label w-100" for="agentType_@agentType.Id">
                                                            <div class="assignment-item-name">
                                                                <strong>@agentType.DisplayName</strong>
                                                            </div>
                                                            <div class="assignment-item-info text-muted small">
                                                                @agentType.Description
                                                            </div>
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                            <div class="assignment-controls">
                                                <button type="button" class="btn btn-primary btn-sm" @onclick="SaveAgentTypesAssignment" disabled="@isSavingAgentTypes">
                                                    @if (isSavingAgentTypes)
                                                    {
                                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                                    }
                                                    <i class="fas fa-save me-1"></i>
                                                    Save Assignment
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm" @onclick="CancelAgentTypesAssignment">
                                                    <i class="fas fa-times me-1"></i>
                                                    Cancel
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                No agent types are allocated to your organization. Please contact the system administrator to configure agent types at the organization level.
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card mb-4">
                            <div class="card-header admin-card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Status Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label text-muted">User Status</label>
                                    <p>
                                        <span class="badge @(user.StateCode == StateCode.Active ? "bg-success" : "bg-secondary") fs-6">
                                            @(user.StateCode == StateCode.Active ? "Active" : "Inactive")
                                        </span>
                                    </p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted">Is Active</label>
                                    <p>
                                        <span class="badge @(user.IsActive ? "bg-success" : "bg-warning") fs-6">
                                            @(user.IsActive ? "Yes" : "No")
                                        </span>
                                    </p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted">
                                        Invitation Status
                                        <button class="btn btn-link btn-sm p-0 ms-2" @onclick="RefreshInvitationStatus" disabled="@isRefreshingStatus" title="Refresh from Azure AD">
                                            @if (isRefreshingStatus)
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-sync-alt text-primary"></i>
                                            }
                                        </button>
                                    </label>
                                    <p>
                                        @{
                                            var statusInfo = GetInvitationStatusInfo();
                                        }
                                        <span class="badge @statusInfo.BadgeClass fs-6">
                                            <i class="@statusInfo.Icon me-1"></i>
                                            @statusInfo.Text
                                        </span>
                                        @if (!string.IsNullOrEmpty(statusInfo.LastChecked))
                                        {
                                            <br><small class="text-muted">@statusInfo.LastChecked</small>
                                        }
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header admin-card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-history me-2"></i>
                                    Audit Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label text-muted">Created On</label>
                                    <p class="fw-bold">@user.CreatedOn.ToString("MMM dd, yyyy 'at' h:mm tt")</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted">Last Modified</label>
                                    <p class="fw-bold">@user.ModifiedOn.ToString("MMM dd, yyyy 'at' h:mm tt")</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted">User ID</label>
                                    <p class="font-monospace small">@user.OnboardedUserId</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>
</FastNavigationWrapper>

@code {
    [Parameter] public Guid UserId { get; set; }
    
    private OnboardedUser? user;
    private List<AgentTypeEntity> availableAgentTypes = new();
    private List<DatabaseCredential> availableDatabases = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = true;
    private Guid currentUserOrgId;
    private UserRole currentUserRole = UserRole.User;
    
    // Database assignment UI state
    private bool showDatabaseAssignment = false;
    private List<Guid> selectedDatabaseIds = new();
    private bool isSavingDatabaseAssignment = false;
    
    // Supervisor assignment UI state
    private bool showSupervisorAssignment = false;
    private string newSupervisorEmail = string.Empty;
    private bool isSavingSupervisorAssignment = false;
    
    // Agent Types assignment UI state
    private bool showAgentTypesAssignment = false;
    private List<Guid> selectedAgentTypeIds = new();
    private bool isSavingAgentTypes = false;
    
    // Refresh state
    private bool isRefreshing = false;
    private bool isRefreshingStatus = false;
    private string realTimeInvitationStatus = string.Empty;
    private DateTime? lastStatusCheck = null;
    
    // Current user agent types from database
    private List<AgentTypeEntity> currentUserAgentTypes = new();

    // üöÄ Fast Navigation Data Loading - called by FastNavigationWrapper
    private async Task LoadUserDataAsync()
    {
        try
        {
            currentUserRole = DataIsolationService.GetCurrentUserRole();
            
            var currentUserOrgIdStr = await DataIsolationService.GetCurrentUserOrganizationIdAsync();
            if (string.IsNullOrEmpty(currentUserOrgIdStr))
            {
                errorMessage = "Unable to determine your organization. Please contact support.";
                return;
            }

            // Try to parse as GUID, otherwise generate one from the string
            if (!Guid.TryParse(currentUserOrgIdStr, out currentUserOrgId))
            {
                // Generate deterministic GUID from organization ID string
                using (var md5 = System.Security.Cryptography.MD5.Create())
                {
                    var hash = md5.ComputeHash(System.Text.Encoding.UTF8.GetBytes(currentUserOrgIdStr));
                    currentUserOrgId = new Guid(hash);
                }
                Logger.LogInformation("Generated GUID for non-GUID organization ID: {OrgId}", currentUserOrgIdStr);
            }
            
            // Load data in parallel for better performance
            var loadTasks = new List<Task>
            {
                LoadUser(),
                LoadAvailableAgentTypes(),
                LoadAvailableDatabases()
            };
            
            await Task.WhenAll(loadTasks);
            
            // CRITICAL FIX: Automatically refresh invitation status on page load for accurate display
            if (user != null && user.LastInvitationDate != null)
            {
                await RefreshInvitationStatus();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading user details data for user {UserId}", UserId);
            errorMessage = "Error loading page. Please refresh and try again.";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // FastNavigationWrapper will handle data loading
        // This method is kept minimal for backward compatibility
        isLoading = false;
    }

    private async Task LoadUser()
    {
        try
        {
            // üöÄ Try to load user from cache first for faster performance  
            var cachedUser = NavigationOptimizer.GetCachedData<OnboardedUser>($"{NavigationOptimizationService.USER_DETAILS_CACHE_PREFIX}{UserId}");
            
            if (cachedUser != null)
            {
                user = cachedUser;
                Logger.LogDebug("üöÄ Using cached user details data for fast loading");
            }
            else
            {
                user = await OnboardedUserService.GetByIdAsync(UserId, currentUserOrgId);
                if (user != null)
                {
                    NavigationOptimizer.SetCachedData($"{NavigationOptimizationService.USER_DETAILS_CACHE_PREFIX}{UserId}", user, TimeSpan.FromMinutes(3));
                    Logger.LogDebug("üì¶ User details loaded from database and cached");
                }
            }
            
            // Load current agent type assignments from database
            if (user != null)
            {
                var allUserAgentTypes = await OnboardedUserService.GetUserAgentTypesAsync(user.OnboardedUserId, currentUserOrgId);
                
                // CRITICAL FIX: Filter user agent types to only show those currently allocated to the organization
                var orgAgentTypeIds = await OrganizationService.GetOrganizationAgentTypesAsync(currentUserOrgId.ToString());
                var orgAgentTypeIdSet = orgAgentTypeIds.ToHashSet();
                currentUserAgentTypes = allUserAgentTypes.Where(at => orgAgentTypeIdSet.Contains(at.Id)).ToList();
                
                Logger.LogInformation("Loaded {AllCount} total agent types for user, showing {FilteredCount} (org-allocated only)", 
                    allUserAgentTypes.Count, currentUserAgentTypes.Count);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading user {UserId} for organization {OrganizationId}", UserId, currentUserOrgId);
            errorMessage = "Error loading user details. Please try again.";
        }
    }

    private async Task LoadAvailableAgentTypes()
    {
        try
        {
            // Get organization-allocated agent types only (not all active agent types)
            var orgAgentTypeIds = await OrganizationService.GetOrganizationAgentTypesAsync(currentUserOrgId.ToString());
            
            if (orgAgentTypeIds.Any())
            {
                // Get the full agent type entities for the organization-allocated types
                var allAgentTypes = await AgentTypeService.GetActiveAgentTypesAsync();
                availableAgentTypes = allAgentTypes.Where(at => orgAgentTypeIds.Contains(at.Id)).ToList();
                
                Logger.LogInformation("Loaded {Count} organization-allocated agent types for organization {OrgId}", 
                    availableAgentTypes.Count, currentUserOrgId);
            }
            else
            {
                availableAgentTypes = new List<AgentTypeEntity>();
                Logger.LogInformation("No agent types allocated to organization {OrgId}", currentUserOrgId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading organization-allocated agent types");
            availableAgentTypes = new List<AgentTypeEntity>();
        }
    }

    private async Task LoadAvailableDatabases()
    {
        try
        {
            // Clear existing list to ensure fresh data
            availableDatabases.Clear();
            StateHasChanged();
            
            // TEMPORARY FIX: Use same method as ManageDatabaseCredentials to test
            var allDatabases = await DatabaseCredentialService.GetByOrganizationAsync(currentUserOrgId);
            availableDatabases = allDatabases.Where(d => d.IsActive).ToList();
            Logger.LogInformation("üîç DATABASE DEBUG: Loaded {Count} available databases for organization {OrgId}", 
                availableDatabases.Count, currentUserOrgId);
            Logger.LogInformation("üîç DATABASE DEBUG: Using organization ID: {OrgId} (generated from domain)", currentUserOrgId);
            
            // Log each database for debugging
            foreach (var db in availableDatabases)
            {
                Logger.LogInformation("üîç DATABASE DEBUG: - {FriendlyName} ({DatabaseName}) - Active: {IsActive}", 
                    db.FriendlyName, db.DatabaseName, db.IsActive);
            }
            
            // Force UI refresh
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading available databases");
            availableDatabases = new List<DatabaseCredential>();
            StateHasChanged();
        }
    }






    private async Task ToggleUserStatus(bool activate)
    {
        if (user == null) return;

        try
        {
            ClearMessages();
            var currentUserId = GetCurrentUserId();

            // CRITICAL SECURITY CHECK: Validate user permissions before allowing deactivation
            if (!activate) // Only check for deactivation, not reactivation
            {
                if (!CanRemoveUser(user))
                {
                    errorMessage = "You do not have permission to deactivate this user.";
                    Logger.LogWarning("User attempted to deactivate user {UserId} without proper permissions", user.OnboardedUserId);
                    StateHasChanged();
                    return;
                }
            }

            bool success;
            if (activate)
            {
                success = await OnboardedUserService.ReactivateAsync(user.OnboardedUserId, currentUserOrgId, currentUserId);
                if (success)
                {
                    successMessage = $"User {user.Name} has been reactivated successfully.";
                }
            }
            else
            {
                success = await OnboardedUserService.DeactivateAsync(user.OnboardedUserId, currentUserOrgId, currentUserId);
                if (success)
                {
                    successMessage = $"User {user.Name} has been deactivated successfully.";
                }
            }

            if (success)
            {
                await LoadUser(); // Reload to get updated status
            }
            else
            {
                errorMessage = $"Failed to {(activate ? "reactivate" : "deactivate")} user. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling user status for {UserId}", user.OnboardedUserId);
            errorMessage = "An unexpected error occurred. Please try again.";
        }

        StateHasChanged();
    }

    private void ClearMessages()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    private async void ToggleDatabaseAssignment()
    {
        showDatabaseAssignment = !showDatabaseAssignment;
        if (showDatabaseAssignment && user != null)
        {
            // Refresh available databases when opening the modal
            await LoadAvailableDatabases();
            
            // Initialize selected databases with current assignments
            selectedDatabaseIds = user.AssignedDatabaseIds.ToList();
        }
        else
        {
            selectedDatabaseIds.Clear();
        }
        StateHasChanged();
    }

    private void ToggleDatabaseSelection(Guid databaseId)
    {
        if (selectedDatabaseIds.Contains(databaseId))
        {
            selectedDatabaseIds.Remove(databaseId);
        }
        else
        {
            selectedDatabaseIds.Add(databaseId);
        }
        StateHasChanged();
    }

    private async Task SaveDatabaseAssignments()
    {
        if (user == null || isSavingDatabaseAssignment) return;

        try
        {
            ClearMessages();
            isSavingDatabaseAssignment = true;
            StateHasChanged();

            var currentUserId = GetCurrentUserId();
            var success = await OnboardedUserService.UpdateDatabaseAssignmentsAsync(
                user.OnboardedUserId,
                selectedDatabaseIds,
                currentUserOrgId,
                currentUserId);

            if (success)
            {
                successMessage = $"Database assignments updated successfully for {user.Name}.";
                await LoadUser(); // Reload to get updated assignments
                showDatabaseAssignment = false;
            }
            else
            {
                errorMessage = "Failed to update database assignments. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating database assignments for user {UserId}", user.OnboardedUserId);
            errorMessage = "An unexpected error occurred while updating database assignments. Please try again.";
        }
        finally
        {
            isSavingDatabaseAssignment = false;
            StateHasChanged();
        }
    }

    private void CancelDatabaseAssignment()
    {
        showDatabaseAssignment = false;
        selectedDatabaseIds.Clear();
        StateHasChanged();
    }

    private async Task UpdateUserDatabaseAssignments(List<Guid> newDatabaseIds)
    {
        if (user == null) return;

        try
        {
            ClearMessages();
            
            var currentUserId = GetCurrentUserId();
            var success = await OnboardedUserService.UpdateDatabaseAssignmentsAsync(
                user.OnboardedUserId, 
                newDatabaseIds, 
                currentUserOrgId, 
                currentUserId);
            
            if (success)
            {
                successMessage = $"Database assignments updated successfully for {user.Name}.";
                await LoadUser(); // Reload to get updated assignments
            }
            else
            {
                errorMessage = "Failed to update database assignments. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating database assignments for user {UserId}", user.OnboardedUserId);
            errorMessage = "An unexpected error occurred while updating database assignments. Please try again.";
        }
    }

    private async Task ResendInvitation()
    {
        if (user == null) return;

        try
        {
            ClearMessages();
            
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
                $"Are you sure you want to resend the invitation to {user.Name} ({user.Email})?");
                
            if (confirmed)
            {
                var result = await InvitationService.ResendInvitationAsync(user.OnboardedUserId);
                
                if (result.Success)
                {
                    successMessage = $"Invitation resent successfully to {user.Email}.";
                }
                else
                {
                    errorMessage = $"Failed to resend invitation: {result.Message}";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error resending invitation for user {UserId}", user.OnboardedUserId);
            errorMessage = "An unexpected error occurred while resending the invitation. Please try again.";
        }
        
        StateHasChanged();
    }

    private void ToggleSupervisorAssignment()
    {
        showSupervisorAssignment = !showSupervisorAssignment;
        if (showSupervisorAssignment && user != null)
        {
            // Initialize with current supervisor email
            newSupervisorEmail = user.AssignedSupervisorEmail ?? string.Empty;
        }
        else
        {
            newSupervisorEmail = string.Empty;
        }
        StateHasChanged();
    }

    private async Task SaveSupervisorAssignment()
    {
        if (user == null || isSavingSupervisorAssignment) return;

        try
        {
            ClearMessages();
            isSavingSupervisorAssignment = true;
            StateHasChanged();

            // Validate email format if provided
            if (!string.IsNullOrEmpty(newSupervisorEmail) && !IsValidEmail(newSupervisorEmail))
            {
                errorMessage = "Please enter a valid email address for the supervisor.";
                return;
            }

            var currentUserId = GetCurrentUserId();
            var success = await OnboardedUserService.UpdateSupervisorAssignmentAsync(
                user.OnboardedUserId,
                newSupervisorEmail.Trim(),
                currentUserOrgId,
                currentUserId);

            if (success)
            {
                var action = string.IsNullOrEmpty(newSupervisorEmail.Trim()) ? "removed" : "updated";
                successMessage = $"Supervisor assignment {action} successfully for {user.Name}.";
                await LoadUser(); // Reload to get updated assignment
                showSupervisorAssignment = false;
            }
            else
            {
                errorMessage = "Failed to update supervisor assignment. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating supervisor assignment for user {UserId}", user.OnboardedUserId);
            errorMessage = "An unexpected error occurred while updating supervisor assignment. Please try again.";
        }
        finally
        {
            isSavingSupervisorAssignment = false;
            StateHasChanged();
        }
    }

    private void CancelSupervisorAssignment()
    {
        showSupervisorAssignment = false;
        newSupervisorEmail = string.Empty;
        StateHasChanged();
    }

    private async Task UpdateSupervisorAssignment(string newSupervisorEmail)
    {
        if (user == null) return;

        try
        {
            ClearMessages();
            
            // Validate email format if provided
            if (!string.IsNullOrEmpty(newSupervisorEmail) && !IsValidEmail(newSupervisorEmail))
            {
                errorMessage = "Please enter a valid email address for the supervisor.";
                StateHasChanged();
                return;
            }
            
            var currentUserId = GetCurrentUserId();
            var success = await OnboardedUserService.UpdateSupervisorAssignmentAsync(
                user.OnboardedUserId, 
                newSupervisorEmail, 
                currentUserOrgId, 
                currentUserId);
            
            if (success)
            {
                var action = string.IsNullOrEmpty(newSupervisorEmail) ? "removed" : "updated";
                successMessage = $"Supervisor assignment {action} successfully for {user.Name}.";
                await LoadUser(); // Reload to get updated assignment
            }
            else
            {
                errorMessage = "Failed to update supervisor assignment. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating supervisor assignment for user {UserId}", user.OnboardedUserId);
            errorMessage = "An unexpected error occurred while updating supervisor assignment. Please try again.";
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private Guid GetCurrentUserId()
    {
        try
        {
            var user = HttpContextAccessor.HttpContext?.User;
            var objectId = user?.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier")?.Value;
            
            if (!string.IsNullOrEmpty(objectId) && Guid.TryParse(objectId, out var userId))
            {
                return userId;
            }
            
            Logger.LogWarning("Could not get current user ID from claims");
            return Guid.NewGuid(); // Fallback
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error getting current user ID");
            return Guid.NewGuid(); // Fallback
        }
    }

    private void ToggleAgentTypesAssignment()
    {
        showAgentTypesAssignment = !showAgentTypesAssignment;
        if (showAgentTypesAssignment && user != null)
        {
            try
            {
                // CRITICAL FIX: Use the already filtered currentUserAgentTypes instead of loading from database
                // This ensures we only work with agent types that are currently allocated to the organization
                selectedAgentTypeIds = currentUserAgentTypes.Select(at => at.Id).ToList();
                
                Logger.LogInformation("Initialized agent type selection for user {UserId}: {AgentTypes} (org-allocated only)", 
                    user.OnboardedUserId, string.Join(", ", selectedAgentTypeIds));
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading current agent type assignments for user {UserId}", user.OnboardedUserId);
                selectedAgentTypeIds.Clear();
            }
        }
        else
        {
            selectedAgentTypeIds.Clear();
        }
        StateHasChanged();
    }

    private void ToggleAgentTypeSelection(Guid agentTypeId)
    {
        if (selectedAgentTypeIds.Contains(agentTypeId))
        {
            selectedAgentTypeIds.Remove(agentTypeId);
        }
        else
        {
            selectedAgentTypeIds.Add(agentTypeId);
        }
        StateHasChanged();
    }

    private async Task SaveAgentTypesAssignment()
    {
        if (user == null || isSavingAgentTypes) return;

        try
        {
            ClearMessages();
            isSavingAgentTypes = true;
            StateHasChanged();

            var currentUserId = GetCurrentUserId();
            
            Logger.LogInformation("üîç DEBUG: About to update agent types for user {UserId} with types: {AgentTypeIds}", 
                user.OnboardedUserId, string.Join(", ", selectedAgentTypeIds));
            
            // Use the new fallback method that handles Azure AD sync failures gracefully
            var result = await OnboardedUserService.UpdateUserAgentTypesWithFallbackAsync(
                user.OnboardedUserId,
                selectedAgentTypeIds.ToList(),
                currentUserOrgId,
                currentUserId);
                
            Logger.LogInformation("üîç DEBUG: Update result - Success: {Success}, DB Updated: {DbUpdated}, Azure Synced: {AzureSynced}", 
                result.Success, result.DatabaseUpdated, result.AzureADSynced);

            if (result.Success)
            {
                if (result.AzureADSynced)
                {
                    successMessage = $"Agent types updated successfully for {user.Name}. Azure AD security group memberships have been synchronized.";
                }
                else if (!string.IsNullOrEmpty(result.WarningMessage))
                {
                    successMessage = $"Agent types updated successfully for {user.Name}. However, there was a warning: {result.WarningMessage}";
                }
                else
                {
                    successMessage = $"Agent types updated successfully for {user.Name}.";
                }
                
                await LoadUser(); // Reload to get updated assignments
                showAgentTypesAssignment = false;
                Logger.LogInformation("Successfully updated agent types for user {UserId} - Azure AD synced: {AzureSynced}", user.OnboardedUserId, result.AzureADSynced);
            }
            else
            {
                errorMessage = !string.IsNullOrEmpty(result.ErrorMessage) 
                    ? $"Failed to update agent types: {result.ErrorMessage}"
                    : "Failed to update agent types. Please try again.";
                Logger.LogError("Failed to update agent types for user {UserId} - Error: {ErrorMessage}", user.OnboardedUserId, result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating agent types for user {UserId}", user.OnboardedUserId);
            errorMessage = "An unexpected error occurred while updating agent types. Please try again.";
        }
        finally
        {
            isSavingAgentTypes = false;
            StateHasChanged();
        }
    }

    private void CancelAgentTypesAssignment()
    {
        showAgentTypesAssignment = false;
        selectedAgentTypeIds.Clear();
        StateHasChanged();
    }

    private async Task RefreshUserData()
    {
        if (isRefreshing) return;
        
        try
        {
            isRefreshing = true;
            ClearMessages();
            StateHasChanged();
            
            // Parse organization ID properly for domain-based IDs
            var currentUserOrgIdStr = await DataIsolationService.GetCurrentUserOrganizationIdAsync();
            if (!string.IsNullOrEmpty(currentUserOrgIdStr))
            {
                Guid organizationGuid;
                if (!Guid.TryParse(currentUserOrgIdStr, out organizationGuid))
                {
                    // Generate deterministic GUID from organization ID string
                    using (var md5 = System.Security.Cryptography.MD5.Create())
                    {
                        var hash = md5.ComputeHash(System.Text.Encoding.UTF8.GetBytes(currentUserOrgIdStr));
                        organizationGuid = new Guid(hash);
                    }
                }
                currentUserOrgId = organizationGuid;
            }
            
            // Reload all data
            await LoadUser();
            await LoadAvailableAgentTypes();
            await LoadAvailableDatabases();
            
            successMessage = "User data refreshed successfully.";
            Logger.LogInformation("Successfully refreshed user data for user {UserId}", UserId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing user data for user {UserId}", UserId);
            errorMessage = "Error refreshing user data. Please try again.";
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();
        }
    }


    // SECURITY METHODS - Prevent unauthorized user deactivation
    private bool CanRemoveUser(OnboardedUser targetUser)
    {
        Logger.LogInformation("=== UserDetails.CanRemoveUser DEBUG ===");
        Logger.LogInformation("Target User: {UserEmail}", targetUser.Email);
        Logger.LogInformation("Current User Role: {CurrentUserRole}", currentUserRole);
        
        // Get current user info for debugging
        var currentUserEmail = HttpContextAccessor.HttpContext?.User.FindFirst("email")?.Value ?? 
                              HttpContextAccessor.HttpContext?.User.FindFirst("preferred_username")?.Value;
        Logger.LogInformation("Current User Email: {CurrentUserEmail}", currentUserEmail);
        
        // CRITICAL SECURITY CHECK: No one can deactivate themselves - this is the primary issue to fix
        if (IsCurrentUser(targetUser))
        {
            Logger.LogInformation("RESULT: FALSE - User cannot remove themselves: {UserEmail}", targetUser.Email);
            return false;
        }

        // Super Admins can remove anyone (except themselves, checked above)
        if (currentUserRole == UserRole.SuperAdmin)
        {
            Logger.LogInformation("RESULT: TRUE - SuperAdmin can remove user: {UserEmail}", targetUser.Email);
            return true;
        }

        // Org Admins can only remove regular organization users (OrgUsers), not other Org Admins
        if (currentUserRole == UserRole.OrgAdmin)
        {
            var targetUserRole = GetUserRole(targetUser);
            
            // Additional safety check for same domain users
            if (!string.IsNullOrEmpty(currentUserEmail))
            {
                var currentUserDomain = currentUserEmail.Split('@').LastOrDefault();
                var targetUserDomain = targetUser.Email?.Split('@').LastOrDefault();
                
                if (!string.IsNullOrEmpty(currentUserDomain) && 
                    !string.IsNullOrEmpty(targetUserDomain) &&
                    string.Equals(currentUserDomain, targetUserDomain, StringComparison.OrdinalIgnoreCase))
                {
                    if (targetUserRole == UserRole.OrgAdmin)
                    {
                        Logger.LogInformation("RESULT: FALSE - OrgAdmin cannot remove other OrgAdmin from same domain: {UserEmail}", targetUser.Email);
                        return false;
                    }
                }
            }
            
            // OrgAdmins can remove regular users but NOT other OrgAdmins
            var canRemove = targetUserRole != UserRole.OrgAdmin;
            Logger.LogInformation("RESULT: {CanRemove} - OrgAdmin attempting to remove user: {UserEmail} (Target Role: {TargetRole})", 
                canRemove, targetUser.Email, targetUserRole);
            return canRemove;
        }

        // Regular users cannot remove anyone
        Logger.LogInformation("RESULT: FALSE - Regular user cannot remove anyone: {UserEmail}", targetUser.Email);
        return false;
    }

    private bool IsCurrentUser(OnboardedUser targetUser)
    {
        // Get current user's email from the HTTP context
        var currentUserEmail = HttpContextAccessor.HttpContext?.User.FindFirst("email")?.Value ?? 
                              HttpContextAccessor.HttpContext?.User.FindFirst("preferred_username")?.Value ?? 
                              HttpContextAccessor.HttpContext?.User.FindFirst("upn")?.Value ?? 
                              HttpContextAccessor.HttpContext?.User.FindFirst("unique_name")?.Value ??
                              HttpContextAccessor.HttpContext?.User.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress")?.Value;

        Logger.LogInformation("IsCurrentUser DEBUG: Current user email: {CurrentUserEmail}, Target user email: {TargetUserEmail}", 
            currentUserEmail, targetUser.Email);

        // Compare with the target user's email
        var isCurrentUser = !string.IsNullOrEmpty(currentUserEmail) && 
                           string.Equals(currentUserEmail, targetUser.Email, StringComparison.OrdinalIgnoreCase);
        
        Logger.LogInformation("IsCurrentUser result: {IsCurrentUser}", isCurrentUser);
        return isCurrentUser;
    }

    private UserRole GetUserRole(OnboardedUser targetUser)
    {
        // Use the extension method to get the user's role from database
        var role = targetUser.GetUserRole();
        Logger.LogInformation("GetUserRole for {UserEmail}: {Role} (AgentTypes: {AgentTypes})", 
            targetUser.Email, role, 
            targetUser.AgentTypes != null ? string.Join(", ", targetUser.AgentTypes) : "null");
        return role;
    }

    private async Task RefreshInvitationStatus()
    {
        if (isRefreshingStatus || user == null) return;

        try
        {
            isRefreshingStatus = true;
            StateHasChanged();

            // Use the real-time invitation status method if available
            realTimeInvitationStatus = await user.GetRealTimeInvitationStatusAsync(GraphService);
            lastStatusCheck = DateTime.Now;
            
            Logger.LogInformation("Refreshed invitation status for user {Email}: {Status}", user.Email, realTimeInvitationStatus);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing invitation status for user {Email}", user?.Email);
            // Fallback to database status
            realTimeInvitationStatus = user?.GetInvitationStatus() ?? "Unknown";
        }
        finally
        {
            isRefreshingStatus = false;
            StateHasChanged();
        }
    }

    private (string Text, string BadgeClass, string Icon, string LastChecked) GetInvitationStatusInfo()
    {
        if (user == null) 
            return ("Unknown", "bg-secondary", "fas fa-question", "");

        // CRITICAL FIX: Always prioritize real-time Azure AD status over database status
        // Azure AD is the authoritative source for B2B invitation status
        var status = !string.IsNullOrEmpty(realTimeInvitationStatus) ? realTimeInvitationStatus : user.GetInvitationStatus();
        
        // Show if we're using real-time or database status
        var lastChecked = lastStatusCheck.HasValue 
            ? $"Last checked: {lastStatusCheck.Value:MMM dd, h:mm tt} (Azure AD)" 
            : "Database status (click refresh for real-time)";

        return status switch
        {
            "Accepted" => ("‚úÖ Accepted", "bg-success", "fas fa-check-circle", lastChecked),
            "PendingAcceptance" => ("‚è≥ Pending", "bg-warning", "fas fa-clock", lastChecked),
            "NotInvited" => ("‚ùå Not Invited", "bg-secondary", "fas fa-envelope", lastChecked),
            "Inactive" => ("‚ö†Ô∏è Inactive", "bg-danger", "fas fa-user-times", lastChecked),
            _ => (status, "bg-info", "fas fa-info-circle", lastChecked)
        };
    }
}