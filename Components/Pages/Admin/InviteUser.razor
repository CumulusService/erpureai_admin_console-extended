@page "/admin/users/invite"
@page "/users/invite"
@rendermode InteractiveServer
@using AdminConsole.Models
@using AdminConsole.Services
@using AdminConsole.Components.Shared
@using System.Security.Cryptography
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IInvitationService InvitationService
@inject IDataIsolationService DataIsolationService
@inject IOrganizationService OrganizationService
@inject IDatabaseCredentialService DatabaseCredentialService
@inject IUserDatabaseAccessService UserDatabaseAccessService
@inject IAgentTypeService AgentTypeService
@inject ILogger<InviteUser> Logger
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IBusinessDomainValidationService BusinessDomainValidationService
@inject IOnboardedUserService OnboardedUserService
@attribute [Authorize(Policy = "OrgAdminOrHigher")]
@implements IDisposable

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1 admin-page-title">Invite User</h2>
                    <p class="admin-page-subtitle mb-0">Send invitation to join your organization</p>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error:</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Success:</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (!userInvitationsAllowed)
            {
                <div class="alert alert-warning border-0 mb-4" role="alert">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <i class="fas fa-ban fa-2x text-warning"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                User Invitations Restricted
                            </h5>
                            <p class="mb-2">
                                Your organization has been configured with restricted user invitation permissions. 
                                You cannot invite new users to your organization at this time.
                            </p>
                            <hr class="my-2">
                            <p class="mb-0">
                                <strong>Need to invite users?</strong> Contact your Super Administrator to enable user invitation permissions for your organization.
                            </p>
                        </div>
                    </div>
                </div>
            }

            <div class="row">
                <div class="col-md-8 col-lg-6">
                    @* ADDITIVE: Optional user search before invitation - completely optional *@
                    <div class="card mb-3">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-search me-2"></i>
                                    Quick User Search (Optional)
                                </h6>
                                <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ToggleUserSearch">
                                    @if (showUserSearch)
                                    {
                                        <i class="fas fa-chevron-up"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-chevron-down"></i>
                                    }
                                </button>
                            </div>
                        </div>
                        @if (showUserSearch)
                        {
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    Search for existing users before sending invitations to avoid duplicates.
                                </p>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" placeholder="Search by email or name (auto-suggests)..." 
                                           @bind="searchQuery" @onkeyup="OnSearchKeyUp" @oninput="OnSearchInput" />
                                    <button class="btn btn-outline-secondary" type="button" @onclick="SearchUsers">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                
                                @if (isSearching)
                                {
                                    <div class="text-center py-2">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Searching...</span>
                                    </div>
                                }
                                else if (searchResults.Any())
                                {
                                    <div class="mb-3">
                                        <h6 class="text-primary mb-2">Found @searchResults.Count user(s):</h6>
                                        @foreach (var user in searchResults)
                                        {
                                            <div class="card mb-2">
                                                <div class="card-body p-3">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <h6 class="mb-1">@user.FullName</h6>
                                                            <p class="text-muted mb-1">@user.Email</p>
                                                            <div>
                                                                @if (user.IsDeleted)
                                                                {
                                                                    <span class="badge bg-dark">
                                                                        <i class="fas fa-trash me-1"></i> Deleted
                                                                    </span>
                                                                }
                                                                else if (user.StateCode == StateCode.Inactive)
                                                                {
                                                                    <span class="badge bg-secondary">
                                                                        <i class="fas fa-user-times me-1"></i> Inactive
                                                                    </span>
                                                                }
                                                                else if (user.StateCode == StateCode.Active)
                                                                {
                                                                    <span class="badge bg-success">
                                                                        <i class="fas fa-check me-1"></i> Active
                                                                    </span>
                                                                }
                                                            </div>
                                                        </div>
                                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => PreFillFromUser(user)">
                                                            <i class="fas fa-arrow-down me-1"></i> Use This User
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else if (!string.IsNullOrEmpty(searchQuery) && searchQuery.Length >= 2 && !isSearching)
                                {
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No users found matching your search.
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    
                    <div class="card @(!userInvitationsAllowed ? "bg-light border-secondary" : "")">
                        <div class="card-header admin-card-header @(!userInvitationsAllowed ? "bg-secondary text-muted" : "")">
                            <h5 class="card-title mb-0 @(!userInvitationsAllowed ? "text-muted" : "")">
                                <i class="fas @(userInvitationsAllowed ? "fa-user-plus" : "fa-ban") me-2"></i>
                                User Invitation Details @(!userInvitationsAllowed ? "(Disabled)" : "")
                            </h5>
                        </div>
                        <div class="card-body @(!userInvitationsAllowed ? "bg-light text-muted" : "")"
                             style="@(!userInvitationsAllowed ? "opacity: 0.6; pointer-events: none;" : "")">
                            <EditForm Model="invitationModel" OnValidSubmit="SendInvitationAsync">
                                <DataAnnotationsValidator />
                                
                                <!-- Enhanced Unsaved Changes Tracking -->
                                <UnsavedChangesTracker @ref="unsavedChangesTracker" 
                                                     FormId="invite-user-form"
                                                     TrackChanges="@hasFormChanges"
                                                     Context="invitation"
                                                     UserRole="@currentUserRole.ToString()"
                                                     WarningMessage="You have unsaved invitation details. Are you sure you want to leave without sending the invitation?"
                                                     OnUnsavedChangesChanged="OnUnsavedChangesChanged" />
                                
                                <div class="mb-3">
                                    <label for="email" class="form-label">
                                        Email Address <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                        <InputText @bind-Value="invitationModel.Email" 
                                                 class="form-control" 
                                                 id="email" 
                                                 placeholder="user@yourdomain.com"
                                                 @onblur="ValidateEmailDomain"
                                                 @onchange="OnInputChanged" />
                                    </div>
                                    <ValidationMessage For="@(() => invitationModel.Email)" />
                                    @if (!string.IsNullOrEmpty(domainValidationMessage))
                                    {
                                        <div class="form-text text-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            @domainValidationMessage
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(allowedDomain))
                                    {
                                        <div class="form-text text-info">
                                            <i class="fas fa-info-circle me-1"></i>
                                            You can only invite users from your domain: <strong>@allowedDomain</strong>
                                        </div>
                                    }
                                    @* ADDITIVE: Show existing user warning (purely informational) *@
                                    @if (showExistingUserWarning && !string.IsNullOrEmpty(existingUserMessage))
                                    {
                                        <div class="alert alert-warning alert-dismissible mt-2" role="alert">
                                            <i class="fas fa-user-check me-2"></i>
                                            <strong>Existing User Found:</strong> @existingUserMessage
                                            @if (existingUser != null)
                                            {
                                                <div class="mt-2 small">
                                                    <strong>Current Status:</strong> 
                                                    @if (existingUser.IsDeleted)
                                                    {
                                                        <span class="badge bg-secondary">Deleted</span>
                                                    }
                                                    else if (existingUser.StateCode == StateCode.Inactive)
                                                    {
                                                        <span class="badge bg-warning">Inactive</span>
                                                    }
                                                    else if (existingUser.StateCode == StateCode.Active)
                                                    {
                                                        <span class="badge bg-success">Active</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">Unknown</span>
                                                    }
                                                    @if (!string.IsNullOrEmpty(existingUser.FullName) && existingUser.FullName != invitationModel.DisplayName)
                                                    {
                                                        <span class="ms-2">| Current Name: <strong>@existingUser.FullName</strong></span>
                                                    }
                                                </div>
                                            }
                                            <button type="button" class="btn-close" @onclick="() => showExistingUserWarning = false"></button>
                                        </div>
                                    }
                                </div>

                                <div class="mb-3">
                                    <label for="displayName" class="form-label">
                                        Display Name <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-user"></i>
                                        </span>
                                        <InputText @bind-Value="invitationModel.DisplayName" 
                                                 class="form-control" 
                                                 id="displayName" 
                                                 placeholder="Enter user's full name"
                                                 @onchange="OnInputChanged" />
                                    </div>
                                    <ValidationMessage For="@(() => invitationModel.DisplayName)" />
                                </div>

                                <div class="mb-3">
                                    <label for="agentTypes" class="form-label">
                                        Agent Types <span class="text-danger">*</span>
                                    </label>
                                    @if (availableAgentTypes.Any())
                                    {
                                        @foreach (var agentType in availableAgentTypes)
                                        {
                                            <div class="form-check">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="agent_@agentType.Id" 
                                                       @onchange="@((e) => { ToggleAgentTypeSelection(agentType.Id, (bool)e.Value!); OnInputChanged(); })" />
                                                <label class="form-check-label" for="agent_@agentType.Id">
                                                    <strong>@agentType.DisplayName</strong>
                                                    @if (!string.IsNullOrEmpty(agentType.Description))
                                                    {
                                                        <br><small class="text-muted">@agentType.Description</small>
                                                    }
                                                    @if (!string.IsNullOrEmpty(agentType.AgentShareUrl))
                                                    {
                                                        <br><small class="text-info"><i class="fas fa-link me-1"></i>Share link will be included in invitation</small>
                                                    }
                                                </label>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            No agent types have been allocated to your organization. Please contact your SuperAdmin to configure agent types.
                                        </div>
                                    }
                                    <div class="form-text">
                                        Select the types of agents this user will have access to. Only agent types allocated by SuperAdmin to your organization are available.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Database Access <span class="text-danger">*</span>
                                    </label>
                                    @if (availableDatabases.Any())
                                    {
                                        @foreach (var database in availableDatabases)
                                        {
                                            <div class="form-check">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="db_@database.Id" 
                                                       @onchange="@((e) => { ToggleDatabaseSelection(database.Id, (bool)e.Value!); OnInputChanged(); })" />
                                                <label class="form-check-label" for="db_@database.Id">
                                                    <strong>@database.FriendlyName</strong> - @database.DatabaseType (@database.DatabaseName)
                                                    @if (!string.IsNullOrEmpty(database.Description))
                                                    {
                                                        <br><small class="text-muted">@database.Description</small>
                                                    }
                                                </label>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            No database credentials found for your organization. Please add database credentials first.
                                        </div>
                                    }
                                    <div class="form-text">
                                        Select which databases this user can access. Users inherit database settings from your organization.
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="message" class="form-label">
                                        Personal Message (Optional)
                                    </label>
                                    <InputTextArea @bind-Value="invitationModel.PersonalMessage" 
                                                 class="form-control" 
                                                 id="message" 
                                                 rows="3"
                                                 placeholder="Add a personal message to the invitation..."
                                                 @onchange="OnInputChanged" />
                                    <div class="form-text">
                                        This message will be included in the invitation email.
                                    </div>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <ActionButton Text="Clear Form"
                                                IconClass="fas fa-times"
                                                Type="ActionType.Secondary"
                                                Size="ButtonSize.Normal"
                                                OnClick="@(async () => { ClearForm(); await Task.CompletedTask; })"
                                                IsDisabled="@isLoading"
                                                FullDescription="Clear all form fields and start over"
                                                ConsequenceText="Form reset"
                                                ShowConsequence="false" />
                                    
                                    <button type="submit" class="btn btn-primary action-btn d-flex align-items-center" disabled="@(isLoading || !IsFormValid())">
                                        @if (isLoading)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                            <span>Sending invitation...</span>
                                        }
                                        else
                                        {
                                            <i class="fas fa-paper-plane me-2"></i>
                                            <span>Send Invitation</span>
                                            <small class="ms-2 opacity-75">(User gets access)</small>
                                        }
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 col-lg-6">
                    <div class="card">
                        <div class="card-header admin-card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Invitation Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6 class="text-primary">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Domain Security
                                </h6>
                                <p class="small text-muted">
                                    You can only invite users from your organization's domain (@allowedDomain). 
                                    This ensures secure multi-tenant isolation.
                                </p>
                            </div>

                            <div class="mb-3">
                                <h6 class="text-primary">
                                    <i class="fas fa-users me-1"></i>
                                    Azure AD Integration
                                </h6>
                                <p class="small text-muted">
                                    Invited users will be added to your organization's Azure AD Security Group 
                                    automatically and granted appropriate permissions.
                                </p>
                            </div>

                            <div class="mb-3">
                                <h6 class="text-primary">
                                    <i class="fas fa-envelope me-1"></i>
                                    Invitation Process
                                </h6>
                                <ol class="small text-muted ps-3">
                                    <li>User receives invitation email</li>
                                    <li>User accepts invitation in Azure AD</li>
                                    <li>User is added to security group</li>
                                    <li>User can access the admin console</li>
                                </ol>
                            </div>

                            @if (currentUserRole == UserRole.SuperAdmin)
                            {
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-crown me-1"></i>
                                        Super Admin Mode
                                    </h6>
                                    <p class="mb-0 small">
                                        As a Super Admin, you can invite users to any organization. 
                                        Domain validation is relaxed for cross-organization management.
                                    </p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private InvitationModel invitationModel = new();
    private List<AgentTypeEntity> availableAgentTypes = new();
    private HashSet<Guid> selectedAgentTypeIds = new();
    private List<DatabaseCredential> availableDatabases = new();
    private HashSet<Guid> selectedDatabaseIds = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string domainValidationMessage = string.Empty;
    private string allowedDomain = string.Empty;
    private bool isLoading = false;
    private UserRole currentUserRole = UserRole.User;
    private Organization? currentOrganization = null;
    private bool userInvitationsAllowed = true;
    
    // Enhanced unsaved changes tracking
    private UnsavedChangesTracker? unsavedChangesTracker;
    private bool hasFormChanges = false;
    
    // ADDITIVE: Enhanced user validation (purely informational - doesn't block existing functionality)
    private string existingUserMessage = string.Empty;
    private OnboardedUser? existingUser = null;
    private bool showExistingUserWarning = false;
    
    // ADDITIVE: Optional user search functionality (completely optional feature)
    private bool showUserSearch = false;
    private string searchQuery = string.Empty;
    private List<OnboardedUser> searchResults = new();
    private bool isSearching = false;

    // üöÄ PERFORMANCE OPTIMIZATION: Debounce timer for auto-suggestions
    private Timer? searchDebounceTimer;
    private const int DebounceDelayMs = 300;
    
    // üöÄ Performance optimization: Prevent unnecessary re-renders
    protected override bool ShouldRender()
    {
        // Only render when we have meaningful state changes
        return !isLoading || !string.IsNullOrEmpty(errorMessage) || !string.IsNullOrEmpty(successMessage) || 
               hasFormChanges || searchResults.Any() || showExistingUserWarning;
    }

    public class InvitationModel
    {
        [Required(ErrorMessage = "Email address is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Display name is required")]
        [StringLength(100, MinimumLength = 2, ErrorMessage = "Display name must be between 2 and 100 characters")]
        public string DisplayName { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "Personal message cannot exceed 500 characters")]
        public string PersonalMessage { get; set; } = string.Empty;
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUserRole = DataIsolationService.GetCurrentUserRole();
            
            // Get current user's organization to determine allowed domain and load databases
            var currentUserOrgId = await DataIsolationService.GetCurrentUserOrganizationIdAsync();
            if (!string.IsNullOrEmpty(currentUserOrgId))
            {
                var organization = await OrganizationService.GetByIdAsync(currentUserOrgId);
                if (organization != null)
                {
                    currentOrganization = organization;
                    allowedDomain = organization.Domain;
                    userInvitationsAllowed = organization.AllowUserInvitations;
                    
                    if (!userInvitationsAllowed)
                    {
                        Logger.LogInformation("üö´ User invitations disabled for organization {OrganizationName} - showing restricted access message", 
                            organization.Name);
                    }
                }
                
                // Load organization-assigned agent types
                await LoadAvailableAgentTypes(currentUserOrgId);
                
                // Load available databases for the organization
                Guid orgGuid;
                if (!Guid.TryParse(currentUserOrgId, out orgGuid))
                {
                    // Generate deterministic GUID from organization ID string
                    using (var md5 = System.Security.Cryptography.MD5.Create())
                    {
                        var hash = md5.ComputeHash(System.Text.Encoding.UTF8.GetBytes(currentUserOrgId));
                        orgGuid = new Guid(hash);
                    }
                    Logger.LogInformation("Generated GUID for non-GUID organization ID: {OrgId}", currentUserOrgId);
                }
                availableDatabases = await DatabaseCredentialService.GetActiveByOrganizationAsync(orgGuid);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing invite user page");
            errorMessage = "Error loading page. Please refresh and try again.";
        }
    }

    private async Task LoadAvailableAgentTypes(string currentUserOrgId)
    {
        try
        {
            // Get organization-allocated agent type IDs
            var orgAgentTypeIds = await OrganizationService.GetOrganizationAgentTypesAsync(currentUserOrgId);
            
            if (orgAgentTypeIds.Any())
            {
                // Get the full agent type entities for the organization-allocated types
                availableAgentTypes = await AgentTypeService.GetAgentTypesByIdsAsync(orgAgentTypeIds);
            }
            else
            {
                availableAgentTypes = new List<AgentTypeEntity>();
                Logger.LogInformation("No agent types allocated to organization {OrgId}", currentUserOrgId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading available agent types for organization {OrgId}", currentUserOrgId);
            availableAgentTypes = new List<AgentTypeEntity>();
        }
    }

    private void ToggleAgentTypeSelection(Guid agentTypeId, bool isSelected)
    {
        if (isSelected)
        {
            selectedAgentTypeIds.Add(agentTypeId);
        }
        else
        {
            selectedAgentTypeIds.Remove(agentTypeId);
        }
        StateHasChanged();
    }

    private async Task ValidateEmailDomain()
    {
        domainValidationMessage = string.Empty;
        // ADDITIVE: Clear existing user validation (doesn't affect domain validation)
        existingUserMessage = string.Empty;
        existingUser = null;
        showExistingUserWarning = false;
        
        if (string.IsNullOrEmpty(invitationModel.Email) || !invitationModel.Email.Contains("@"))
        {
            return;
        }

        // üö´ CRITICAL: Business domain validation - Block private email domains
        var businessDomainValidation = BusinessDomainValidationService.ValidateBusinessDomain(invitationModel.Email);
        if (!businessDomainValidation.IsValid)
        {
            Logger.LogWarning("üö´ BLOCKED USER INVITATION: Business domain validation failed for {Email}. Reason: {Message}", 
                invitationModel.Email, businessDomainValidation.Message);
            domainValidationMessage = $"üö´ Business Email Required: {businessDomainValidation.Message}";
            return;
        }
        
        Logger.LogInformation("‚úÖ BUSINESS DOMAIN VALIDATED: User email {Email} with domain {Domain} passed business validation", 
            invitationModel.Email, businessDomainValidation.Domain);

        try
        {
            var currentUserOrgId = await DataIsolationService.GetCurrentUserOrganizationIdAsync();
            if (string.IsNullOrEmpty(currentUserOrgId))
            {
                domainValidationMessage = "Unable to validate domain. Please contact support.";
                return;
            }

            Guid orgGuid;
            if (!Guid.TryParse(currentUserOrgId, out orgGuid))
            {
                // Generate deterministic GUID from organization ID string
                using (var md5 = System.Security.Cryptography.MD5.Create())
                {
                    var hash = md5.ComputeHash(System.Text.Encoding.UTF8.GetBytes(currentUserOrgId));
                    orgGuid = new Guid(hash);
                }
                Logger.LogInformation("Generated GUID for non-GUID organization ID: {OrgId}", currentUserOrgId);
            }
            var canInvite = await InvitationService.CanInviteEmailAsync(orgGuid, invitationModel.Email);
            
            if (!canInvite && currentUserRole != UserRole.SuperAdmin)
            {
                domainValidationMessage = $"You can only invite users from your domain ({allowedDomain}).";
                return; // Exit early if domain validation fails
            }
            
            // ADDITIVE: Check for existing user (purely informational - doesn't block invitation)
            await CheckForExistingUser(orgGuid);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error validating email domain for {Email}", invitationModel.Email);
            domainValidationMessage = "Error validating domain. Please try again.";
        }
    }
    
    /// <summary>
    /// ADDITIVE: Checks for existing users and shows friendly warnings (doesn't block existing functionality)
    /// </summary>
    private async Task CheckForExistingUser(Guid orgGuid)
    {
        try
        {
            // Check if user already exists in this organization
            existingUser = await OnboardedUserService.GetByEmailAsync(invitationModel.Email, orgGuid);
            
            if (existingUser != null)
            {
                showExistingUserWarning = true;
                
                // Determine user status and show appropriate message
                if (existingUser.IsDeleted)
                {
                    existingUserMessage = $"User {invitationModel.Email} was previously deleted. Sending invitation will reactivate their account and restore access.";
                }
                else if (existingUser.StateCode == StateCode.Inactive)
                {
                    existingUserMessage = $"User {invitationModel.Email} is currently inactive. Sending invitation will reactivate their account.";
                }
                else if (existingUser.StateCode == StateCode.Active)
                {
                    existingUserMessage = $"User {invitationModel.Email} already exists and is active. Sending invitation will update their access permissions.";
                }
                else
                {
                    existingUserMessage = $"User {invitationModel.Email} already exists in the system. Sending invitation will update their access.";
                }
                
                Logger.LogInformation("ADDITIVE: Found existing user {Email} with status: StateCode={StateCode}, IsDeleted={IsDeleted}", 
                    invitationModel.Email, existingUser.StateCode, existingUser.IsDeleted);
            }
        }
        catch (Exception ex)
        {
            // ADDITIVE: Don't break existing functionality if this check fails
            Logger.LogWarning(ex, "ADDITIVE: Could not check for existing user {Email} - continuing with normal invitation flow", invitationModel.Email);
            existingUserMessage = string.Empty;
            existingUser = null;
            showExistingUserWarning = false;
        }
    }

    private void ToggleDatabaseSelection(Guid databaseId, bool isSelected)
    {
        if (isSelected)
        {
            selectedDatabaseIds.Add(databaseId);
        }
        else
        {
            selectedDatabaseIds.Remove(databaseId);
        }
        StateHasChanged();
    }

    private bool IsFormValid()
    {
        return !string.IsNullOrEmpty(invitationModel.Email) &&
               !string.IsNullOrEmpty(invitationModel.DisplayName) &&
               selectedDatabaseIds.Any() &&
               selectedAgentTypeIds.Any() &&
               string.IsNullOrEmpty(domainValidationMessage);
    }

    private async Task SendInvitationAsync()
    {
        if (isLoading) return;

        try
        {
            ClearMessages();
            isLoading = true;

            // Get current user's organization
            var currentUserOrgId = await DataIsolationService.GetCurrentUserOrganizationIdAsync();
            if (string.IsNullOrEmpty(currentUserOrgId))
            {
                errorMessage = "Unable to determine your organization. Please contact support.";
                return;
            }

            // Build agent types list - pass selected agent type IDs
            var agentTypeIdsList = selectedAgentTypeIds.ToList();

            // Get current user information for audit trail and security
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var currentUser = authState.User;
            var currentUserEmail = currentUser.FindFirst("email")?.Value ?? 
                                 currentUser.FindFirst("preferred_username")?.Value ?? 
                                 currentUser.FindFirst("upn")?.Value;
            var currentUserId = currentUser.FindFirst("oid")?.Value ?? 
                              currentUser.FindFirst("sub")?.Value ?? 
                              currentUser.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            // Parse current user ID for audit trail
            Guid inviterGuid = Guid.Empty;
            if (!string.IsNullOrEmpty(currentUserId) && !Guid.TryParse(currentUserId, out inviterGuid))
            {
                Logger.LogWarning("Could not parse current user ID {UserId} as GUID, using empty GUID", currentUserId);
            }
            
            // Send invitation
            Guid orgGuid;
            if (!Guid.TryParse(currentUserOrgId!, out orgGuid))
            {
                // Generate deterministic GUID from organization ID string
                using (var md5 = System.Security.Cryptography.MD5.Create())
                {
                    var hash = md5.ComputeHash(System.Text.Encoding.UTF8.GetBytes(currentUserOrgId!));
                    orgGuid = new Guid(hash);
                }
                Logger.LogInformation("Generated GUID for non-GUID organization ID: {OrgId}", currentUserOrgId);
            }
            var result = await InvitationService.InviteUserAsync(
                orgGuid,
                invitationModel.Email,
                invitationModel.DisplayName, // Pass the exact display name from the form
                inviterGuid, // Use actual current user ID
                new List<LegacyAgentType>(), // Empty legacy types for backward compatibility
                agentTypeIdsList, // Use selected agent type IDs
                selectedDatabaseIds.ToList(), // Pass selected database IDs
                UserRole.User, // üîë NEW: Explicitly set user role based on invitation flow
                currentUserEmail // Current user email for self-invitation prevention
            );

            if (result.Success)
            {
                // Mark form as successfully submitted
                await OnFormSubmitted();
                
                // ADDITIVE: Enhanced success message to distinguish new vs updated vs reactivated users
                var assignedAgentTypes = availableAgentTypes.Where(at => selectedAgentTypeIds.Contains(at.Id)).Select(at => at.DisplayName);
                var agentTypeList = string.Join(", ", assignedAgentTypes);
                var assignedDatabases = availableDatabases.Where(db => selectedDatabaseIds.Contains(db.Id)).Select(db => db.FriendlyName);
                var databaseList = string.Join(", ", assignedDatabases);
                
                // Determine the type of operation that occurred based on existing user status
                string operationType;
                string additionalInfo = "";
                
                if (existingUser != null)
                {
                    if (existingUser.IsDeleted)
                    {
                        operationType = "üîÑ User account reactivated";
                        additionalInfo = " The user's account has been restored with full access.";
                    }
                    else if (existingUser.StateCode == StateCode.Inactive)
                    {
                        operationType = "üîÑ User account reactivated";
                        additionalInfo = " The inactive user has been reactivated with updated permissions.";
                    }
                    else if (existingUser.StateCode == StateCode.Active)
                    {
                        operationType = "üìù Existing user updated";
                        additionalInfo = " The user's access permissions have been updated.";
                    }
                    else
                    {
                        operationType = "üìù User account updated";
                        additionalInfo = " The user's account has been updated with new permissions.";
                    }
                }
                else
                {
                    operationType = "‚úÖ New user invited";
                    additionalInfo = " The user will receive an email with agent share links and instructions to join your organization.";
                }
                
                successMessage = $"{operationType} successfully for {invitationModel.Email}. " +
                               $"Agent types: {agentTypeList}. Database access: {databaseList}.{additionalInfo}";
                
                // Clear form after successful invitation
                await Task.Delay(1500); // Show success message for 1.5 seconds
                ClearForm();
                
                // Navigate to user management page - user should now appear immediately due to cache clearing in InvitationService
                successMessage = $"‚úÖ Invitation sent! Redirecting to user list...";
                StateHasChanged();
                await Task.Delay(500); // Brief pause to show redirect message
                Navigation.NavigateTo("/admin/users", forceLoad: true); // Force reload to ensure fresh data
            }
            else
            {
                errorMessage = string.Join("; ", result.Errors);
                if (string.IsNullOrEmpty(errorMessage))
                {
                    errorMessage = result.Message ?? "Failed to send invitation. Please try again.";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error sending invitation to {Email}", invitationModel.Email);
            errorMessage = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ClearForm()
    {
        invitationModel = new InvitationModel();
        selectedAgentTypeIds.Clear();
        selectedDatabaseIds.Clear();
        ClearMessages();
        domainValidationMessage = string.Empty;
        StateHasChanged();
    }

    private void ClearMessages()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();
    }

    // Enhanced unsaved changes tracking methods
    private void OnInputChanged()
    {
        hasFormChanges = true;
        unsavedChangesTracker?.MarkAsChanged();
    }

    private void OnUnsavedChangesChanged(bool hasChanges)
    {
        hasFormChanges = hasChanges;
        StateHasChanged();
    }

    private async Task OnFormSubmitted()
    {
        hasFormChanges = false;
        if (unsavedChangesTracker != null)
        {
            await unsavedChangesTracker.MarkAsSaved();
        }
    }
    
    // ADDITIVE: Optional user search methods (purely optional - doesn't interfere with existing functionality)
    
    /// <summary>
    /// ADDITIVE: Toggles the visibility of the optional user search component
    /// </summary>
    private void ToggleUserSearch()
    {
        showUserSearch = !showUserSearch;
        if (!showUserSearch)
        {
            // Clear search when hiding to save memory
            searchQuery = string.Empty;
            searchResults.Clear();
        }
        StateHasChanged();
    }
    
    /// <summary>
    /// ADDITIVE: Handles keyboard events in search box (Enter key to search)
    /// </summary>
    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && searchQuery.Length >= 2)
        {
            await SearchUsers();
        }
    }

    /// <summary>
    /// üöÄ PERFORMANCE OPTIMIZATION: Debounced auto-suggestion search on input
    /// </summary>
    private void OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? string.Empty;

        // Cancel previous timer
        searchDebounceTimer?.Dispose();

        if (searchQuery.Length < 2)
        {
            searchResults.Clear();
            StateHasChanged();
            return;
        }

        // Start new debounced timer for auto-suggestions
        searchDebounceTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await SearchUsers();
            });
        }, null, DebounceDelayMs, Timeout.Infinite);
    }
    
    /// <summary>
    /// ADDITIVE: Searches for existing users (optional feature - doesn't impact core functionality)
    /// </summary>
    private async Task SearchUsers()
    {
        if (string.IsNullOrEmpty(searchQuery) || searchQuery.Length < 2)
        {
            searchResults.Clear();
            return;
        }
        
        try
        {
            isSearching = true;
            StateHasChanged();
            
            var currentUserOrgId = await DataIsolationService.GetCurrentUserOrganizationIdAsync();
            if (string.IsNullOrEmpty(currentUserOrgId))
            {
                Logger.LogWarning("ADDITIVE: Could not get current user organization for search");
                return;
            }
            
            Guid orgGuid;
            if (!Guid.TryParse(currentUserOrgId, out orgGuid))
            {
                // Generate deterministic GUID from organization ID string
                using (var md5 = System.Security.Cryptography.MD5.Create())
                {
                    var hash = md5.ComputeHash(System.Text.Encoding.UTF8.GetBytes(currentUserOrgId));
                    orgGuid = new Guid(hash);
                }
            }
            
            Logger.LogInformation("üöÄ PERFORMANCE: Using optimized database search for '{SearchQuery}'", searchQuery);

            // üöÄ PERFORMANCE OPTIMIZATION: Use new efficient database search instead of loading all users
            searchResults = await OnboardedUserService.SearchUsersByQueryAsync(orgGuid, searchQuery, 10);
            
            Logger.LogInformation("üöÄ PERFORMANCE SUCCESS: Search for '{SearchQuery}' found {Count} results with optimized query", 
                searchQuery, searchResults.Count);
        }
        catch (Exception ex)
        {
            // ADDITIVE: Don't break the page if search fails
            Logger.LogWarning(ex, "ADDITIVE: User search failed for query '{SearchQuery}' - feature disabled for this session", searchQuery);
            searchResults.Clear();
        }
        finally
        {
            isSearching = false;
            // StateHasChanged(); // üöÄ Removed: ShouldRender() will handle this automatically
        }
    }
    
    /// <summary>
    /// ADDITIVE: Pre-fills the invitation form with data from selected existing user
    /// </summary>
    private void PreFillFromUser(OnboardedUser user)
    {
        try
        {
            // Pre-fill the form with existing user data
            invitationModel.Email = user.Email;
            invitationModel.DisplayName = user.FullName ?? user.Name ?? "";
            
            // Clear any previous validation messages since we're starting fresh
            existingUserMessage = string.Empty;
            domainValidationMessage = string.Empty;
            showExistingUserWarning = false;
            
            // Mark form as changed
            OnInputChanged();
            
            // Collapse the search area since user made their choice
            showUserSearch = false;
            searchResults.Clear();
            
            Logger.LogInformation("ADDITIVE: Pre-filled form with data from existing user {Email}", user.Email);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // ADDITIVE: Don't break functionality if pre-fill fails
            Logger.LogWarning(ex, "ADDITIVE: Failed to pre-fill form from user {Email}", user.Email);
        }
    }

    /// <summary>
    /// üöÄ PERFORMANCE OPTIMIZATION: Proper cleanup to prevent memory leaks
    /// </summary>
    public void Dispose()
    {
        searchDebounceTimer?.Dispose();
    }
}