@page "/admin/database-credentials"
@page "/database-credentials"
@rendermode InteractiveServer
@using AdminConsole.Models
@using AdminConsole.Services
@using System.Security.Cryptography
@using System.ComponentModel.DataAnnotations
@inject IDatabaseCredentialService DatabaseCredentialService
@inject IDataIsolationService DataIsolationService
@inject IOrganizationService OrganizationService
@inject ILogger<ManageDatabaseCredentials> Logger
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@attribute [Authorize(Policy = "OrgAdminOrHigher")]

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1 admin-page-title">Database Credentials</h2>
                    <p class="admin-page-subtitle mb-0">Manage shared SAP Business One database credentials for your organization</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-info" @onclick="RefreshCredentials" disabled="@isRefreshing">
                        @if (isRefreshing)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        else
                        {
                            <i class="fas fa-sync-alt me-1"></i>
                        }
                        Refresh
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="ShowCreateModal">
                        <i class="fas fa-plus me-1"></i>
                        Add Database Credentials
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error:</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Success:</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (currentUserRole == UserRole.SuperAdmin)
            {
                <div class="alert alert-warning" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-shield-alt me-2"></i>
                        Super Admin Security Notice
                    </h6>
                    <p class="mb-0">
                        As a Super Admin, you have administrative control over database credentials but cannot view passwords, 
                        connection strings, or other sensitive data for security and compliance reasons. Organization Admins 
                        have full access to their organization's database credentials.
                    </p>
                </div>
            }

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading database credentials...</p>
                </div>
            }
            else if (credentials == null || !credentials.Any())
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Database Credentials Found</h5>
                        <p class="text-muted mb-3">
                            Set up shared SAP Business One database credentials for your organization.
                            All users will use these credentials to access the database.
                        </p>
                        <button type="button" class="btn btn-primary" @onclick="ShowCreateModal">
                            <i class="fas fa-plus me-1"></i>
                            Add Your First Database Credentials
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="row">
                    @foreach (var credential in credentials)
                    {
                        <div class="col-md-6 col-lg-4 mb-4" @key="credential.Id">
                            <div class="card h-100 @(!credential.IsActive ? "border-secondary" : "")">
                                <div class="card-header d-flex justify-content-between align-items-center @(!credential.IsActive ? "bg-light text-muted" : "")">
                                    <div>
                                        <h6 class="card-title mb-0 @(!credential.IsActive ? "text-muted" : "")">
                                            <i class="fas fa-database me-2 @(!credential.IsActive ? "text-muted" : "")"></i>
                                            @credential.FriendlyName
                                            @if (!credential.IsActive)
                                            {
                                                <span class="badge bg-secondary ms-2">Inactive</span>
                                            }
                                        </h6>
                                        <small class="text-muted">@credential.DatabaseType Database</small>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <button class="dropdown-item" @onclick="() => ShowEditModal(credential)">
                                                    <i class="fas fa-edit me-2"></i>Edit
                                                </button>
                                            </li>
                                            @if (currentUserRole != UserRole.SuperAdmin && credential.IsActive)
                                            {
                                                <li>
                                                    <button class="dropdown-item" @onclick="() => ShowPasswordModal(credential)">
                                                        <i class="fas fa-key me-2"></i>Update Password
                                                    </button>
                                                </li>
                                            }
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item text-danger" @onclick="() => ShowDeleteModal(credential)">
                                                    <i class="fas fa-trash me-2"></i>Delete
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-body @(!credential.IsActive ? "text-muted" : "")">
                                    <div class="mb-2">
                                        <small class="text-muted">Server:</small><br>
                                        <strong class="@(!credential.IsActive ? "text-muted" : "")">@credential.ServerInstance</strong>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">Database:</small><br>
                                        <strong class="@(!credential.IsActive ? "text-muted" : "")">@credential.DatabaseName</strong>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">SAP Username:</small><br>
                                        <strong class="@(!credential.IsActive ? "text-muted" : "")">@credential.SAPUsername</strong>
                                    </div>
                                    @if (!string.IsNullOrEmpty(credential.SAPServiceLayerHostname))
                                    {
                                        <div class="mb-2">
                                            <small class="text-muted">SAP Service Layer:</small><br>
                                            <strong class="@(!credential.IsActive ? "text-muted" : "")">@credential.SAPServiceLayerHostname</strong>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(credential.DocumentCode))
                                    {
                                        <div class="mb-2">
                                            <small class="text-muted">Document Code:</small><br>
                                            <strong class="@(!credential.IsActive ? "text-muted" : "")">@credential.DocumentCode</strong>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(credential.Description))
                                    {
                                        <div class="mb-2">
                                            <small class="text-muted">Description:</small><br>
                                            <span class="small">@credential.Description</span>
                                        </div>
                                    }
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            @credential.CreatedOn.ToString("MMM dd, yyyy")
                                        </small>
                                        <span class="badge @(credential.IsActive ? "bg-success" : "bg-secondary")">
                                            @(credential.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="credentialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(isEditMode ? "Edit Database Credentials" : "Add Database Credentials")
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <EditForm Model="credentialModel" OnSubmit="SaveCredential">
                @if (!isEditMode)
                {
                    <DataAnnotationsValidator />
                }
                else
                {
                    <!-- Custom validation for edit mode - exclude password validation -->
                    <ValidationSummary />
                }
                <div class="modal-body">
                    <div class="alert alert-info border-0 mb-4">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                            <div>
                                <strong>Connection Testing Required</strong>
                                <br>
                                <small>
                                    @if (isEditMode)
                                    {
                                        <text>You must successfully test the database connection before updating credentials.
                                        This ensures any changes work properly for all users in your organization.</text>
                                    }
                                    else
                                    {
                                        <text>You must successfully test the database connection before creating credentials.
                                        This ensures the credentials work properly for all users in your organization.</text>
                                    }
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="friendlyName" class="form-label">
                            Friendly Name <span class="text-danger">*</span>
                        </label>
                        <InputText @bind-Value="credentialModel.FriendlyName" 
                                 class="form-control" 
                                 id="friendlyName" 
                                 placeholder="e.g., Production, Test, Development" />
                        <ValidationMessage For="@(() => credentialModel.FriendlyName)" />
                        <div class="form-text">A descriptive name to identify this database configuration.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="databaseType" class="form-label">
                                    Database Type <span class="text-danger">*</span>
                                </label>
                                <InputSelect @bind-Value="SelectedDatabaseType" 
                                           class="form-select" 
                                           id="databaseType"
                                           disabled="@isEditMode">
                                    <option value="">Select database type</option>
                                    <option value="@DatabaseType.MSSQL">Microsoft SQL Server</option>
                                    <option value="@DatabaseType.HANA">SAP HANA</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => credentialModel.DatabaseType)" />
                                @if (isEditMode)
                                {
                                    <div class="form-text">Database type cannot be changed after creation.</div>
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="serverInstance" class="form-label">
                                    Server Host/IP <span class="text-danger">*</span>
                                </label>
                                <InputText @bind-Value="credentialModel.ServerInstance" 
                                         @bind-Value:after="OnCriticalFieldChanged"
                                         class="form-control" 
                                         id="serverInstance" 
                                         placeholder="@(credentialModel.DatabaseType == DatabaseType.HANA ? "hostname.domain.com or 192.168.1.100" : "server.domain.com or 192.168.1.100")" />
                                <ValidationMessage For="@(() => credentialModel.ServerInstance)" />
                                <div class="form-text">
                                    @(credentialModel.DatabaseType == DatabaseType.HANA ? "SAP HANA hostname or IP address" : "SQL Server hostname or IP address")
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="instanceName" class="form-label">
                                    Instance Name
                                </label>
                                <InputText @bind-Value="credentialModel.InstanceName" 
                                         class="form-control" 
                                         id="instanceName" 
                                         placeholder="@(credentialModel.DatabaseType == DatabaseType.HANA ? "e.g., FP2502@SECHANA01:30013" : "e.g., SECSQL\\FP2502")" />
                                <ValidationMessage For="@(() => credentialModel.InstanceName)" />
                                <div class="form-text">
                                    @(credentialModel.DatabaseType == DatabaseType.HANA ? "HANA instance identifier (leave empty for default)" : "SQL Server instance name (leave empty for default instance)")
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="port" class="form-label">
                                    Port
                                </label>
                                <InputNumber @bind-Value="credentialModel.Port" 
                                           @bind-Value:after="OnCriticalFieldChanged"
                                           class="form-control" 
                                           id="port" 
                                           placeholder="@(credentialModel.DatabaseType == DatabaseType.HANA ? "30101" : "1433")" />
                                <ValidationMessage For="@(() => credentialModel.Port)" />
                                <div class="form-text">
                                    @(credentialModel.DatabaseType == DatabaseType.HANA ? "HANA port (e.g., 30101)" : "SQL Server port (default 1433)")
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="databaseName" class="form-label">
                                    Database Name <span class="text-danger">*</span>
                                </label>
                                <InputText @bind-Value="credentialModel.DatabaseName" 
                                         @bind-Value:after="OnCriticalFieldChanged"
                                         class="form-control" 
                                         id="databaseName" 
                                         placeholder="SAP Business One database name" />
                                <ValidationMessage For="@(() => credentialModel.DatabaseName)" />
                            </div>
                        </div>
                    </div>

                    <!-- Database Credentials Section -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-database me-2"></i>Database Connection Credentials
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="databaseUsername" class="form-label">
                                        Database Username <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="credentialModel.DatabaseUsername" 
                                             @bind-Value:after="OnCriticalFieldChanged"
                                             class="form-control" 
                                             id="databaseUsername" 
                                             placeholder="@(credentialModel.DatabaseType == DatabaseType.HANA ? "HANA database user" : "SQL Server database user")" />
                                    <ValidationMessage For="@(() => credentialModel.DatabaseUsername)" />
                                    <div class="form-text">Database user for connecting to @(credentialModel.DatabaseType?.ToString() ?? "database")</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="databasePassword" class="form-label">
                                        Database Password <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <InputText @bind-Value="credentialModel.DatabasePassword" 
                                                 @bind-Value:after="OnCriticalFieldChanged"
                                                 type="@(showDatabasePassword ? "text" : "password")"
                                                 class="form-control" 
                                                 id="databasePassword" 
                                                 placeholder="@(showDatabasePassword ? "Database password" : "••••••••••••••••")" />
                                        <button type="button" 
                                                class="btn btn-outline-secondary" 
                                                @onclick="ToggleDatabasePasswordVisibility"
                                                title="@(showDatabasePassword ? "Hide Password" : "Show Password")">
                                            <i class="fas @(showDatabasePassword ? "fa-eye-slash" : "fa-eye")"></i>
                                        </button>
                                    </div>
                                    <ValidationMessage For="@(() => credentialModel.DatabasePassword)" />
                                    <div class="form-text">Password for database connection</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SAP Business One Credentials Section -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-user me-2"></i>SAP Business One Application Credentials
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sapUsername" class="form-label">
                                        SAP Username <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="credentialModel.SAPUsername" 
                                             class="form-control" 
                                             id="sapUsername" 
                                             placeholder="SAP Business One username" />
                                    <ValidationMessage For="@(() => credentialModel.SAPUsername)" />
                                    <div class="form-text">SAP B1 user shared by all users in your organization</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sapPassword" class="form-label">
                                    SAP Password <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <InputText @bind-Value="credentialModel.SAPPassword" 
                                             type="@(showPassword ? "text" : "password")"
                                             class="form-control" 
                                             id="sapPassword" 
                                             placeholder="@(showPassword ? "SAP Business One password" : "••••••••••••••••")" />
                                    <button type="button" 
                                            class="btn btn-outline-secondary" 
                                            @onclick="TogglePasswordVisibility"
                                            title="@(showPassword ? "Hide Password" : "Show Password")">
                                        <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                    </button>
                                </div>
                                <ValidationMessage For="@(() => credentialModel.SAPPassword)" />
                                <div class="form-text">
                                    <i class="fas fa-shield-alt text-success me-1"></i>
                                    Password will be encrypted and securely stored in Azure Key Vault.
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Advanced Connection Properties -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cog me-2"></i>Advanced Connection Properties
                        </h6>
                        
                        @if (credentialModel.DatabaseType == DatabaseType.HANA)
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="currentSchema" class="form-label">
                                            Current Schema <span class="text-danger">*</span>
                                        </label>
                                        <InputText @bind-Value="credentialModel.CurrentSchema" 
                                                 @bind-Value:after="OnCriticalFieldChanged"
                                                 class="form-control" 
                                                 id="currentSchema" 
                                                 placeholder="e.g., SBODEMOUS" />
                                        <ValidationMessage For="@(() => credentialModel.CurrentSchema)" />
                                        <div class="form-text">Default schema for HANA connection (required)</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <InputCheckbox @bind-Value="credentialModel.Encrypt" 
                                                         class="form-check-input" 
                                                         id="encrypt" />
                                            <label class="form-check-label" for="encrypt">
                                                Enable Encryption
                                            </label>
                                        </div>
                                        <div class="mb-2"></div>
                                        <div class="form-check form-switch">
                                            <InputCheckbox @bind-Value="credentialModel.SSLValidateCertificate" 
                                                         class="form-check-input" 
                                                         id="sslValidate" />
                                            <label class="form-check-label" for="sslValidate">
                                                Validate SSL Certificate
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        
                        @if (credentialModel.DatabaseType == DatabaseType.MSSQL)
                        {
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <InputCheckbox @bind-Value="credentialModel.TrustServerCertificate" 
                                                 class="form-check-input" 
                                                 id="trustCert" />
                                    <label class="form-check-label" for="trustCert">
                                        Trust Server Certificate
                                    </label>
                                    <div class="form-text">Recommended for self-signed certificates</div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- SAP Configuration (Mandatory Database-Level) -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cubes me-2"></i>SAP Configuration (Mandatory - Database Level)
                        </h6>
                        <div class="alert alert-warning border-0 mb-3">
                            <small>
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>Required:</strong> Configure database-specific SAP settings. All fields are mandatory for proper integration.
                            </small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sapServiceLayerHostname" class="form-label">
                                        SAP Service Layer Hostname <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="credentialModel.SAPServiceLayerHostname" 
                                             class="form-control" 
                                             id="sapServiceLayerHostname" 
                                             placeholder="e.g., sap-server.company.com" />
                                    <ValidationMessage For="@(() => credentialModel.SAPServiceLayerHostname)" />
                                    <div class="form-text">Database-specific SAP Service Layer hostname (required)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sapAPIGatewayHostname" class="form-label">
                                        SAP API Gateway Hostname <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="credentialModel.SAPAPIGatewayHostname" 
                                             class="form-control" 
                                             id="sapAPIGatewayHostname" 
                                             placeholder="e.g., sap-gateway.company.com" />
                                    <ValidationMessage For="@(() => credentialModel.SAPAPIGatewayHostname)" />
                                    <div class="form-text">Database-specific SAP API Gateway hostname (required)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sapWebClientHost" class="form-label">
                                        SAP Business One Web Client Host <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="credentialModel.SAPBusinessOneWebClientHost" 
                                             class="form-control" 
                                             id="sapWebClientHost" 
                                             placeholder="e.g., sap-webclient.company.com" />
                                    <ValidationMessage For="@(() => credentialModel.SAPBusinessOneWebClientHost)" />
                                    <div class="form-text">Database-specific SAP Business One Web Client host (required)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="documentCodeDb" class="form-label">
                                        Document Code <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="credentialModel.DocumentCode" 
                                             class="form-control" 
                                             id="documentCodeDb" 
                                             placeholder="e.g., INV, SO, PO" />
                                    <ValidationMessage For="@(() => credentialModel.DocumentCode)" />
                                    <div class="form-text">Database-specific document code (required)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">
                            Description (Optional)
                        </label>
                        <InputTextArea @bind-Value="credentialModel.Description" 
                                     class="form-control" 
                                     id="description" 
                                     rows="3"
                                     placeholder="Optional description for these database credentials..." />
                        <ValidationMessage For="@(() => credentialModel.Description)" />
                    </div>

                    <div class="form-check">
                        <InputCheckbox @bind-Value="credentialModel.IsActive" 
                                     class="form-check-input" 
                                     id="isActive" />
                        <label class="form-check-label" for="isActive">
                            Active
                        </label>
                        <div class="form-text">Only active credentials can be used by users.</div>
                        
                    </div>
                    
                    <!-- Connection Test Results for Both Create and Edit Mode -->
                    @if (connectionTested)
                    {
                            <div class="mt-3">
                                @if (connectionTestSuccess)
                                {
                                    <div class="alert alert-success border-0 mb-0">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            <div class="flex-grow-1">
                                                <strong>Connection Test Successful!</strong>
                                                <br>
                                                <small>@connectionTestMessage</small>
                                                @if (!string.IsNullOrEmpty(connectionTestDetails))
                                                {
                                                    <br><small class="text-muted">@connectionTestDetails</small>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-danger border-0 mb-0">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-times-circle text-danger me-2"></i>
                                            <div class="flex-grow-1">
                                                <strong>Connection Test Failed</strong>
                                                <br>
                                                <small>@connectionTestMessage</small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    
                    @if (!isEditMode)
                    {
                        <!-- Create Mode: Show Test Connection first, then Create Connection -->
                        <button type="button" class="btn btn-warning" 
                                @onclick="TestConnection" 
                                disabled="@isTestingConnection"
                                style="@(!connectionTested || !connectionTestSuccess ? "display: inline-block;" : "display: none;")">
                            @if (isTestingConnection)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <text>Testing...</text>
                            }
                            else
                            {
                                <i class="fas fa-plug me-1"></i>
                                <text>Test Connection</text>
                            }
                        </button>
                        
                        <button type="submit" class="btn btn-primary" disabled="@(isSaving || !connectionTested || !connectionTestSuccess)">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="fas fa-save me-1"></i>
                            Create Connection
                        </button>
                    }
                    else
                    {
                        <!-- Edit Mode: Test Connection and Update buttons -->
                        <button type="button" class="btn btn-warning me-2" 
                                @onclick="TestConnection" 
                                disabled="@isTestingConnection">
                            @if (isTestingConnection)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <text>Testing...</text>
                            }
                            else
                            {
                                <i class="fas fa-plug me-1"></i>
                                <text>Test Connection</text>
                            }
                        </button>
                        
                        <button type="submit" class="btn btn-primary" disabled="@(isSaving || !connectionTested || !connectionTestSuccess)">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="fas fa-save me-1"></i>
                            Update Credentials
                        </button>
                    }
                </div>
            </EditForm>
        </div>
    </div>
</div>

<!-- Update Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>Update Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <EditForm Model="passwordModel" OnValidSubmit="UpdatePassword">
                <DataAnnotationsValidator />
                <div class="modal-body">
                    @if (selectedCredential != null)
                    {
                        <div class="mb-3">
                            <label class="form-label"><strong>Database Credential:</strong></label>
                            <div class="form-control bg-light">@selectedCredential.FriendlyName</div>
                            <div class="form-text">@selectedCredential.ServerInstance - @selectedCredential.DatabaseName</div>
                        </div>
                    }
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">
                            New SAP Password <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <InputText @bind-Value="passwordModel.NewPassword" 
                                     type="@(showNewPassword ? "text" : "password")"
                                     class="form-control" 
                                     id="newPassword" 
                                     placeholder="@(showNewPassword ? "Enter new SAP password" : "••••••••••••••••")" />
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    @onclick="ToggleNewPasswordVisibility"
                                    title="@(showNewPassword ? "Hide Password" : "Show Password")">
                                <i class="fas @(showNewPassword ? "fa-eye-slash" : "fa-eye")"></i>
                            </button>
                        </div>
                        <ValidationMessage For="@(() => passwordModel.NewPassword)" />
                        <div class="form-text">
                            <i class="fas fa-shield-alt text-success me-1"></i>
                            Password will be encrypted and securely stored in Azure Key Vault.
                        </div>
                    </div>

                    <div class="alert alert-warning border-0">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>Important:</strong> Updating the password will affect all users in your organization using these credentials.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" disabled="@isUpdatingPassword">
                        @if (isUpdatingPassword)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Update Password
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-trash me-2"></i>Delete Database Credentials
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <EditForm Model="deleteModel" OnValidSubmit="DeleteCredential">
                <div class="modal-body">
                    @if (selectedCredential != null)
                    {
                        <div class="alert alert-danger border-0">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Confirm Complete Deletion</h6>
                            <p class="mb-2">
                                Are you sure you want to <strong>permanently delete</strong> the database credentials 
                                <strong>"@selectedCredential.FriendlyName"</strong>?
                            </p>
                            <div class="small text-muted">
                                <strong>This action will:</strong>
                                <ul class="mb-0 ms-3">
                                    <li>Remove credentials from the database</li>
                                    <li>Delete all associated secrets from Azure Key Vault</li>
                                    <li>Remove from the application interface</li>
                                </ul>
                                <div class="mt-2 text-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>This action cannot be undone!</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Database Credential Details:</strong></label>
                            <div class="card bg-light border-0">
                                <div class="card-body py-2">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Server:</small><br>
                                            <strong>@selectedCredential.ServerInstance</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Database:</small><br>
                                            <strong>@selectedCredential.DatabaseName</strong>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">SAP Username:</small><br>
                                            <strong>@selectedCredential.SAPUsername</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Database Type:</small><br>
                                            <strong>@selectedCredential.DatabaseType</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning border-0">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Note:</strong> This action will deactivate the credentials. The password will remain in Key Vault for security auditing purposes, but users will no longer be able to use these credentials.
                            </small>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        <i class="fas fa-trash me-1"></i>
                        Delete Credentials
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private List<DatabaseCredential> credentials = new();
    private DatabaseCredentialModel credentialModel = new();
    private PasswordUpdateModel passwordModel = new();
    private DeleteConfirmationModel deleteModel = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isRefreshing = false;
    private bool isEditMode = false;
    private bool showPassword = false;
    private bool showDatabasePassword = false;
    private bool showNewPassword = false;
    private bool isUpdatingPassword = false;
    private bool isDeleting = false;
    private Guid? editingCredentialId;
    private Guid currentUserOrgId;
    private UserRole currentUserRole = UserRole.User;
    private DatabaseCredential? selectedCredential;
    
    // Connection testing state
    private bool isTestingConnection = false;
    private bool connectionTested = false;
    private bool connectionTestSuccess = false;
    private string? connectionTestMessage = string.Empty;
    private string? connectionTestDetails = string.Empty;

    // Property to handle database type changes
    private DatabaseType? SelectedDatabaseType 
    { 
        get => credentialModel.DatabaseType; 
        set 
        { 
            credentialModel.DatabaseType = value;
            OnDatabaseTypeChanged();
        } 
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get current user role and organization
            currentUserRole = DataIsolationService.GetCurrentUserRole();
            
            var currentUserOrgIdStr = await DataIsolationService.GetCurrentUserOrganizationIdAsync();
            if (string.IsNullOrEmpty(currentUserOrgIdStr))
            {
                errorMessage = "Unable to determine your organization. Please contact support.";
                return;
            }

            // Try to parse as GUID, otherwise generate one from the string
            if (!Guid.TryParse(currentUserOrgIdStr, out currentUserOrgId))
            {
                // For domain-based organization IDs, generate a deterministic GUID
                var orgIdBytes = System.Text.Encoding.UTF8.GetBytes(currentUserOrgIdStr);
                var hash = System.Security.Cryptography.MD5.HashData(orgIdBytes);
                currentUserOrgId = new Guid(hash);
                
                Logger.LogInformation("Generated GUID {GeneratedGuid} from organization ID string {OrgIdString}", 
                    currentUserOrgId, currentUserOrgIdStr);
            }
            await LoadCredentials();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing database credentials page");
            errorMessage = "Error loading page. Please refresh and try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadCredentials()
    {
        try
        {
            credentials = await DatabaseCredentialService.GetByOrganizationAsync(currentUserOrgId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading database credentials for organization {OrganizationId}", currentUserOrgId);
            errorMessage = "Error loading database credentials. Please try again.";
        }
    }

    private async Task RefreshCredentials()
    {
        if (isRefreshing) return;

        isRefreshing = true;
        ClearMessages();

        try
        {
            Logger.LogInformation("Refreshing database credentials for organization {OrganizationId}", currentUserOrgId);
            await LoadCredentials();
            successMessage = "Database credentials refreshed successfully.";
            Logger.LogInformation("Successfully refreshed database credentials for organization {OrganizationId}", currentUserOrgId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing database credentials for organization {OrganizationId}", currentUserOrgId);
            errorMessage = "Failed to refresh database credentials. Please try again.";
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();
        }
    }

    private async Task ShowCreateModal()
    {
        try
        {
            isEditMode = false;
            editingCredentialId = null;
            credentialModel = new DatabaseCredentialModel();
            showPassword = false;
            showDatabasePassword = false;
            
            // Reset connection test state
            ResetConnectionTestState("create modal opened");
            
            ClearMessages();
            StateHasChanged();
            await Task.Delay(10); // Allow UI to update
            await JSRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('credentialModal')).show()");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error showing create modal");
            errorMessage = "Error opening the modal. Please refresh the page and try again.";
            StateHasChanged();
        }
    }

    private async Task ShowEditModal(DatabaseCredential credential)
    {
        try
        {
            Logger.LogInformation("ShowEditModal called for credential {CredentialId} in organization {OrganizationId}", credential.Id, credential.OrganizationId);
            isEditMode = true;
            editingCredentialId = credential.Id;
            credentialModel = new DatabaseCredentialModel
            {
                DatabaseType = credential.DatabaseType,
                ServerInstance = credential.ServerInstance,
                InstanceName = credential.InstanceName,
                DatabaseName = credential.DatabaseName,
                FriendlyName = credential.FriendlyName,
                DatabaseUsername = credential.DatabaseUsername,
                SAPUsername = credential.SAPUsername,
                Description = credential.Description,
                IsActive = credential.IsActive,
                Port = credential.Port,
                CurrentSchema = credential.CurrentSchema,
                Encrypt = credential.Encrypt,
                SSLValidateCertificate = credential.SSLValidateCertificate,
                TrustServerCertificate = credential.TrustServerCertificate,
                DatabasePassword = string.Empty, // Don't populate password for security
                SAPPassword = string.Empty, // Don't populate password for security
                
                // SAP Configuration (database-level)
                SAPServiceLayerHostname = credential.SAPServiceLayerHostname,
                SAPAPIGatewayHostname = credential.SAPAPIGatewayHostname,
                SAPBusinessOneWebClientHost = credential.SAPBusinessOneWebClientHost,
                DocumentCode = credential.DocumentCode
            };
            showPassword = false;
            showDatabasePassword = false;
            
            // Reset connection test state for edit mode
            ResetConnectionTestState("edit modal opened");
            
            ClearMessages();
            StateHasChanged();
            await Task.Delay(10); // Allow UI to update
            await JSRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('credentialModal')).show()");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error showing edit modal for credential {CredentialId}", credential?.Id);
            errorMessage = "Error opening the edit modal. Please refresh the page and try again.";
            StateHasChanged();
        }
    }

    private async Task TestConnection()
    {
        if (isTestingConnection) return;

        try
        {
            ClearMessages();
            isTestingConnection = true;
            connectionTested = false;
            connectionTestSuccess = false;
            connectionTestMessage = string.Empty;
            connectionTestDetails = string.Empty;
            StateHasChanged();

            // Validate required fields for connection testing
            if (credentialModel.DatabaseType == null)
            {
                errorMessage = "Please select a database type before testing connection.";
                return;
            }

            if (string.IsNullOrEmpty(credentialModel.ServerInstance))
            {
                errorMessage = "Please enter server instance before testing connection.";
                return;
            }

            if (string.IsNullOrEmpty(credentialModel.DatabaseName))
            {
                errorMessage = "Please enter database name before testing connection.";
                return;
            }

            if (string.IsNullOrEmpty(credentialModel.DatabaseUsername))
            {
                errorMessage = "Please enter database username before testing connection.";
                return;
            }

            if (string.IsNullOrEmpty(credentialModel.DatabasePassword))
            {
                errorMessage = "Please enter database password before testing connection.";
                return;
            }

            Logger.LogInformation("Testing connection for {DatabaseType} - {Server}/{Database}", 
                credentialModel.DatabaseType, credentialModel.ServerInstance, credentialModel.DatabaseName);

            var result = await DatabaseCredentialService.TestConnectionBeforeCreateAsync(credentialModel);
            
            connectionTested = true;
            connectionTestSuccess = result.Success;

            if (result.Success)
            {
                connectionTestMessage = result.Message ?? "Connection successful";
                if (!string.IsNullOrEmpty(result.ServerInfo))
                {
                    connectionTestDetails = result.ServerInfo;
                }
                if (!string.IsNullOrEmpty(result.DatabaseVersion))
                {
                    connectionTestDetails += string.IsNullOrEmpty(connectionTestDetails) ? 
                        result.DatabaseVersion : $" | {result.DatabaseVersion}";
                }
                successMessage = $"Connection test successful! Response time: {result.ResponseTime.TotalMilliseconds:F0}ms";
            }
            else
            {
                connectionTestMessage = result.ErrorMessage ?? "Connection failed";
                errorMessage = $"Connection test failed: {result.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error testing database connection");
            connectionTested = true;
            connectionTestSuccess = false;
            connectionTestMessage = ex.Message;
            errorMessage = $"Connection test error: {ex.Message}";
        }
        finally
        {
            isTestingConnection = false;
            StateHasChanged();
        }
    }

    private bool ValidateForm()
    {
        // Custom validation for edit mode to allow general settings updates without passwords
        if (isEditMode)
        {
            // For edit mode, validate only non-password fields
            var errors = new List<string>();
            
            if (string.IsNullOrWhiteSpace(credentialModel.FriendlyName))
                errors.Add("Friendly name is required.");
                
            if (credentialModel.DatabaseType == null)
                errors.Add("Database type is required.");
                
            if (string.IsNullOrWhiteSpace(credentialModel.ServerInstance))
                errors.Add("Server instance is required.");
                
            if (string.IsNullOrWhiteSpace(credentialModel.DatabaseName))
                errors.Add("Database name is required.");
                
            if (string.IsNullOrWhiteSpace(credentialModel.DatabaseUsername))
                errors.Add("Database username is required.");
                
            if (string.IsNullOrWhiteSpace(credentialModel.SAPUsername))
                errors.Add("SAP username is required.");
            
            if (errors.Any())
            {
                errorMessage = string.Join(" ", errors);
                return false;
            }
            
            return true;
        }
        
        // For create mode, use standard validation (handled by DataAnnotationsValidator)
        return true;
    }

    private async Task SaveCredential(EditContext editContext)
    {
        if (isSaving) return;

        try
        {
            ClearMessages();
            isSaving = true;
            
            // For create mode, use standard validation
            if (!isEditMode)
            {
                if (!editContext.Validate())
                {
                    errorMessage = "Please correct the validation errors above.";
                    return;
                }
            }
            // For edit mode, use custom validation
            else if (!ValidateForm())
            {
                return;
            }

            // For both create and edit operations, require successful connection test
            if (!connectionTested || !connectionTestSuccess)
            {
                if (isEditMode)
                {
                    errorMessage = "Please test the connection successfully before updating credentials.";
                }
                else
                {
                    errorMessage = "Please test the connection successfully before creating credentials.";
                }
                return;
            }
            
            // For create operations, require SAP password
            if (!isEditMode)
            {
                if (string.IsNullOrEmpty(credentialModel.SAPPassword))
                {
                    errorMessage = "SAP password is required when creating new credentials.";
                    return;
                }
            }
            // For edit operations, validate password requirement only if provided
            else if (isEditMode && string.IsNullOrEmpty(credentialModel.SAPPassword))
            {
                // Password is optional for edit operations - clear validation errors
                // Remove database password requirement for general settings updates
                if (string.IsNullOrEmpty(credentialModel.DatabasePassword))
                {
                    // For general settings update, we don't need passwords
                    credentialModel.DatabasePassword = "***UNCHANGED***"; // Placeholder to pass validation
                    credentialModel.SAPPassword = "***UNCHANGED***"; // Placeholder to pass validation
                }
            }

            var currentUserId = Guid.NewGuid(); // TODO: Get actual current user ID from claims

            if (isEditMode && editingCredentialId.HasValue)
            {
                Logger.LogInformation("Updating credential {CredentialId} for organization {OrganizationId}", editingCredentialId.Value, currentUserOrgId);
                
                // Check if only general settings are being changed (no password provided or placeholder values)
                bool isGeneralSettingsOnly = (string.IsNullOrEmpty(credentialModel.SAPPassword) || credentialModel.SAPPassword == "***UNCHANGED***") && 
                                            (string.IsNullOrEmpty(credentialModel.DatabasePassword) || credentialModel.DatabasePassword == "***UNCHANGED***");
                
                if (isGeneralSettingsOnly)
                {
                    // Use UpdateGeneralSettingsAsync for non-password changes
                    Logger.LogInformation("Using UpdateGeneralSettingsAsync for non-password changes");
                    var generalSettingsModel = new DatabaseCredentialGeneralSettingsModel
                    {
                        FriendlyName = credentialModel.FriendlyName,
                        Description = credentialModel.Description,
                        IsActive = credentialModel.IsActive,
                        SAPUsername = credentialModel.SAPUsername,
                        DatabaseUsername = credentialModel.DatabaseUsername,
                        ServerInstance = credentialModel.ServerInstance,
                        InstanceName = credentialModel.InstanceName,
                        DatabaseName = credentialModel.DatabaseName,
                        Port = credentialModel.Port,
                        CurrentSchema = credentialModel.CurrentSchema,
                        Encrypt = credentialModel.Encrypt,
                        SSLValidateCertificate = credentialModel.SSLValidateCertificate,
                        TrustServerCertificate = credentialModel.TrustServerCertificate,
                        
                        // SAP Configuration (database-level)
                        SAPServiceLayerHostname = credentialModel.SAPServiceLayerHostname,
                        SAPAPIGatewayHostname = credentialModel.SAPAPIGatewayHostname,
                        SAPBusinessOneWebClientHost = credentialModel.SAPBusinessOneWebClientHost,
                        DocumentCode = credentialModel.DocumentCode
                    };
                    
                    var updateResult = await DatabaseCredentialService.UpdateGeneralSettingsAsync(
                        editingCredentialId.Value, 
                        generalSettingsModel, 
                        currentUserOrgId, 
                        currentUserId);
                        
                    if (!updateResult)
                    {
                        errorMessage = "Failed to update general settings.";
                        return;
                    }
                    
                    successMessage = "General settings updated successfully.";
                }
                else
                {
                    // Use full UpdateAsync for password changes
                    Logger.LogInformation("Using UpdateAsync for password changes");
                    await DatabaseCredentialService.UpdateAsync(editingCredentialId.Value, credentialModel, currentUserId);
                    successMessage = "Database credentials updated successfully.";
                }
            }
            else
            {
                await DatabaseCredentialService.CreateAsync(currentUserOrgId, credentialModel, currentUserId);
                successMessage = "Database credentials created successfully.";
            }

            await LoadCredentials();
            await JSRuntime.InvokeVoidAsync("eval", "bootstrap.Modal.getInstance(document.getElementById('credentialModal'))?.hide()");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving database credentials");
            errorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }


    private async Task ShowPasswordModal(DatabaseCredential credential)
    {
        try
        {
            if (currentUserRole == UserRole.SuperAdmin)
            {
                errorMessage = "Super Admins cannot access password secrets for security and compliance reasons.";
                StateHasChanged();
                return;
            }
            
            selectedCredential = credential;
            passwordModel = new PasswordUpdateModel();
            showNewPassword = false;
            ClearMessages();
            StateHasChanged();
            await Task.Delay(10); // Allow UI to update
            await JSRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('passwordModal')).show()");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error showing password modal for credential {CredentialId}", credential?.Id);
            errorMessage = "Error opening password update modal. Please try again.";
            StateHasChanged();
        }
    }


    private async Task ShowDeleteModal(DatabaseCredential credential)
    {
        try
        {
            selectedCredential = credential;
            deleteModel = new DeleteConfirmationModel();
            ClearMessages();
            StateHasChanged();
            await Task.Delay(10); // Allow UI to update
            await JSRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('deleteModal')).show()");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error showing delete modal for credential {CredentialId}", credential?.Id);
            errorMessage = "Error opening delete confirmation modal. Please try again.";
            StateHasChanged();
        }
    }

    private async Task DeleteCredential()
    {
        if (isDeleting || selectedCredential == null) return;

        try
        {
            ClearMessages();
            isDeleting = true;

            var success = await DatabaseCredentialService.HardDeleteAsync(selectedCredential.Id, currentUserOrgId);

            if (success)
            {
                successMessage = $"Database credentials '{selectedCredential.FriendlyName}' have been permanently deleted from the database, Key Vault, and application.";
                await LoadCredentials();
                await JSRuntime.InvokeVoidAsync("eval", "bootstrap.Modal.getInstance(document.getElementById('deleteModal'))?.hide()");
            }
            else
            {
                errorMessage = "Failed to delete the database credentials. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting credential {CredentialId}", selectedCredential?.Id);
            errorMessage = ex.Message;
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private void TogglePasswordVisibility()
    {
        try
        {
            showPassword = !showPassword;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling password visibility");
            // Don't show error message for this as it's a minor UI interaction
        }
    }

    private void ToggleDatabasePasswordVisibility()
    {
        try
        {
            showDatabasePassword = !showDatabasePassword;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling database password visibility");
            // Don't show error message for this as it's a minor UI interaction
        }
    }

    private void ToggleNewPasswordVisibility()
    {
        try
        {
            showNewPassword = !showNewPassword;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling new password visibility");
            // Don't show error message for this as it's a minor UI interaction
        }
    }

    private async Task UpdatePassword()
    {
        if (isUpdatingPassword || selectedCredential == null) return;

        try
        {
            ClearMessages();
            isUpdatingPassword = true;

            var currentUserId = Guid.NewGuid(); // TODO: Get actual current user ID from claims
            
            var success = await DatabaseCredentialService.UpdateSAPPasswordAsync(
                selectedCredential.Id, 
                passwordModel.NewPassword, 
                currentUserOrgId, 
                currentUserId);

            if (success)
            {
                successMessage = $"Password updated successfully for {selectedCredential.FriendlyName}.";
                await LoadCredentials();
                await JSRuntime.InvokeVoidAsync("eval", "bootstrap.Modal.getInstance(document.getElementById('passwordModal'))?.hide()");
            }
            else
            {
                errorMessage = "Failed to update password. Please check that the Key Vault is accessible and try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating password for credential {CredentialId}", selectedCredential?.Id);
            errorMessage = ex.Message;
        }
        finally
        {
            isUpdatingPassword = false;
            StateHasChanged();
        }
    }

    private void ClearMessages()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    // Model for password update form
    public class PasswordUpdateModel
    {
        [Required(ErrorMessage = "New password is required")]
        [StringLength(255, MinimumLength = 1, ErrorMessage = "Password must be between 1 and 255 characters")]
        public string NewPassword { get; set; } = string.Empty;
    }

    // Model for delete confirmation form
    public class DeleteConfirmationModel
    {
        // This model is just for form validation purposes - no actual properties needed
    }
    
    private void OnDatabaseTypeChanged()
    {
        Logger.LogInformation("Database type changed to: {DatabaseType}", credentialModel.DatabaseType);
        
        // Reset connection test state when database type changes
        ResetConnectionTestState("database type change");
        
        // Force UI refresh when database type changes to show/hide appropriate fields
        StateHasChanged();
    }

    private void OnCriticalFieldChanged()
    {
        // Reset connection test state when any critical connection field changes
        ResetConnectionTestState("critical field change");
        StateHasChanged();
    }

    private void ResetConnectionTestState(string reason)
    {
        Logger.LogInformation("Resetting connection test state due to: {Reason}", reason);
        
        isTestingConnection = false;
        connectionTested = false;
        connectionTestSuccess = false;
        connectionTestMessage = string.Empty;
        connectionTestDetails = string.Empty;
    }
}

<script>
    window.refreshModal = function() {
        // Force Bootstrap to recalculate modal position after content changes
        var modal = document.getElementById('credentialModal');
        if (modal) {
            var modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.handleUpdate();
            }
        }
    };
</script>