@page "/admin/secrets"
@page "/secrets"
@rendermode InteractiveServer
@using AdminConsole.Models
@using AdminConsole.Services
@using System.Security.Cryptography
@inject IKeyVaultService KeyVaultService
@inject IDatabaseCredentialService DatabaseCredentialService
@inject IDataIsolationService DataIsolationService
@inject IOrganizationService OrganizationService
@inject ILogger<ManageSecrets> Logger
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@attribute [Authorize(Policy = "OrgAdminOrHigher")]

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">My Secrets</h2>
                    <p class="text-muted mb-0">Manage Key Vault secrets and other sensitive data for your organization</p>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    @if (currentUserRole == UserRole.SuperAdmin)
                    {
                        <button type="button" class="btn btn-success btn-responsive" @onclick="ShowCreateSecretModal">
                            <i class="fas fa-plus me-1"></i>
                            <span class="d-none d-sm-inline">Create Secret</span>
                        </button>
                    }
                    <a href="/admin/database-credentials" class="btn btn-primary btn-responsive">
                        <i class="fas fa-database me-1"></i>
                        <span class="d-none d-md-inline">Database Credentials</span>
                        <span class="d-md-none d-none d-sm-inline">DB Creds</span>
                    </a>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error:</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Success:</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="ClearMessages"></button>
                </div>
            }

            @if (currentUserRole == UserRole.SuperAdmin)
            {
                <div class="alert alert-warning" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-shield-alt me-2"></i>
                        Super Admin Security Notice
                    </h6>
                    <p class="mb-0">
                        As a Super Admin, you can view secret names and manage metadata but cannot access secret values 
                        for security and compliance reasons. Organization Admins have full access to their secrets.
                    </p>
                </div>
            }

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading secrets...</p>
                </div>
            }
            else
            {
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">@secretNames.Count()</h5>
                                        <p class="card-text mb-0">Total Secrets</p>
                                    </div>
                                    <i class="fas fa-key fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">@databaseCredentials.Count</h5>
                                        <p class="card-text mb-0">Database Credentials</p>
                                    </div>
                                    <i class="fas fa-database fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @if (!databaseCredentials.Any() && !secretNames.Any())
                {
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-key fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Secrets Found</h5>
                            <p class="text-muted mb-3">
                                You haven't created any secrets yet. Create database connections or other secrets 
                                to securely store sensitive information for your organization.
                            </p>
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="/admin/database-credentials" class="btn btn-primary">
                                    <i class="fas fa-database me-1"></i>
                                    Database Credentials
                                </a>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    @if (databaseCredentials.Any())
                    {
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-database me-2"></i>
                                    Database Credentials (@databaseCredentials.Count)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    @foreach (var credential in databaseCredentials)
                                    {
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="card border">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <h6 class="card-title mb-0">@credential.FriendlyName</h6>
                                                        <span class="badge @(credential.IsActive ? "bg-success" : "bg-secondary")">
                                                            @(credential.IsActive ? "Active" : "Inactive")
                                                        </span>
                                                    </div>
                                                    <p class="card-text small text-muted mb-2">
                                                        <strong>Type:</strong> @credential.DatabaseType<br>
                                                        <strong>Database:</strong> @credential.DatabaseName<br>
                                                        <strong>Server:</strong> @credential.ServerInstance
                                                    </p>
                                                    @if (!string.IsNullOrEmpty(credential.Description))
                                                    {
                                                        <p class="card-text small">@credential.Description</p>
                                                    }
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="small text-muted">
                                                            @credential.CreatedOn.ToString("MMM dd, yyyy")
                                                        </span>
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                                <i class="fas fa-ellipsis-v"></i>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li>
                                                                    <button class="dropdown-item" @onclick="() => ViewCredentialDetails(credential)">
                                                                        <i class="fas fa-eye me-2"></i>View Details
                                                                    </button>
                                                                </li>
                                                                @if (currentUserRole != UserRole.SuperAdmin)
                                                                {
                                                                    <li>
                                                                        <button class="dropdown-item" @onclick="() => TestCredentialConnection(credential.Id)">
                                                                            <i class="fas fa-plug me-2"></i>Test Connection
                                                                        </button>
                                                                    </li>
                                                                }
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li>
                                                                    <button class="dropdown-item text-danger" @onclick="() => ShowDeleteCredentialModal(credential)">
                                                                        <i class="fas fa-trash me-2"></i>Delete
                                                                    </button>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="text-end">
                                    <a href="/admin/database-credentials" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-cog me-1"></i>
                                        Manage All Database Credentials
                                    </a>
                                </div>
                            </div>
                        </div>
                    }

                    @if (secretNames.Any())
                    {
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-key me-2"></i>
                                    Other Secrets (@secretNames.Count())
                                </h5>
                            </div>
                            <div class="card-body">
                                @if (currentUserRole == UserRole.SuperAdmin)
                                {
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Secret values are hidden for Super Admins for compliance reasons.
                                    </div>
                                }
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Secret Name</th>
                                                <th>Type</th>
                                                <th>Created</th>
                                                @if (currentUserRole != UserRole.SuperAdmin)
                                                {
                                                    <th>Actions</th>
                                                }
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var secretName in secretNames.Where(s => !IsSystemSecret(s)))
                                            {
                                                <tr>
                                                    <td>
                                                        <i class="fas fa-key text-muted me-2"></i>
                                                        @secretName
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">Custom Secret</span>
                                                    </td>
                                                    <td>
                                                        <span class="text-muted">Recently</span>
                                                    </td>
                                                    @if (currentUserRole != UserRole.SuperAdmin)
                                                    {
                                                        <td>
                                                            <div class="dropdown">
                                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                                        data-bs-toggle="dropdown" aria-expanded="false">
                                                                    Actions
                                                                </button>
                                                                <ul class="dropdown-menu">
                                                                    <li>
                                                                        <button class="dropdown-item" @onclick="() => ViewSecretValue(secretName)">
                                                                            <i class="fas fa-eye me-2"></i>View Value
                                                                        </button>
                                                                    </li>
                                                                    @* Disabled delete functionality for security reasons
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li>
                                                                        <button class="dropdown-item text-danger" @onclick="() => ShowDeleteSecretModal(secretName)">
                                                                            <i class="fas fa-trash me-2"></i>Delete
                                                                        </button>
                                                                    </li>
                                                                    *@
                                                                </ul>
                                                            </div>
                                                        </td>
                                                    }
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                }
            }
        </div>
    </div>
</div>

<!-- View Secret Value Modal -->
@if (showSecretValueModal)
{
    <div class="modal-backdrop fade show" style="z-index: 1040;"></div>
    <div class="modal fade show d-block" tabindex="-1" style="z-index: 1050;" @onclick="HandleBackdropClick">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h4 class="modal-title text-info">
                        <i class="fas fa-eye me-2"></i> 
                        Secret Value: @currentSecretName
                    </h4>
                    <button type="button" class="btn-close" @onclick="CloseSecretValueModal" @onclick:stopPropagation="true" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <div class="alert alert-warning border-0">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Security Notice:</h6>
                        <p class="mb-0 small">
                            This secret value is sensitive. Do not share it or expose it in logs, screenshots, or unsecured communications.
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Secret Name:</strong></label>
                        <div class="form-control bg-light">@currentSecretName</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Secret Value:</strong></label>
                        <div class="input-group">
                            <textarea class="form-control font-monospace" rows="4" readonly>@currentSecretValue</textarea>
                            <button type="button" class="btn btn-outline-secondary" @onclick="CopySecretToClipboard" title="Copy to clipboard">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Secret retrieved from Azure Key Vault with organization isolation.
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-primary" @onclick="EditSecretValue" @onclick:stopPropagation="true">
                        <i class="fas fa-edit me-2"></i>Edit Secret
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseSecretValueModal" @onclick:stopPropagation="true">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Edit Secret Modal -->
@if (showEditSecretModal)
{
    <div class="modal-backdrop fade show" style="z-index: 1040;"></div>
    <div class="modal fade show d-block" tabindex="-1" style="z-index: 1050;" @onclick="HandleBackdropClick">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h4 class="modal-title text-warning">
                        <i class="fas fa-edit me-2"></i> 
                        Edit Secret: @currentSecretName
                    </h4>
                    <button type="button" class="btn-close" @onclick="CloseEditSecretModal" @onclick:stopPropagation="true" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <EditForm Model="editSecretModel" OnValidSubmit="SaveSecretChanges">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Secret Name:</strong></label>
                            <div class="form-control bg-light">@currentSecretName</div>
                            <div class="form-text">Secret names cannot be changed after creation.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="secretValue" class="form-label"><strong>Secret Value:</strong> <span class="text-danger">*</span></label>
                            <InputTextArea @bind-Value="editSecretModel.SecretValue" class="form-control font-monospace" id="secretValue" rows="4" 
                                         placeholder="Enter the new secret value..." />
                            <ValidationMessage For="@(() => editSecretModel.SecretValue)" class="text-danger" />
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                The secret will be encrypted and stored securely in Azure Key Vault.
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @onclick="CloseEditSecretModal" disabled="@isUpdatingSecret">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-warning" disabled="@isUpdatingSecret">
                                @if (isUpdatingSecret)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Updating...</span>
                                }
                                else
                                {
                                    <i class="fas fa-save me-1"></i>
                                    <span>Update Secret</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@* Delete Secret Modal - Disabled for security reasons
@if (false)
{
    <div class="modal-backdrop fade show" style="z-index: 1040;"></div>
    <div class="modal fade show d-block" tabindex="-1" style="z-index: 1050;" @onclick="HandleBackdropClick">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h4 class="modal-title text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> 
                        Delete Secret
                    </h4>
                    <button type="button" class="btn-close" @onclick="() => {}" @onclick:stopPropagation="true" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <div class="alert alert-danger border-0">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Warning:</h6>
                        <p class="mb-0">
                            This action cannot be undone. The secret <strong>@currentSecretName</strong> will be permanently deleted from Azure Key Vault.
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <p>Are you sure you want to delete the secret <strong>@currentSecretName</strong>?</p>
                        <ul class="small text-muted">
                            <li>Applications using this secret will lose access</li>
                            <li>The secret value cannot be recovered</li>
                            <li>This action requires Organization Admin privileges</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary" @onclick="() => {}" disabled="@isDeletingSecret">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteSecretConfirmed" disabled="@isDeletingSecret">
                        @if (isDeletingSecret)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <i class="fas fa-trash me-1"></i>
                            <span>Delete Secret</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}
*@

<!-- Create New Secret Modal -->
@if (showCreateSecretModal)
{
    <div class="modal-backdrop fade show" style="z-index: 1040;"></div>
    <div class="modal fade show d-block" tabindex="-1" style="z-index: 1050;" @onclick="HandleBackdropClick">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h4 class="modal-title text-success">
                        <i class="fas fa-plus me-2"></i> 
                        Create New Secret
                    </h4>
                    <button type="button" class="btn-close" @onclick="CloseCreateSecretModal" @onclick:stopPropagation="true" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-0">
                    <EditForm Model="createSecretModel" OnValidSubmit="CreateNewSecret">
                        <DataAnnotationsValidator />
                        
                        <div class="alert alert-info border-0">
                            <h6><i class="fas fa-info-circle me-2"></i>Secret Creation:</h6>
                            <p class="mb-0 small">
                                Secrets are stored securely in Azure Key Vault with organization-based isolation. 
                                Only users from your organization can access these secrets.
                            </p>
                        </div>
                        
                        <div class="mb-3">
                            <label for="secretName" class="form-label"><strong>Secret Name:</strong> <span class="text-danger">*</span></label>
                            <InputText @bind-Value="createSecretModel.SecretName" class="form-control" id="secretName" 
                                     placeholder="e.g., API-Key, External-Service-Token" />
                            <ValidationMessage For="@(() => createSecretModel.SecretName)" class="text-danger" />
                            <div class="form-text">
                                Use alphanumeric characters and hyphens only. No spaces or special characters.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="secretValue" class="form-label"><strong>Secret Value:</strong> <span class="text-danger">*</span></label>
                            <InputTextArea @bind-Value="createSecretModel.SecretValue" class="form-control font-monospace" id="secretValue" rows="4" 
                                         placeholder="Enter the secret value..." />
                            <ValidationMessage For="@(() => createSecretModel.SecretValue)" class="text-danger" />
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label"><strong>Description:</strong> (Optional)</label>
                            <InputTextArea @bind-Value="createSecretModel.Description" class="form-control" id="description" rows="2" 
                                         placeholder="Describe what this secret is used for..." />
                            <div class="form-text">
                                Help team members understand the purpose of this secret.
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @onclick="CloseCreateSecretModal" disabled="@isCreatingSecret">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-success" disabled="@isCreatingSecret">
                                @if (isCreatingSecret)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Creating...</span>
                                }
                                else
                                {
                                    <i class="fas fa-plus me-1"></i>
                                    <span>Create Secret</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<DatabaseCredential> databaseCredentials = new();
    private IEnumerable<string> secretNames = new List<string>();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = true;
    private Guid currentUserOrgId;
    private UserRole currentUserRole = UserRole.User;

    // Modal state
    private bool showSecretValueModal = false;
    private bool showEditSecretModal = false;
    // private bool showDeleteSecretModal = false; // Removed - delete functionality disabled
    private bool showCreateSecretModal = false;
    private string currentSecretName = string.Empty;
    private string currentSecretValue = string.Empty;
    private bool isUpdatingSecret = false;
    private bool isDeletingSecret = false;
    private bool isCreatingSecret = false;

    // Modal models
    private EditSecretModel editSecretModel = new();
    private CreateSecretModel createSecretModel = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUserRole = DataIsolationService.GetCurrentUserRole();
            
            var currentUserOrgIdStr = await DataIsolationService.GetCurrentUserOrganizationIdAsync();
            if (string.IsNullOrEmpty(currentUserOrgIdStr))
            {
                errorMessage = "Unable to determine your organization. Please contact support.";
                return;
            }

            // Try to parse as GUID, otherwise generate one from the string
            if (!Guid.TryParse(currentUserOrgIdStr, out currentUserOrgId))
            {
                // Generate deterministic GUID from organization ID string
                using (var md5 = System.Security.Cryptography.MD5.Create())
                {
                    var hash = md5.ComputeHash(System.Text.Encoding.UTF8.GetBytes(currentUserOrgIdStr));
                    currentUserOrgId = new Guid(hash);
                }
                Logger.LogInformation("Generated GUID for non-GUID organization ID: {OrgId}", currentUserOrgIdStr);
            }
            await LoadSecrets();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing secrets page");
            errorMessage = "Error loading page. Please refresh and try again.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadSecrets()
    {
        try
        {
            // Load database credentials
            databaseCredentials = await DatabaseCredentialService.GetByOrganizationAsync(currentUserOrgId);
            
            // Load other secret names (only if not Super Admin for compliance)
            if (currentUserRole != UserRole.SuperAdmin)
            {
                secretNames = await KeyVaultService.GetSecretNamesAsync(currentUserOrgId.ToString());
            }
            else
            {
                // Super Admins can see secret names but not values
                secretNames = await KeyVaultService.GetSecretNamesAsync(currentUserOrgId.ToString());
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading secrets for organization {OrganizationId}", currentUserOrgId);
            errorMessage = "Error loading secrets. Please try again.";
        }
    }

    private void ViewCredentialDetails(DatabaseCredential credential)
    {
        Navigation.NavigateTo($"/admin/database-credentials");
    }

    private async Task TestCredentialConnection(Guid credentialId)
    {
        try
        {
            ClearMessages();
            var result = await DatabaseCredentialService.TestConnectionAsync(credentialId);
            
            if (result.Success)
            {
                successMessage = $"Connection test successful! Response time: {result.ResponseTime.TotalMilliseconds:F0}ms";
            }
            else
            {
                errorMessage = $"Connection test failed: {result.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error testing connection for credential {CredentialId}", credentialId);
            errorMessage = "Error testing connection. Please try again.";
        }

        StateHasChanged();
    }

    private void ShowDeleteCredentialModal(DatabaseCredential credential)
    {
        errorMessage = "Delete credential functionality coming soon.";
        StateHasChanged();
    }

    private async Task ViewSecretValue(string secretName)
    {
        if (currentUserRole == UserRole.SuperAdmin)
        {
            errorMessage = "Super Admins cannot view secret values for security and compliance reasons.";
            StateHasChanged();
            return;
        }

        try
        {
            ClearMessages();
            var secretValue = await KeyVaultService.GetSecretAsync(secretName, currentUserOrgId.ToString());
            if (!string.IsNullOrEmpty(secretValue))
            {
                currentSecretName = secretName;
                currentSecretValue = secretValue;
                showSecretValueModal = true;
            }
            else
            {
                errorMessage = $"Failed to retrieve secret '{secretName}'. It may not exist or you may not have permission.";
            }
        }
        catch (UnauthorizedAccessException)
        {
            errorMessage = "You don't have permission to view this secret.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error retrieving secret {SecretName}", secretName);
            errorMessage = "Error retrieving secret. Please try again.";
        }

        StateHasChanged();
    }

    // Delete functionality disabled for security reasons
    // private void ShowDeleteSecretModal(string secretName)
    // {
    //     currentSecretName = secretName;
    //     showDeleteSecretModal = true;
    //     StateHasChanged();
    // }

    // Modal event handlers
    private void HandleBackdropClick()
    {
        // Close any open modal when clicking backdrop
        CloseAllModals();
    }

    private void CloseAllModals()
    {
        showSecretValueModal = false;
        showEditSecretModal = false;
        // showDeleteSecretModal = false; // Disabled
        showCreateSecretModal = false;
        currentSecretName = string.Empty;
        currentSecretValue = string.Empty;
        StateHasChanged();
    }

    // Secret Value Modal Methods
    private void CloseSecretValueModal()
    {
        showSecretValueModal = false;
        currentSecretValue = string.Empty;
        StateHasChanged();
    }

    private void EditSecretValue()
    {
        editSecretModel = new EditSecretModel
        {
            SecretValue = currentSecretValue
        };
        showSecretValueModal = false;
        showEditSecretModal = true;
        StateHasChanged();
    }

    private async Task CopySecretToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", currentSecretValue);
            successMessage = "Secret value copied to clipboard.";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error copying secret to clipboard");
            errorMessage = "Failed to copy to clipboard.";
            StateHasChanged();
        }
    }

    // Edit Secret Modal Methods
    private void CloseEditSecretModal()
    {
        showEditSecretModal = false;
        editSecretModel = new EditSecretModel();
        StateHasChanged();
    }

    private async Task SaveSecretChanges()
    {
        if (isUpdatingSecret) return;

        try
        {
            ClearMessages();
            isUpdatingSecret = true;

            var success = await KeyVaultService.SetSecretAsync(currentSecretName, editSecretModel.SecretValue, currentUserOrgId.ToString());
            
            if (success)
            {
                successMessage = $"Secret '{currentSecretName}' updated successfully.";
                CloseEditSecretModal();
                await LoadSecrets(); // Refresh the list
            }
            else
            {
                errorMessage = "Failed to update secret. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating secret {SecretName}", currentSecretName);
            errorMessage = "An unexpected error occurred while updating the secret.";
        }
        finally
        {
            isUpdatingSecret = false;
            StateHasChanged();
        }
    }

    // Delete Secret Modal Methods
    // Delete functionality disabled for security reasons
    // private void CloseDeleteSecretModal()
    // {
    //     showDeleteSecretModal = false;
    //     StateHasChanged();
    // }

    private async Task DeleteSecretConfirmed()
    {
        if (isDeletingSecret) return;

        try
        {
            ClearMessages();
            isDeletingSecret = true;

            var success = await KeyVaultService.DeleteSecretAsync(currentSecretName, currentUserOrgId.ToString());
            
            if (success)
            {
                successMessage = $"Secret '{currentSecretName}' deleted successfully.";
                // CloseDeleteSecretModal(); // Disabled
                await LoadSecrets(); // Refresh the list
            }
            else
            {
                errorMessage = "Failed to delete secret. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting secret {SecretName}", currentSecretName);
            errorMessage = "An unexpected error occurred while deleting the secret.";
        }
        finally
        {
            isDeletingSecret = false;
            StateHasChanged();
        }
    }

    // Create Secret Modal Methods
    private void ShowCreateSecretModal()
    {
        createSecretModel = new CreateSecretModel();
        showCreateSecretModal = true;
        StateHasChanged();
    }

    private void CloseCreateSecretModal()
    {
        showCreateSecretModal = false;
        createSecretModel = new CreateSecretModel();
        StateHasChanged();
    }

    private async Task CreateNewSecret()
    {
        if (isCreatingSecret) return;

        try
        {
            ClearMessages();
            isCreatingSecret = true;

            var success = await KeyVaultService.SetSecretAsync(createSecretModel.SecretName, createSecretModel.SecretValue, currentUserOrgId.ToString());
            
            if (success)
            {
                successMessage = $"Secret '{createSecretModel.SecretName}' created successfully.";
                CloseCreateSecretModal();
                await LoadSecrets(); // Refresh the list
            }
            else
            {
                errorMessage = "Failed to create secret. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating secret {SecretName}", createSecretModel.SecretName);
            errorMessage = "An unexpected error occurred while creating the secret.";
        }
        finally
        {
            isCreatingSecret = false;
            StateHasChanged();
        }
    }

    private bool IsSystemSecret(string secretName)
    {
        // Filter out system-generated secrets (like SAP passwords)
        return secretName.StartsWith("sap-password-", StringComparison.OrdinalIgnoreCase);
    }

    private void ClearMessages()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    // Model classes for forms
    public class EditSecretModel
    {
        [Required(ErrorMessage = "Secret value is required")]
        [StringLength(4000, ErrorMessage = "Secret value cannot exceed 4000 characters")]
        public string SecretValue { get; set; } = string.Empty;
    }

    public class CreateSecretModel
    {
        [Required(ErrorMessage = "Secret name is required")]
        [StringLength(127, MinimumLength = 1, ErrorMessage = "Secret name must be between 1 and 127 characters")]
        [RegularExpression(@"^[a-zA-Z0-9-]+$", ErrorMessage = "Secret name can only contain letters, numbers, and hyphens")]
        public string SecretName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Secret value is required")]
        [StringLength(4000, ErrorMessage = "Secret value cannot exceed 4000 characters")]
        public string SecretValue { get; set; } = string.Empty;

        [StringLength(500, ErrorMessage = "Description cannot exceed 500 characters")]
        public string Description { get; set; } = string.Empty;
    }
}